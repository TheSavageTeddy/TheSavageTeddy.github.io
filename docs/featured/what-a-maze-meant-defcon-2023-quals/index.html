<!DOCTYPE html>
<html lang="en">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  

  
  
  

  <title>what-a-maze-meant - DEFCON Quals 2023 Writeup :: teddyctf</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="A writeup for a speedpwn challenge in LiveCTF of DEFCON CTF Quals 2023" />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="http://localhost:1313/featured/what-a-maze-meant-defcon-2023-quals/" />


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-J6PB683BSR"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-J6PB683BSR');
        }
      </script>






  
  
  
  
  
  <link rel="stylesheet" href="http://localhost:1313/styles.css">







  <link rel="shortcut icon" href="http://localhost:1313/favicon.ico">



<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="teddyctf" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="what-a-maze-meant - DEFCON Quals 2023 Writeup">
<meta property="og:description" content="A writeup for a speedpwn challenge in LiveCTF of DEFCON CTF Quals 2023" />
<meta property="og:url" content="http://localhost:1313/featured/what-a-maze-meant-defcon-2023-quals/" />
<meta property="og:site_name" content="teddyctf" />

  
  
    
  
  <meta property="og:image" content="http://localhost:1313/featured/what-a-maze-meant-defcon-2023-quals/defcon-quals-scoreboard-2023.png">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">

  <meta property="article:section" content="CTF Writeups" />


  <meta property="article:published_time" content="2023-05-30 02:00:00 &#43;1000 AEST" />












</head>

<body class="green">
  

  <div class="container center headings--one-size">

    <header class="header">
  <div class="header__inner" style="height: 34px;">
    <img src="/images/teddypfp.jpg" style="max-height: 100%; max-width: 100%; display: block;">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    teddy / TheSavageTeddy
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;▾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/contact">Contact</a></li>
        
      
        
          <li><a href="/featured">Featured Posts</a></li>
        
      
        
          <li><a href="/posts">Other Posts</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          
            <li><a href="/about">About</a></li>
          
        
      
        
          
            <li><a href="/contact">Contact</a></li>
          
        
      
        
          
            <li><a href="/featured"><b>Featured Posts</b></a></li>
          
        
      
        
          
            <li><a href="/posts">Other Posts</a></li>
          
        
      
      
    
  </ul>
</nav>

  
</header>


    <div class="content">
      
<article class="post">
  <h1 class="post-title">
    <a href="http://localhost:1313/featured/what-a-maze-meant-defcon-2023-quals/">
  <img src="https://ctftime.org/media/cache/94/e9/94e9dbfeeac979015ff6fc74b5151fd8.png"  class="left"  style="border-radius: 5px; height: auto; width: 3em; display: inline; vertical-align: middle; "  />


 what-a-maze-meant - DEFCON Quals 2023 Writeup</a>
  </h1>
  <div class="post-meta">
    
      <time class="post-date">
        May 30, 2023 :: teddyctf
        
      </time>
    
    
    
  </div>

  
    <span class="post-tags">
      
      #<a href="http://localhost:1313/tags/ctf/">ctf</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/writeup/">writeup</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/speedpwn/">speedpwn</a>&nbsp;
      
    </span>
  
  
  <img src="/featured/what-a-maze-meant-defcon-2023-quals/defcon-quals-scoreboard-2023.png"
    class="post-cover"
    alt=" "
    title="Cover Image" 
    style="border: 1.5px solid #78E2A0; border-radius: 5px; padding: 0px; display:block; margin: auto; max-height: 40em; max-width: auto; " />


  

  <div class="post-content"><div>
        <h1 id="table-of-contents">Table of Contents<a href="#table-of-contents" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p><a href="/featured/what-a-maze-meant-defcon-2023-quals/#overview"><code>Overview</code></a> - a brief summary of the event</p>
<p><a href="/featured/what-a-maze-meant-defcon-2023-quals/#challenge-overview"><code>Writeup</code></a> - writeup of the challenge</p>
<p><a href="/featured/what-a-maze-meant-defcon-2023-quals/#conclusion"><code>Conclusion</code></a> - final closing thoughts</p>
<h1 id="overview">Overview<a href="#overview" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>I played DEFCON Quals 2023 with <a href="https://ctftime.org/team/220769"><code>if this doesn't work we'll get more for next year</code></a>, a merger team with around 10 teams combined. Despite our best efforts, we placed <code>15th</code>, just short of the top 12 that qualified, but given that it was our first year, I think we did pretty well, and I guess we&rsquo;ll need to get more for next year!</p>
<p>In this post is a quick writeup of <code>what-a-maze-meant</code>, the first speedpwn challenge released in the LiveCTF section, where the quickest solves will earn the most points, so speed is key! It was a relatively easy challenge that together with some teamates, I solved pretty quickly. Enjoy!</p>
<h2 id="challenge-overview">Challenge overview<a href="#challenge-overview" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>We are given a binary, where the goal seems to be to complete the maze, by giving directions such as North, South, East and West. <a href="https://dogbolt.org/?id=fda734c4-0d96-48dc-9247-1cafa71dc8bd">Decompiling online</a> we can dive into the code.</p>



  <div class="collapsable-code">
    <input id="1" type="checkbox"  />
    <label for="1">
      <span class="collapsable-code__language">c</span>
      <span class="collapsable-code__title">main()</span>
      <span class="collapsable-code__toggle" data-label-expand="Show" data-label-collapse="Hide"></span>
    </label>
    <pre class="language-c" ><code>
int __cdecl main(int argc, const char **argv, const char **envp)
{
  unsigned int v3; // eax
  char v5; // [rsp&#43;Bh] [rbp-3A5h] BYREF
  int i; // [rsp&#43;Ch] [rbp-3A4h]
  int j; // [rsp&#43;10h] [rbp-3A0h]
  unsigned int v8; // [rsp&#43;14h] [rbp-39Ch]
  unsigned int v9; // [rsp&#43;18h] [rbp-398h]
  int v10; // [rsp&#43;1Ch] [rbp-394h]
  char v11[904]; // [rsp&#43;20h] [rbp-390h] BYREF
  unsigned __int64 v12; // [rsp&#43;3A8h] [rbp-8h]
  __int64 savedregs; // [rsp&#43;3B0h] [rbp&#43;0h] BYREF

  v12 = __readfsqword(0x28u);
  setvbuf(stdin, 0LL, 2, 0LL);
  setvbuf(stdout, 0LL, 2, 0LL);
  v3 = time(0LL);
  srand(v3);
  for ( i = 0; i &lt;= 29; &#43;&#43;i )
  {
    for ( j = 0; j &lt;= 29; &#43;&#43;j )
      *((_BYTE *)&amp;savedregs &#43; 30 * i &#43; j - 912) = 35;
  }
  puts(&#34;Reticulating splines... &#34;);
  generate_maze((__int64)v11, 1, 1, 1);
  puts(&#34;\n\nWelcome to the maze!&#34;);
  v8 = 1;
  v9 = 1;
  v10 = 1;
  while ( 1 )
  {
    if ( show_maze )
      display_maze((__int64)v11, v8, v9);
    printf(&#34;You are in room (%d, %d)\n&#34;, v8, v9);
    if ( v10 )
      randomDescription();
    else
      v10 = 1;
    puts(&#34;Which would you like to do?&#34;);
    if ( validwalk(*((_BYTE *)&amp;savedregs &#43; 30 * (int)(v8 - 1) &#43; (int)v9 - 912)) )
      printf(&#34;go (n)orth, &#34;);
    if ( validwalk(*((_BYTE *)&amp;savedregs &#43; 30 * (int)(v8 &#43; 1) &#43; (int)v9 - 912)) )
      printf(&#34;go (s)outh, &#34;);
    if ( validwalk(*((_BYTE *)&amp;savedregs &#43; 30 * (int)v8 &#43; (int)(v9 - 1) - 912)) )
      printf(&#34;go (w)est, &#34;);
    if ( validwalk(*((_BYTE *)&amp;savedregs &#43; 30 * (int)v8 &#43; (int)(v9 &#43; 1) - 912)) )
      printf(&#34;go (e)ast, &#34;);
    printf(&#34;or (q) end the torment&#34;);
    printf(&#34;: &#34;);
    __isoc99_scanf(&#34; %c&#34;, &amp;v5);
    putchar(10);
    switch ( v5 )
    {
      case &#39;a&#39;:
        puts(&#34;You cast arcane eye and send your summoned magical eye above the maze.&#34;);
        show_maze = 1;
        v10 = 0;
        break;
      case &#39;e&#39;:
        if ( validwalk(*((_BYTE *)&amp;savedregs &#43; 30 * (int)v8 &#43; (int)(v9 &#43; 1) - 912)) )
          &#43;&#43;v9;
        break;
      case &#39;n&#39;:
        if ( validwalk(*((_BYTE *)&amp;savedregs &#43; 30 * (int)(v8 - 1) &#43; (int)v9 - 912)) )
          --v8;
        break;
      case &#39;q&#39;:
        exit(0);
      case &#39;s&#39;:
        if ( validwalk(*((_BYTE *)&amp;savedregs &#43; 30 * (int)(v8 &#43; 1) &#43; (int)v9 - 912)) )
          &#43;&#43;v8;
        break;
      case &#39;w&#39;:
        if ( validwalk(*((_BYTE *)&amp;savedregs &#43; 30 * (int)v8 &#43; (int)(v9 - 1) - 912)) )
          --v9;
        break;
      default:
        break;
    }
    if ( *((_BYTE *)&amp;savedregs &#43; 30 * (int)v8 &#43; (int)v9 - 912) == 42 )
    {
      if ( rand() % 1213 == 1212 )
      {
        puts(&#34;You successfully exit the maze!&#34;);
        winner();
      }
      puts(&#34;Just as you are about to exit, a displacer beast captures you. You die.&#34;);
      exit(0);
    }
  }
}
</code></pre>
  </div>


<p>Running the provided binary and inputting <code>a</code>, we can see the maze layout:</p>

  <img src="./img/mazelayout.png"  class="center"  style="border-radius: 5px;"  />


<p>There are already a lot of scripts online to solve mazes, and since we want to solve this as fast as possible for the most points, we use ChatGPT to generate a script for us:</p>



  <div class="collapsable-code">
    <input id="2" type="checkbox"  />
    <label for="2">
      <span class="collapsable-code__language">python</span>
      <span class="collapsable-code__title">maze_solver.py</span>
      <span class="collapsable-code__toggle" data-label-expand="Show" data-label-collapse="Hide"></span>
    </label>
    <pre class="language-python" ><code>
class MazeSolver:
    def __init__(self, maze):
        self.maze = maze
        self.rows = len(maze)
        self.cols = len(maze[0])
        self.visited = [[False for _ in range(self.cols)] for _ in range(self.rows)]
        self.directions = {&#39;N&#39;: (-1, 0), &#39;S&#39;: (1, 0), &#39;W&#39;: (0, -1), &#39;E&#39;: (0, 1)}
        self.path = []

    def solve(self, start_row, start_col):
        if self._dfs(start_row, start_col):
            return self._get_solution()
        else:
            return []

    def _dfs(self, row, col):
        if not self._is_valid(row, col):
            return False

        self.visited[row][col] = True
        self.path.append((row, col))

        if self.maze[row][col] == &#39;*&#39;:
            return True

        for direction in self.directions.values():
            next_row = row &#43; direction[0]
            next_col = col &#43; direction[1]
            if self._dfs(next_row, next_col):
                return True

        self.path.pop()
        return False

    def _is_valid(self, row, col):
        if row &lt; 0 or row &gt;= self.rows or col &lt; 0 or col &gt;= self.cols:
            return False
        if self.maze[row][col] == &#39;#&#39; or self.visited[row][col]:
            return False
        return True

    def _get_solution(self):
        solution = []
        for i in range(1, len(self.path)):
            prev_row, prev_col = self.path[i-1]
            curr_row, curr_col = self.path[i]
            if curr_row &lt; prev_row:
                solution.append(&#39;n&#39;)
            elif curr_row &gt; prev_row:
                solution.append(&#39;s&#39;)
            elif curr_col &lt; prev_col:
                solution.append(&#39;w&#39;)
            elif curr_col &gt; prev_col:
                solution.append(&#39;e&#39;)
        return solution


maze = [
    &#34;#@#.................#.....#.#&#34;,
    &#34;#.#.#######.#######.#.###.#.#&#34;,
    &#34;#.#.#.#.....#.....#...#...#.#&#34;,
    &#34;#.#.#.#.#######.#.#####.###.#&#34;,
    &#34;#.#...#.#.......#.#...#.....#&#34;,
    &#34;#.#####.#.#####.###.#.#####.#&#34;,
    &#34;#.#...#.#.#.....#...#.......#&#34;,
    &#34;#.#.#.#.#.#######.###########&#34;,
    &#34;#...#...#.#.......#.......#.#&#34;,
    &#34;#########.#.#######.#####.#.#&#34;,
    &#34;#.#.......#...#...#...#...#.#&#34;,
    &#34;#.#.#.#######.#.#.###.#.###.#&#34;,
    &#34;#.#.#.....#...#.#.....#.....#&#34;,
    &#34;#.#.#####.#.###.###########.#&#34;,
    &#34;#.#.....#.#.#...#.#.......#.#&#34;,
    &#34;#.#####.#.#.#.###.#.###.###.#&#34;,
    &#34;#.......#...#...#...#.#...#.#&#34;,
    &#34;#.###########.#.#.###.###.#.#&#34;,
    &#34;#.#.......#...#.#.#.....#...#&#34;,
    &#34;#.#######.#.###.#.#.###.#####&#34;,
    &#34;#.......#.....#.#...#...#...#&#34;,
    &#34;#######.#######.#####.#####.#&#34;,
    &#34;#.....#.....#...#...#.#.....#&#34;,
    &#34;#.###.#####.#.###.###.#.###.#&#34;,
    &#34;#.#.#.....#.#.#.......#.#...#&#34;,
    &#34;#.#.###.###.#.#.#######.#.###&#34;,
    &#34;#.....#.......#.........#...#&#34;,
    &#34;####################*########&#34;
]

solver = MazeSolver(maze)
solution = solver.solve(0, 1)
print(&#34;Instructions to solve the maze:&#34;)
print(solution)

</code></pre>
  </div>


<p>The script outputs the instructions required to solve the maze, starting from <code>@</code> to the goal <code>*</code>. Writing up a quick script in python we can verify this works:</p>



  <div class="collapsable-code">
    <input id="3" type="checkbox"  />
    <label for="3">
      <span class="collapsable-code__language">python</span>
      <span class="collapsable-code__title">solve.py</span>
      <span class="collapsable-code__toggle" data-label-expand="Show" data-label-collapse="Hide"></span>
    </label>
    <pre class="language-python" ><code>
# MazeSolver() here
...
from pwn import *
import time

elf = context.binary = ELF(&#34;./challenge&#34;)
p = process()

p.recvuntil(b&#34;Which would you like to do?&#34;)
p.sendline(b&#34;a&#34;)
p.recvuntil(b&#34;You cast arcane eye and send your summoned magical eye above the maze.&#34;)

maze = p.recvuntil(b&#34;You&#34;, drop=True).decode().split(&#34;\n&#34;)
maze = [i for i in maze if &#34;.&#34; in i or &#34;#&#34; in i] # scuffed method to get maze
maze = maze[1:]

solver = MazeSolver(maze)
solution = solver.solve(0, 1)

for moves in solution:
    p.sendline(moves)

p.interactive()
</code></pre>
  </div>



  <img src="./img/maze_die.png"  class="center"  style="border-radius: 5px;"  />


<p>However, after reaching the goal we seem to just die. Reading the decompiled code further, we see why.</p>
<p>The goal is to call the <code>winner()</code> function, which gives us a shell:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> __noreturn <span style="color:#a6e22e">winner</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Congratulations! You have solved the maze!&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">system</span>(<span style="color:#e6db74">&#34;/bin/sh&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>However, the catch is that apart from solving the maze, we must also pass a random check, and if we don&rsquo;t, we die. So previously, we were dying because <code>rand() % 1213</code> was not equal to <code>1212</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">rand</span>() <span style="color:#f92672">%</span> <span style="color:#ae81ff">1213</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1212</span> )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;You successfully exit the maze!&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">winner</span>();
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Just as you are about to exit, a displacer beast captures you. You die.&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span></code></pre></div><p>Fortunately, the <code>rand()</code> seed is set to the current time with <code>srand()</code> at the start of the program.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  v3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">time</span>(<span style="color:#ae81ff">0LL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">srand</span>(v3);
</span></span></code></pre></div><p>Therefore our method to solve the challenge would be:</p>
<ul>
<li>Figure out how to solve the maze (Done)</li>
<li>Mimic the <code>rand()</code> function in our script by seeding with the same time</li>
<li>Keep track of the number of <code>rand()</code> calls</li>
<li>Find a way to call <code>rand()</code>, and call it additional times until the next call results in <code>rand() % 1213 == 1212</code></li>
</ul>
<p>Doing a search in the decompiled code, we see functions <code>rand_range()</code> and <code>randomDescription()</code> each call <code>rand()</code> once when ran.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">rand_range</span>(<span style="color:#66d9ef">int</span> a1, <span style="color:#66d9ef">int</span> a2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)(<span style="color:#a6e22e">rand</span>() <span style="color:#f92672">%</span> (a2 <span style="color:#f92672">-</span> a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> a1);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> <span style="color:#a6e22e">randomDescription</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  v2[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">&#34;cozy&#34;</span>;
</span></span><span style="display:flex;"><span>  v2[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">&#34;medium-sized&#34;</span>;
</span></span><span style="display:flex;"><span>  v2[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">&#34;spacious&#34;</span>;
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  v0 <span style="color:#f92672">=</span> <span style="color:#a6e22e">rand</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;As you step into the room, you find yourself standing in a %s space. The walls are adorned with %s and a two large %&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;s dominate the center of the room. You see %d flowers in a vase, and through a window you stop to count %d stars. Th&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;e room appears well designed in the %s style.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> v5 <span style="color:#f92672">-</span> <span style="color:#a6e22e">__readfsqword</span>(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>randomDescription()</code> is called every time we move, <strong>even if our move/input is invalid</strong>. This means we can call <code>rand()</code> once ourselves by inputting something that&rsquo;s not a command.</p>
<p>Lets debug with <a href="https://github.com/pwndbg/pwndbg"><code>pwndbg</code></a> to figure out how many times <code>rand()</code> is called when generating the maze.</p>
<p>We start the binary and immediately break with <code>starti</code>, and place a breakpoint after <code>generate_maze()</code>:</p>

  <img src="./img/starti.png"  class="center"  style="border-radius: 5px;"  />


<p><a href=""></a></p>

  <img src="./img/break.png"  class="center"  style="border-radius: 5px;"  />


<p>Then, we set a breakpoint at <code>rand()</code>, and write a simpe python counter to keep track of how many times <code>rand()</code> was called (which was how many times the breakpoint was triggered)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>python
</span></span><span style="display:flex;"><span>counter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">breakpoint_handler</span>(event):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> counter
</span></span><span style="display:flex;"><span>    counter <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;srand called. total times called: </span><span style="color:#e6db74">{</span>counter<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gdb<span style="color:#f92672">.</span>events<span style="color:#f92672">.</span>stop<span style="color:#f92672">.</span>connect(breakpoint_handler)
</span></span><span style="display:flex;"><span>end
</span></span></code></pre></div>
  <img src="./img/gdbpythoncool.png"  class="center"  style="border-radius: 5px;"  />


<p>And we find <code>generate_maze()</code> hits the breakpoint <code>590</code> times (the <code>591</code> in the bottom of image is when it hits the breakpoint after <code>generate_maze()</code> in <code>main()</code>, so doesn&rsquo;t count).</p>
<p>Now that we have the amount of times <code>rand()</code> is called, we can simulate this in python to predict what number the next <code>rand()</code> call will yield.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">from</span> ctypes <span style="color:#f92672">import</span> CDLL
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>libc <span style="color:#f92672">=</span> CDLL(<span style="color:#e6db74">&#34;./libc.so.6&#34;</span>)
</span></span><span style="display:flex;"><span>libc<span style="color:#f92672">.</span>srand(int(time<span style="color:#f92672">.</span>time()))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">callrand</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> libc<span style="color:#f92672">.</span>rand() <span style="color:#f92672">%</span> <span style="color:#ae81ff">1213</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># simulate rand() calls in generate_maze()</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">590</span>):
</span></span><span style="display:flex;"><span>    callrand()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>callrand() <span style="color:#75715e"># the initial random message it sends</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> moves <span style="color:#f92672">in</span> solution:
</span></span><span style="display:flex;"><span>    callrand() <span style="color:#75715e"># simulate rand() call in the random message we get after every input</span>
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(moves)
</span></span></code></pre></div><p>Now, after integrating the random calls into our solve script, we can stop before exiting the maze, keep calling <code>rand()</code> by submitting an invalid input, until the next <code>callrand()</code> we simulate yields <code>1212</code>. When it does, we can finally exit the maze, and <code>winner()</code> should be called, giving us a shell!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>lastmove <span style="color:#f92672">=</span> solution[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> moves <span style="color:#f92672">in</span> solution[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]: <span style="color:#75715e"># do all moves except last</span>
</span></span><span style="display:flex;"><span>    callrand() <span style="color:#75715e"># simulate rand() call in the random message we get after every input</span>
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(moves)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nextrand <span style="color:#f92672">=</span> callrand()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> <span style="color:#f92672">not</span> nextrand <span style="color:#f92672">==</span> <span style="color:#ae81ff">1212</span>:
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;x&#34;</span>) <span style="color:#75715e"># send invalid input to call rand()</span>
</span></span><span style="display:flex;"><span>    nextrand <span style="color:#f92672">=</span> callrand()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(lastmove)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>Final solve script:</p>



  <div class="collapsable-code">
    <input id="4" type="checkbox" checked />
    <label for="4">
      <span class="collapsable-code__language">py</span>
      <span class="collapsable-code__title">solve.py</span>
      <span class="collapsable-code__toggle" data-label-expand="Show" data-label-collapse="Hide"></span>
    </label>
    <pre class="language-py" ><code>
class MazeSolver:
    def __init__(self, maze):
        self.maze = maze
        self.rows = len(maze)
        self.cols = len(maze[0])
        self.visited = [[False for _ in range(self.cols)] for _ in range(self.rows)]
        self.directions = {&#39;N&#39;: (-1, 0), &#39;S&#39;: (1, 0), &#39;W&#39;: (0, -1), &#39;E&#39;: (0, 1)}
        self.path = []

    def solve(self, start_row, start_col):
        if self._dfs(start_row, start_col):
            return self._get_solution()
        else:
            return []

    def _dfs(self, row, col):
        if not self._is_valid(row, col):
            return False

        self.visited[row][col] = True
        self.path.append((row, col))

        if self.maze[row][col] == &#39;*&#39;:
            return True

        for direction in self.directions.values():
            next_row = row &#43; direction[0]
            next_col = col &#43; direction[1]
            if self._dfs(next_row, next_col):
                return True

        self.path.pop()
        return False

    def _is_valid(self, row, col):
        if row &lt; 0 or row &gt;= self.rows or col &lt; 0 or col &gt;= self.cols:
            return False
        if self.maze[row][col] == &#39;#&#39; or self.visited[row][col]:
            return False
        return True

    def _get_solution(self):
        solution = []
        for i in range(1, len(self.path)):
            prev_row, prev_col = self.path[i-1]
            curr_row, curr_col = self.path[i]
            if curr_row &lt; prev_row:
                solution.append(&#39;n&#39;)
            elif curr_row &gt; prev_row:
                solution.append(&#39;s&#39;)
            elif curr_col &lt; prev_col:
                solution.append(&#39;w&#39;)
            elif curr_col &gt; prev_col:
                solution.append(&#39;e&#39;)
        return solution


from pwn import *
from ctypes import CDLL
import time

libc = CDLL(&#34;./libc.so.6&#34;)


def callrand():
    return libc.rand() % 1213

elf = context.binary = ELF(&#34;./challenge&#34;)

# seed with the current time right before starting the program
libc.srand(int(time.time())) 
p = process()

# simulate rand() calls in generate_maze()
for _ in range(590):
    callrand()

callrand() # the initial random message it sends

p.recvuntil(b&#34;Which would you like to do?&#34;)
p.sendline(b&#34;a&#34;)
p.recvuntil(b&#34;You cast arcane eye and send your summoned magical eye above the maze.&#34;)

maze = p.recvuntil(b&#34;You&#34;, drop=True).decode().split(&#34;\n&#34;)
maze = [i for i in maze if &#34;.&#34; in i or &#34;#&#34; in i] # scuffed method to get maze
maze = maze[1:]

solver = MazeSolver(maze)
solution = solver.solve(0, 1)

lastmove = solution[-1]

for moves in solution[:-1]: # do all moves except last
    callrand() # simulate rand() call in the random message we get after every input
    p.sendline(moves)

nextrand = callrand()
while not nextrand == 1212:
    p.sendline(b&#34;x&#34;) # send invalid input to call rand()
    nextrand = callrand()

p.sendline(lastmove)

p.interactive()
</code></pre>
  </div>


<p>Running the final script we indeed get a shell, and solve the challenge!</p>

  <img src="./img/shell.png"  class="center"  style="border-radius: 5px;"  />


<p>To recieve our points, we had to submit a <code>.tar</code> file with a Dockerfile and the solve script, which should run <code>./submitter</code> after getting a shell, and print the flag. However, since I didn&rsquo;t use any <code>p.recv()</code> after sending the moves, the buffer would crash the docker and the submission would fail. Fortunately, one of my teammates <a href="https://github.com/zafirr31">Zafirr</a> submitted with <code>p.sendlineafter()</code> to overcome the issue and we got the points :)</p>
<h1 id="conclusion">Conclusion<a href="#conclusion" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>I would like to thank all my teammates for putting in all their effort playing the CTF, and especially <a href="https://github.com/zafirr31"><code>Zafirr</code></a>, <a href="https://twitter.com/KebabTM"><code>KebabTM</code></a>, <a href="https://eth007.me/blog/"><code>Eth007</code></a>, <a href="https://twitter.com/ainsetin"><code>Ainsetin</code></a> and <code>Goldenboy</code> (sorry if i missed anyone) for helping me figure things out (especially the <code>rand()</code> calls) while I wrote the solve script to solve this challenge!</p>
<p>It was fun playing with a lot of people, and for the second day I met up with some of my teammates to solve more challenges - you can see <a href="https://twitter.com/toasterpwn"><code>toasterpwn</code></a>&rsquo;s writeup on them <a href="https://toasterpwn.github.io/posts/defcon-ctf-2023-qualifiers/">here</a>!</p>
<p>Unfortunately this CTF was right in the middle of my exams so I couldn&rsquo;t dedicate full time to it, but I hope to play with everyone again and hopefully qualify next year! Thanks for reading!</p>
<ul>
<li>teddy / TheSavageTeddy</li>
</ul>

      </div></div>

  
    
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="http://localhost:1313/featured/p4ctf-finals-2023/">
                <span class="button__icon">←</span>
                <span class="button__text">CTF Writeups - p4CTF Finals 2023 in Poland</span>
            </a>
        </span>
        
        
    </div>
</div>

  

  
    

  
</article>

    </div>

    
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span>teddyctf</span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





    
  </div>

</body>

</html>